@using KuyumHesapWeb.Core.Feature.StockFeature.Queries.GetAll
@model List<GetAllStockQueryResponse>
@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stok Tanımlama</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Header ve satır aynı kolon şemasını kullanacak */
        .stok-grid {
            display: grid;
            grid-template-columns: 1fr 90px 110px 110px 90px 110px;
            /*  Ad | Birim | İşçilik | Milyem | Durum | İşlem  */
            align-items: center;
            column-gap: 16px;
        }

            .stok-grid > * {
                min-width: 0;
            }
        /* text ellipsis için */

        .stok-name {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .stok-sub {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .fx-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            white-space: nowrap;
        }
    </style>
    <style>
        /* Satır ve başlık aynı grid yapısını paylaşsın */
        .fx-stock-grid {
            display: grid;
            grid-template-columns: 1fr 90px 90px 110px; /* Tip/Grup | Birim | Durum | İşlem */
            align-items: center;
            column-gap: 16px;
        }

        .fx-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            white-space: nowrap;
        }

        .form-group .form-label {
            position: absolute;
            top: 0.5rem;
            left: 0.6rem;
            color: #6b7280;
            pointer-events: none;
            transition: all 0.2s ease-in-out;
            background-color: white;
            padding: 0 0.25rem;
            font-size: 0.875rem;
        }

        .form-group .form-input:focus + .form-label,
        .form-group .form-input:not(:placeholder-shown) + .form-label,
        .form-group .form-input.has-value + .form-label {
            top: -0.6rem;
            left: 0.5rem;
            font-size: 0.75rem;
            color: #1f2937;
        }

        .form-input:required:invalid {
            color: #6b7280;
        }
    </style>
</head>
<body class="bg-gray-100 p-3 overflow-hidden">

    <div class="flex flex-col md:flex-row gap-4 w-full h-[calc(100vh-1.5rem)]">


        <!-- SAĞ TARAF: LİSTE PANELİ -->
        <div class="flex flex-col flex-[2]">
            <div class="panel bg-white rounded-lg shadow-sm border border-rolex-green p-3 flex flex-col flex-grow min-h-0">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="text-lg font-semibold text-gray-800 flex-shrink-0">Stok Listesi</h2>
                    <div class="flex items-center gap-2">
                        <div class="relative">
                            <a asp-controller="Stock" asp-action="Create" class="px-6 py-1.5 bg-success text-white text-sm font-semibold rounded-md hover:bg-opacity-90 shadow-sm">EKLE</a>
                        </div>
                        <input type="text" id="listSearchInput" placeholder="Stok Adı Ara..." class="form-input text-xs w-28 p-1.5 border border-rolex-green rounded-md shadow-sm focus:border-rolex-green focus:ring-rolex-green focus:ring-opacity-50">
                        <select id="grupFilterSelect" class="form-input text-xs w-28 p-1.5 border border-rolex-green rounded-md shadow-sm focus:border-rolex-green focus:ring-rolex-green focus:ring-opacity-50">
                            <option value="">Tüm Gruplar</option>
                        </select>
                        <select id="tipFilterSelect" class="form-input text-xs w-28 p-1.5 border border-rolex-green rounded-md shadow-sm focus:border-rolex-green focus:ring-rolex-green focus:ring-opacity-50">
                            <option value="">Tüm Tipler</option>
                        </select>
                    </div>
                </div>
                <div class="flex-grow overflow-y-auto">
                    <div class="stok-grid text-xs font-semibold text-gray-500 px-2 py-2 border-b sticky top-0 bg-white z-10">
                        <span>Stok Adı</span>
                        <span class="text-center">Birim</span>
                        <span class="text-center">İşçilik</span>
                        <span class="text-center">Milyem</span>
                        <span class="text-center">Durum</span>
                        <span class="text-right">İşlem</span>
                    </div>
                    <div id="item-list" class="space-y-1">
                        @foreach (var item in Model)
                        {
                            <div class="stok-grid p-2 rounded cursor-pointer hover:bg-gray-200 bg-white" data-id="@item.Id">
                                <div class="min-w-0">
                                    <div class="stok-name font-medium text-gray-700 text-sm">@item.StockName</div>
                                    <div class="stok-sub text-xs text-gray-500">
                                        @item?.stockTypeResponseDto?.StockTypeName / @item?.groupResponseDto?.StockGroupName
                                    </div>
                                </div>

                                <div class="text-center text-xs font-semibold text-rolex-green">@item.UnitName</div>

                                <div class="text-center text-xs text-gray-600">
                                    @item?.stockTypeResponseDto?.currencyResponseDto?.CurrencyName
                                </div>

                                <div class="text-center text-xs text-gray-600">
                                    @item.MillRate.ToString("N3")
                                </div>

                                <div class="flex justify-center">
                                    <div class="w-9 h-5 @(item.IsActive ? "bg-rolex-green" : "bg-gray-300") rounded-full relative transition-colors">
                                        <div class="w-4 h-4 bg-white rounded-full absolute top-[2px] @(item.IsActive ? "right-[2px]" : "left-[2px]") transition-all"></div>
                                    </div>
                                </div>

                                <div class="fx-actions">
                                    <a href="/Stock/Update/@item.Id"
                                       class="w-8 h-8 inline-flex items-center justify-center rounded-md border border-gray-300 bg-white hover:bg-gray-50 text-gray-700 shadow-sm"
                                       title="Güncelle">
                                        <i class="fas fa-pen text-xs"></i>
                                    </a>

                                    <button type="button"
                                            class="w-8 h-8 inline-flex items-center justify-center rounded-md border border-red-200 bg-red-50 hover:bg-red-100 text-red-700 shadow-sm"
                                            title="Sil"
                                            data-id="@item.Id">
                                        <i class="fas fa-trash text-xs"></i>
                                    </button>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>



    <div id="toast-container" class="fixed bottom-4 right-4 z-50"></div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {

            const token = localStorage.getItem('jwt_token');
            const loginUrl = '@Url.Action("Login", "Auth")';
            const API_BASE_URL = '@ViewBag.ApiBaseUrl/api/stoklar';
            const STOKTIP_API_URL = '@ViewBag.ApiBaseUrl/api/stoktipleri';
            const STOKGRUP_API_URL = '@ViewBag.ApiBaseUrl/api/stokgrubu';
            const DOVIZ_API_URL = '@ViewBag.ApiBaseUrl/api/dovizler';
            let currentMode = 'add';
            let itemToDeleteId = null;
            let allItems = [];
            let stokTipleri = [];
            let stokGruplari = [];

            // Form ve liste elemanları
            const itemListEl = document.getElementById('item-list');
            const form = document.getElementById('item-form');
            const addModeButtons = document.getElementById('add-mode-buttons');
            const editModeButtons = document.getElementById('edit-mode-buttons');
            const toastContainer = document.getElementById('toast-container');
            const deleteButton = document.getElementById('sil-btn');

            // Filtre elemanları
            const listSearchInput = document.getElementById('listSearchInput');
            const grupFilterSelect = document.getElementById('grupFilterSelect');
            const tipFilterSelect = document.getElementById('tipFilterSelect');

            // Modal elemanları
            const deleteModal = document.getElementById('delete-modal');
            const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
            const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
            const modalItemName = document.getElementById('modal-item-name');

            // Form inputları
            const stokIDInput = document.getElementById('stokID');
            const stokAdiInput = document.getElementById('stokAdi');
            const stokTipIDSelect = document.getElementById('stokTipID');
            const grupAdiInput = document.getElementById('grupAdi');
            const grupIDInput = document.getElementById('grupID');
            const birimSelect = document.getElementById('birim');
            const stokBirimiAdiInput = document.getElementById('stokBirimiAdi');
            const stokBirimiInput = document.getElementById('stokBirimi');
            const iscilikBirimiSelect = document.getElementById('iscilikBirimi');
            const milyemInput = document.getElementById('milyem');
            const aktifInput = document.getElementById('aktif');

            const getAuthHeaders = () => ({ 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` });

            const showToast = (message, type = 'success') => {
                const toast = document.createElement('div');
                toast.className = `p-3 rounded-md text-white text-sm shadow-lg animate-fade-in-out ${type === 'success' ? 'bg-rolex-green' : 'bg-danger'}`;
                toast.textContent = message;
                toastContainer.appendChild(toast);
                setTimeout(() => toast.remove(), 4000);
            };

            const populateSelect = async (selectElement, url, valueField, textField, placeholder) => {
                 try {
                    const response = await fetch(url, { headers: getAuthHeaders() });
                    if (!response.ok) throw new Error(`${placeholder} yüklenemedi.`);
                    const data = await response.json();

                    selectElement.innerHTML = `<option value="" disabled selected>${placeholder}</option>`;
                    data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item[valueField];
                        option.textContent = item[textField];
                        if (item.stokGrupID) option.dataset.grupId = item.stokGrupID;
                        if (item.stokGrupAdi) option.dataset.grupAdi = item.stokGrupAdi;
                        if (item.dovizID) option.dataset.dovizId = item.dovizID;
                        if (item.dovizKodu) option.dataset.dovizKodu = item.dovizKodu;
                        selectElement.appendChild(option);
                    });
                    return data;
                } catch (error) {
                    showToast(error.message, 'danger');
                    selectElement.innerHTML = `<option value="" disabled selected>${error.message}</option>`;
                    return [];
                }
            };

            const applyFiltersAndRender = () => {
                const searchTerm = listSearchInput.value.toLowerCase();
                const selectedGrup = grupFilterSelect.value;
                const selectedTip = tipFilterSelect.value;

                let filteredItems = allItems;

                if (searchTerm) {
                    filteredItems = filteredItems.filter(item => item.stokAdi.toLowerCase().includes(searchTerm));
                }
                if (selectedGrup) {
                    filteredItems = filteredItems.filter(item => item.stokGrupAdi === selectedGrup);
                }
                if (selectedTip) {
                    filteredItems = filteredItems.filter(item => item.stokTipAdi === selectedTip);
                }
                renderItemList(filteredItems);
            };

            const updateDependentFields = (stokTipId) => {
                const selectedStokTip = stokTipleri.find(st => st.stokTipID == stokTipId);
                if (selectedStokTip) {
                    grupIDInput.value = selectedStokTip.stokGrupID || '';
                    grupAdiInput.value = selectedStokTip.stokGrupAdi || '';
                    stokBirimiInput.value = selectedStokTip.dovizID || '';
                    stokBirimiAdiInput.value = selectedStokTip.dovizKodu || '';
                } else {
                    grupIDInput.value = '';
                    grupAdiInput.value = '';
                    stokBirimiInput.value = '';
                    stokBirimiAdiInput.value = '';
                }

                [grupAdiInput, stokBirimiAdiInput].forEach(input => {
                    input.dispatchEvent(new Event('input'));
                    input.classList.toggle('has-value', !!input.value);
                });
            };

            stokTipIDSelect.addEventListener('change', (e) => {
                updateDependentFields(e.target.value);
            });

            const fetchItems = async () => {
                try {
                    const response = await fetch(API_BASE_URL, { headers: getAuthHeaders() });
                    if (response.status === 401) return window.top.location.href = loginUrl;
                    if (!response.ok) throw new Error(await response.text() || 'Veriler alınamadı.');
                    allItems = await response.json();
                    applyFiltersAndRender();
                } catch (error) {
                    showToast(error.message, 'danger');
                }
            };

            const renderItemList = (items) => {
                itemListEl.innerHTML = !items || items.length === 0
                    ? '<p class="text-center text-gray-500 p-4">Kayıt bulunamadı.</p>'
                    : items.map((item, index) => {
                        const formattedMilyem = item.milyem.toLocaleString('tr-TR', { minimumFractionDigits: 3, maximumFractionDigits: 3 });
                        return `
                        <div class="p-2 rounded cursor-pointer hover:bg-gray-200 ${index % 2 !== 0 ? 'bg-list-item-bg' : 'bg-white'} flex justify-between items-center" data-id="${item.stokID}">
                            <div>
                                <span class="font-medium text-gray-700 text-sm">${item.stokAdi}</span>
                                <p class="text-xs text-gray-500">${item.stokTipAdi || '...'} / ${item.stokGrupAdi || '...'}</p>
                            </div>
                            <div class="flex items-center gap-x-6 text-center text-xs">
                                <span class="font-semibold text-rolex-green w-10">${item.birim}</span>
                                <span class="text-gray-600 w-12">${item.iscilikBirimiKodu || 'N/A'}</span>
                                <span class="text-gray-600 w-12">${formattedMilyem}</span>
                                <div class="w-8 flex justify-center">
                                    <div class="w-9 h-5 ${item.aktif ? 'bg-rolex-green' : 'bg-gray-300'} rounded-full relative transition-colors">
                                        <div class="w-4 h-4 bg-white rounded-full absolute top-[2px] ${item.aktif ? 'right-[2px]' : 'left-[2px]'} transition-all"></div>
                                    </div>
                                </div>
                            </div>
                        </div>`
                    }).join('');
            };

            itemListEl.addEventListener('click', (e) => {
                 const itemElement = e.target.closest('[data-id]');
                 if (itemElement) handleItemSelect(itemElement.dataset.id);
            });

            const handleItemSelect = async (id) => {
                try {
                    const response = await fetch(`${API_BASE_URL}/${id}`, { headers: getAuthHeaders() });
                    if (!response.ok) throw new Error('Detay alınamadı.');
                    populateForm(await response.json());
                } catch (error) {
                    showToast(error.message, 'danger');
                }
            };

            const populateForm = (item) => {
                form.reset();
                stokIDInput.value = item.stokID;
                stokAdiInput.value = item.stokAdi;
                stokTipIDSelect.value = item.stokTipID;
                birimSelect.value = item.birim;
                iscilikBirimiSelect.value = item.iscilikBirimi;
                milyemInput.value = item.milyem.toLocaleString('tr-TR', { minimumFractionDigits: 3, maximumFractionDigits: 3 });
                aktifInput.checked = item.aktif;

                updateDependentFields(item.stokTipID);

                const allInputs = [stokAdiInput, stokTipIDSelect, birimSelect, iscilikBirimiSelect, milyemInput, grupAdiInput, stokBirimiAdiInput];
                allInputs.forEach(input => {
                     input.dispatchEvent(new Event('input'));
                     input.classList.toggle('has-value', !!input.value);
                });

                setMode('edit');
            };

            const resetForm = () => {
                form.reset();
                stokIDInput.value = '';
                aktifInput.checked = true;
                const allInputs = form.querySelectorAll('.form-input, .form-select');
                allInputs.forEach(input => {
                    input.classList.remove('has-value');
                    input.dispatchEvent(new Event('input'));
                });
                setMode('add');
            };

            const setMode = (mode) => {
                currentMode = mode;
                addModeButtons.classList.toggle('hidden', mode === 'edit');
                editModeButtons.classList.toggle('hidden', mode === 'add');
            };

            form.addEventListener('submit', async (e) => {
                e.preventDefault();

                const payload = {
                    stokID: stokIDInput.value ? parseInt(stokIDInput.value) : 0,
                    stokAdi: stokAdiInput.value,
                    stokTipID: parseInt(stokTipIDSelect.value),
                    grupID: parseInt(grupIDInput.value),
                    birim: birimSelect.value,
                    stokBirimi: parseInt(stokBirimiInput.value),
                    iscilikBirimi: parseInt(iscilikBirimiSelect.value),
                    milyem: parseFloat(milyemInput.value.replace('.', '').replace(',', '.')),
                    aktif: aktifInput.checked,
                };

                const method = currentMode === 'add' ? 'POST' : 'PUT';
                const url = currentMode === 'add' ? API_BASE_URL : `${API_BASE_URL}/${payload.stokID}`;

                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: getAuthHeaders(),
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(await response.text() || 'İşlem başarısız.');

                    showToast(`Stok başarıyla ${currentMode === 'add' ? 'eklendi' : 'güncellendi'}.`);
                    await fetchItems();
                    resetForm();
                } catch (error) {
                    showToast(error.message, 'danger');
                }
            });

            const showDeleteModal = (id, name) => {
                itemToDeleteId = id;
                modalItemName.textContent = `'${name}'`;
                deleteModal.classList.remove('hidden');
                setTimeout(() => deleteModal.querySelector('div').classList.remove('scale-95'), 10);
            };

            const hideDeleteModal = () => {
                deleteModal.querySelector('div').classList.add('scale-95');
                setTimeout(() => deleteModal.classList.add('hidden'), 300);
            };

            deleteButton.addEventListener('click', () => {
                 if (stokIDInput.value) showDeleteModal(stokIDInput.value, stokAdiInput.value);
            });

            cancelDeleteBtn.addEventListener('click', hideDeleteModal);

            confirmDeleteBtn.addEventListener('click', async () => {
                if (!itemToDeleteId) return;
                try {
                    const response = await fetch(`${API_BASE_URL}/${itemToDeleteId}`, { method: 'DELETE', headers: getAuthHeaders() });
                    if (!response.ok) throw new Error('Silme işlemi başarısız.');

                    showToast('Kayıt başarıyla silindi.');
                    await fetchItems();
                    resetForm();
                } catch (error) {
                    showToast(error.message, 'danger');
                } finally {
                    hideDeleteModal();
                }
            });

            document.getElementById('vazgec-btn').addEventListener('click', resetForm);
            document.getElementById('vazgec-guncelle-btn').addEventListener('click', resetForm);

            // Initial data load
            listSearchInput.addEventListener('input', applyFiltersAndRender);

            const populateAndSetupFilters = async () => {
                stokTipleri = await populateSelect(stokTipIDSelect, STOKTIP_API_URL, 'stokTipID', 'stokTipAdi', 'Stok Tipi Seçiniz');

                try {
                    const grupResponse = await fetch(STOKGRUP_API_URL, { headers: getAuthHeaders() });
                    if (!grupResponse.ok) throw new Error('Stok grupları yüklenemedi.');
                    stokGruplari = await grupResponse.json();

                    grupFilterSelect.innerHTML = '<option value="">Tüm Gruplar</option>';
                    stokGruplari.forEach(grup => {
                        const option = document.createElement('option');
                        option.value = grup.stokGrupAdi;
                        option.textContent = grup.stokGrupAdi;
                        grupFilterSelect.appendChild(option);
                    });
                } catch(error) { showToast(error.message, 'danger'); }

                tipFilterSelect.innerHTML = '<option value="">Tüm Tipler</option>';
                stokTipleri.forEach(tip => {
                    const option = document.createElement('option');
                    option.value = tip.stokTipAdi;
                    option.textContent = tip.stokTipAdi;
                    tipFilterSelect.appendChild(option);
                });
            };

            grupFilterSelect.addEventListener('change', () => {
                const selectedGrupAdi = grupFilterSelect.value;
                const currentTipValue = tipFilterSelect.value;
                tipFilterSelect.innerHTML = '<option value="">Tüm Tipler</option>';

                let typesToShow = stokTipleri;
                if(selectedGrupAdi) {
                    const selectedGrup = stokGruplari.find(g => g.stokGrupAdi === selectedGrupAdi);
                    if (selectedGrup) {
                       typesToShow = stokTipleri.filter(tip => tip.stokGrupID === selectedGrup.id);
                    }
                }

                typesToShow.forEach(tip => {
                    const option = document.createElement('option');
                    option.value = tip.stokTipAdi;
                    option.textContent = tip.stokTipAdi;
                    tipFilterSelect.appendChild(option);
                });

                if (typesToShow.some(tip => tip.stokTipAdi === currentTipValue)) {
                    tipFilterSelect.value = currentTipValue;
                }

                applyFiltersAndRender();
            });

            tipFilterSelect.addEventListener('change', applyFiltersAndRender);

            await populateAndSetupFilters();
            await populateSelect(iscilikBirimiSelect, DOVIZ_API_URL, 'id', 'dovizKodu', 'İşçilik Birimi Seçiniz');
            await fetchItems();
            resetForm();
        });
    </script>
</body>
</html>



