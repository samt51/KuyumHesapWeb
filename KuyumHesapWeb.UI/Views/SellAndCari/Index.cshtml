@using KuyumHesapWeb.Core.Commond.Models.Dtos
@model GetAllAccountResponseDto
@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<!DOCTYPE html>
<html lang="tr">
<head>

    @section Styles {
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/slim-select/2.8.2/slimselect.min.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/slim-select/2.8.2/slimselect.min.js"></script>
        <style>


            .ekstre-list-container {
                display: flex;
                flex-direction: column;
                gap: 8px;
            }

            .ekstre-item.selected-ekstre-row {
                background-color: #e0f2fe; /* light blue */
                border-color: #0ea5e9;
                box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.4);
            }
            /* YENİ: Floating Label Stilleri */
            .float-label-container {
                position: relative;
                margin-top: 1.5rem; /* Etiketin yukarı kayması için yer aç */
            }

            .float-label-input {
                width: 100%;
                padding: 0.75rem 0.75rem 0.25rem 0.75rem; /* Üst padding etikete yer açar */
                border: 1px solid #d1d5db; /* Tailwind border-gray-300 */
                border-radius: 0.375rem; /* Tailwind rounded-md */
                font-size: 0.875rem; /* Tailwind text-sm */
                height: 38px; /* Diğer inputlarla aynı yükseklik */
                transition: border-color 0.2s ease-in-out;
                background-color: white;
                padding-top: 0.15rem; /* Üst padding'i biraz artırarak metni aşağı itin */
                padding-bottom: 0rem; /* Alt padding'i azaltın */
                line-height: 1.25; /* Satır yüksekliğini ayarlayın (gerekirse) */
            }
            /* Select için özel padding ayarı */
            .float-label-select {
                padding-top: 0.15rem; /* Üst padding'i artır */
                padding-bottom: 0rem; /* Alt padding'i azalt */
            }

            .float-label-input.pt-4 { /* textarea için kullandığımız sınıf */
                padding-top: 1.25rem !important; /* Etikete daha fazla yer aç */
            }

            .float-label {
                position: absolute;
                top: 0.65rem; /* Inputun ortasına yakın */
                left: 0.75rem;
                font-size: 0.875rem; /* Tailwind text-sm */
                color: #6b7280; /* Tailwind text-gray-500 */
                pointer-events: none; /* Üzerine tıklanınca input'a odaklanılsın */
                transition: all 0.2s ease-in-out;
                background-color: white; /* Arkasındaki çizgiyi silmek için */
                padding: 0 0.25rem; /* Kenarlara hafif boşluk */
            }
            /* Textarea Stilleri (Otomatik Genişleyen ve Şık Görünümlü) */
            textarea.float-label-input {
                /* Temel Görünüm ve Floating Label Uyumu */
                padding-top: 1.25rem; /* Floating label için yer */
                padding-bottom: 0.25rem;
                line-height: 1.5; /* Satır yüksekliği - içeriğe göre ayarlanabilir */
                min-height: calc(1.5em * 2 + 1.5rem); /* Yaklaşık 3 satır + padding için min yükseklik */
                height: auto; /* Başlangıçta yüksekliği içeriğe göre ayarla */
                /* Otomatik Genişleme ve Kaydırma */
                overflow-y: hidden; /* Dikey kaydırma çubuğunu HER ZAMAN gizle */
                resize: none; /* Yeniden boyutlandırma tutamacını kaldır */
                /* Tarayıcı varsayılan görünümünü sıfırlama (isteğe bağlı) */
                appearance: none;
                -webkit-appearance: none;
                -moz-appearance: none;
                background-clip: padding-box; /* Border'ın içeriğin üzerine binmesini engelle */
            }

                /* İnce Kaydırma Çubuğu (Gerekirse diye, ama overflow:hidden ile gizlenmeli) */
                textarea.float-label-input::-webkit-scrollbar {
                    display: none; /* Webkit'te tamamen gizle */
                }

            textarea.float-label-input {
                scrollbar-width: none; /* Firefox'ta tamamen gizle */
            }
            /* Input focus olduğunda veya içinde değer olduğunda label'ı yukarı taşı */
            .float-label-input:focus + .float-label,
            .float-label-input:not(:placeholder-shown) + .float-label,
            .float-label-container.select-has-value .float-label { /* Select için özel durum */
                top: -0.6rem; /* Inputun üstüne taşı */
                left: 0.5rem;
                font-size: 0.75rem; /* Tailwind text-xs */
                color: #3b82f6; /* Tailwind text-blue-600 */
            }
            /* Focus olduğunda border rengini değiştir */
            .float-label-input:focus {
                outline: none;
                border-color: #3b82f6; /* Tailwind focus:border-blue-500 */
                box-shadow: 0 0 0 1px #3b82f6; /* Tailwind focus:ring-1 focus:ring-blue-500 */
            }
            /* Readonly inputlar için farklı stil */
            .float-label-input[readonly] {
                background-color: #f3f4f6; /* Tailwind bg-gray-100 */
                cursor: not-allowed;
            }

            .ekstre-item {
                display: flex;
                align-items: center;
                padding: 12px 16px;
                background-color: #fff;
                border-radius: 8px;
                border: 1px solid #e5e7eb;
                border-left-width: 5px;
                transition: box-shadow 0.2s ease-in-out;
            }

                .ekstre-item:hover {
                    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
                }

            .ekstre-item-giris {
                border-left-color: #22c55e; /* green-500 */
            }

            .ekstre-item-cikis {
                border-left-color: #ef4444; /* red-500 */
            }

            .ekstre-sol {
                flex-grow: 1;
                display: flex;
                flex-direction: column;
                align-items: flex-start;
            }

                .ekstre-sol .baslik {
                    font-weight: 600;
                    font-size: 0.9rem;
                }

                .ekstre-sol .tarih {
                    font-size: 0.75rem;
                    color: #6b7280;
                    margin-top: 2px;
                }

            .ekstre-orta {
                display: flex;
                align-items: center;
                gap: 20px; /* Gruplar arası boşluk */
                font-family: 'Roboto Mono', monospace;
                margin: 0 24px;
            }

            .ekstre-detay-grup {
                display: flex;
                flex-direction: column;
            }

            .ekstre-sag {
                display: flex;
                align-items: center;
                font-family: 'Roboto Mono', monospace;
                margin-left: auto;
            }

            .bakiye-grup {
                display: flex;
                flex-direction: column;
                text-align: right;
                margin-right: 16px;
            }

                .bakiye-grup .eski-bakiye {
                    font-size: 0.7rem;
                    color: #6b7280;
                }

                .bakiye-grup .son-bakiye {
                    font-size: 0.8rem;
                    font-weight: 700;
                    color: #1f2937;
                }

            .hareket-id {
                font-size: 0.7rem;
                color: #9ca3af;
                margin-bottom: 2px;
            }

            .mutabakat-switch {
                position: relative;
                display: inline-block;
                width: 34px;
                height: 20px;
            }

                .mutabakat-switch input {
                    opacity: 0;
                    width: 0;
                    height: 0;
                }

            .mutabakat-slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #ccc;
                transition: .4s;
                border-radius: 20px;
            }

                .mutabakat-slider:before {
                    position: absolute;
                    content: "";
                    height: 14px;
                    width: 14px;
                    left: 3px;
                    bottom: 3px;
                    background-color: white;
                    transition: .4s;
                    border-radius: 50%;
                }

            input:checked + .mutabakat-slider {
                background-color: #3B82F6;
            }

                input:checked + .mutabakat-slider:before {
                    transform: translateX(14px);
                }

            body {
                font-family: 'Inter', sans-serif;
                background-color: #f7f8fc;
                transition: background-color 0.4s ease;
                min-height: 100vh;
                overflow: auto;
                display: flex;
                flex-direction: column;
            }

            #receipt-log, #receipt-totals {
                font-family: 'Roboto Mono', monospace;
            }

            .custom-scrollbar::-webkit-scrollbar {
                width: 5px;
            }

            .custom-scrollbar::-webkit-scrollbar-track {
                background: #f1f1f1;
            }

            .custom-scrollbar::-webkit-scrollbar-thumb {
                background: #d1d5db;
                border-radius: 10px;
            }

                .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                    background: #9ca3af;
                }

            .theme-border {
                border: 1px solid;
                transition: border-color 0.4s ease, border-top-width 0.3s ease, border-top-color 0.3s ease;
            }

            .theme-border-50 {
                border: 1px solid;
                transition: border-color 0.4s ease;
            }

            .theme-icon-color {
                transition: color 0.4s ease;
            }

            .modal-bg {
                background-color: rgba(0,0,0,0.5);
                transition: opacity 0.3s ease;
            }

            #fis-list-modal.hidden .modal-bg {
                opacity: 0;
            }

            #fis-list-modal .modal-content {
                transition: transform 0.3s ease;
                transform: translateX(100%);
            }

            #fis-list-modal:not(.hidden) .modal-content {
                transform: translateX(0);
            }

            #fis-list-table tbody tr:hover {
                background-color: #f9fafb;
            }

            #fis-list-table tbody tr.selected-row {
                background-color: #eff6ff;
                --tw-ring-color: #3b82f6;
                --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
                --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
                box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
            }

            body.satis-active .theme-border {
                border-color: rgba(30, 132, 73, 0.35);
            }

            body.satis-active .theme-border-50 {
                border-color: rgba(30, 132, 73, 0.5);
            }

            body.satis-active .theme-icon-color.income {
                color: #16a34a;
            }

            body.satis-active .theme-icon-color.expense {
                color: #dc2626;
            }

            .account-type-btn {
                transition: background-color 0.2s ease, color 0.2s ease;
                border: 1px solid #d1d5db;
            }

            .active-account-type-btn {
                background-color: #3b82f6;
                color: white;
                border-color: #3b82f6;
                font-weight: 600;
            }

            body.cari-active .theme-border {
                border-color: rgba(59, 130, 246, 0.4);
            }

            body.cari-active .theme-border-50 {
                border-color: rgba(59, 130, 246, 0.55);
            }

            body.cari-active .theme-icon-color.income {
                color: #16a34a;
            }

            body.cari-active .theme-icon-color.expense {
                color: #dc2626;
            }
            /* YENİ: 3'lü Nakit Hesap Tipi Toggle Stilleri */
            .tri-toggle-container {
                position: relative;
                display: inline-block; /* Veya inline-flex */
                width: 100%; /* Form içinde tam genişlik */
                /* max-width: 240px; İsterseniz maksimum genişlik verebilirsiniz */
                height: 38px;
                background-color: #e5e7eb; /* Tailwind bg-gray-200 */
                border-radius: 8px; /* Tailwind rounded-lg */
                padding: 3px;
                box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
            }

            .tri-toggle-slider { /* Kayacak olan beyaz kısım */
                position: absolute;
                height: 32px; /* Konteyner yüksekliği - (padding * 2) */
                width: calc((100% - 6px) / 3); /* 3 seçenek var, padding'i hesaba kat */
                top: 3px;
                left: 3px;
                background-color: white;
                border-radius: 6px; /* Konteyner border-radius'undan biraz küçük */
                transition: transform 0.4s ease; /* Yumuşak geçiş animasyonu */
                box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06); /* Tailwind shadow */
                z-index: 1;
            }

            .tri-toggle-options {
                display: flex;
                height: 100%;
                position: relative;
                z-index: 2; /* Yazılar slider'ın üzerinde olmalı */
            }

            .tri-toggle-option {
                flex: 1; /* Seçenekler eşit genişlikte */
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                font-size: 13px;
                font-weight: 600; /* Tailwind font-semibold */
                color: #6b7280; /* Pasif yazı rengi - Tailwind text-gray-500 */
                user-select: none;
                transition: color 0.4s ease; /* Yazı rengi geçişi */
            }

            #acikhesap-tipi-toggle[data-selected="borcuna"] .tri-toggle-slider {
                transform: translateX(0%);
            }

            #acikhesap-tipi-toggle[data-selected="alacagina"] .tri-toggle-slider {
                transform: translateX(100%);
            }

            #ceviri-tipi-toggle[data-selected="borcundaki"] .tri-toggle-slider {
                transform: translateX(0%);
            }

            #ceviri-tipi-toggle[data-selected="alacagindaki"] .tri-toggle-slider {
                transform: translateX(100%);
            }
            /* Aktif seçeneğin yazı rengi */
            .tri-toggle-option.active {
                color: #3b82f6; /* Aktif yazı rengi - Tailwind text-blue-600 */
            }

            /* Slider'ın pozisyonunu data attribute'una göre ayarla */
            /* ÖNEMLİ: Buradaki değerler ('KASALAR', 'BANKALAR', 'POSLAR') JavaScript'teki accountTypes.value ile eşleşmeli */
            .tri-toggle-container[data-selected="KASALAR"] .tri-toggle-slider {
                transform: translateX(0%);
            }

            .tri-toggle-container[data-selected="BANKALAR"] .tri-toggle-slider {
                transform: translateX(100%);
            }

            .tri-toggle-container[data-selected="POSLAR"] .tri-toggle-slider {
                transform: translateX(200%);
            }

            .toggle-container {
                position: relative;
                display: inline-block;
                width: 110px;
                height: 38px;
            }

            .toggle-checkbox {
                opacity: 0;
                width: 0;
                height: 0;
            }

            .toggle-label {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                border-radius: 8px;
                transition: background-color 0.4s, opacity 0.4s;
                display: flex;
                align-items: center;
                color: white;
                font-weight: bold;
                font-size: 13px;
                user-select: none;
            }

                .toggle-label::before {
                    content: '';
                    position: absolute;
                    height: 32px;
                    width: 52px;
                    left: 3px;
                    top: 3px;
                    background-color: white;
                    border-radius: 6px;
                    transition: transform 0.4s ease;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                    z-index: 1;
                }

            .toggle-text {
                flex: 1;
                text-align: center;
                position: relative;
                z-index: 2;
                transition: color 0.4s ease, opacity 0.4s ease;
            }

            body.satis-active .toggle-label {
                background-color: #1E8449;
            }

            body.satis-active .toggle-text:first-child {
                color: #1E8449;
                opacity: 1;
            }

            body.satis-active .toggle-text:last-child {
                color: #FFFFFF;
                opacity: 0.5;
            }

            body.cari-active .toggle-label {
                background-color: #3B82F6;
            }

            body.cari-active .toggle-text:first-child {
                color: #FFFFFF;
                opacity: 0.5;
            }

            body.cari-active .toggle-text:last-child {
                color: #3B82F6;
                opacity: 1;
            }

            .toggle-checkbox:checked + .toggle-label::before {
                transform: translateX(52px);
            }

            .toggle-checkbox:disabled + .toggle-label {
                opacity: 0.6;
                cursor: not-allowed;
            }

            .karsilik-toggle-container {
                position: relative;
                display: inline-block;
                width: 44px;
                height: 24px;
            }

            .karsilik-toggle {
                opacity: 0;
                width: 0;
                height: 0;
            }

            .karsilik-toggle-label {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #ccc;
                transition: .4s;
                border-radius: 24px;
            }

                .karsilik-toggle-label:before {
                    position: absolute;
                    content: "";
                    height: 18px;
                    width: 18px;
                    left: 3px;
                    bottom: 3px;
                    background-color: white;
                    transition: .4s;
                    border-radius: 50%;
                }

            .karsilik-toggle:checked + .karsilik-toggle-label {
                background-color: #3B82F6;
            }

                .karsilik-toggle:checked + .karsilik-toggle-label:before {
                    transform: translateX(20px);
                }

            .ss-main .ss-single-selected, .ss-main .ss-multi-selected {
                height: 38px;
                padding: 6px 10px;
                font-size: 0.875rem;
                border-color: #d1d5db;
            }

            .receipt-item.selected-item-income {
                background-color: #f0fdf4;
                border-color: #22c55e;
            }

            .receipt-item.selected-item-expense {
                background-color: #fef2f2;
                border-color: #ef4444;
            }

            .receipt-item.income-border {
                border: 1px solid #dcfce7;
            }

            .receipt-item.expense-border {
                border: 1px solid #fee2e2;
            }

            button:disabled {
                cursor: not-allowed;
                background-color: #e5e7eb !important;
                opacity: 0.7;
            }
            /* Üçlü anahtarın genel kapsayıcısı */
            .toggle-group {
                position: relative;
                display: flex;
                background-color: #e5e7eb; /* Tailwind gray-200 */
                border-radius: 0.5rem; /* Tailwind rounded-lg */
                padding: 0.25rem; /* Tailwind p-1 */
                width: 100%;
                box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
            }

            /* Seçimi gösteren hareketli arkaplan */
            .toggle-slider {
                position: absolute;
                top: 0.25rem;
                left: 0.25rem;
                width: calc((100% - 0.5rem) / 3);
                height: calc(100% - 0.5rem);
                background-color: white;
                border-radius: 0.375rem; /* Tailwind rounded-md */
                box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                z-index: 1;
            }

            /* Görünmez radio butonlar */
            .toggle-radio {
                display: none;
            }

            /* Tıklanabilir metin etiketleri */
            .toggle-label {
                flex: 1;
                text-align: center;
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
                font-weight: 600;
                font-size: 0.875rem; /* Tailwind text-sm */
                color: #4b5563; /* Tailwind gray-600 */
                cursor: pointer;
                z-index: 2;
                transition: color 0.3s ease;
                user-select: none;
            }

            #virman-tipi-toggle[data-selected="giris"] .tri-toggle-slider,
            #virman-tipi-toggle[data-selected="borcuna"] .tri-toggle-slider {
                transform: translateX(0%);
            }

            #virman-tipi-toggle[data-selected="cikis"] .tri-toggle-slider,
            #virman-tipi-toggle[data-selected="alacagina"] .tri-toggle-slider {
                transform: translateX(100%);
            }

            #iskonto-tipi-toggle[data-selected="borcuna"] .tri-toggle-slider {
                transform: translateX(0%);
            }

            #iskonto-tipi-toggle[data-selected="alacagina"] .tri-toggle-slider {
                transform: translateX(100%);
            }
            /* Seçili radio butona göre kaydırıcıyı hareket ettir ve metin rengini değiştir */
            #toggle-radio-kasa:checked ~ .toggle-slider {
                transform: translateX(0%);
            }

            #toggle-radio-kasa:checked ~ .toggle-label[for="toggle-radio-kasa"] {
                color: #1f2937; /* Tailwind gray-800 */
            }

            #toggle-radio-banka:checked ~ .toggle-slider {
                transform: translateX(100%);
            }

            #toggle-radio-banka:checked ~ .toggle-label[for="toggle-radio-banka"] {
                color: #1f2937;
            }

            #toggle-radio-pos:checked ~ .toggle-slider {
                transform: translateX(200%);
            }

            #toggle-radio-pos:checked ~ .toggle-label[for="toggle-radio-pos"] {
                color: #1f2937;
            }

            .hat-green {
                border-top-width: 4px;
                border-top-color: #22c55e !important;
            }

            .hat-red {
                border-top-width: 4px;
                border-top-color: #ef4444 !important;
            }

            .rolex-green-border {
                border: 1px solid #006039;
            }

            .toggle-btn-active {
                background-color: #3B82F6;
                color: white;
                font-weight: 600;
            }

            .toggle-btn-inactive {
                background-color: transparent;
                color: #3B82F6;
            }

            .ekstre-list-container {
                display: flex;
                flex-direction: column;
                gap: 0.25rem;
            }

            .ekstre-item {
                background-color: white;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                padding: 0.5rem 1rem;
                display: flex;
                align-items: center;
                gap: 0.75rem;
                box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
                min-height: 64px;
                cursor: pointer;
                transition: background-color 0.2s, border-color 0.2s, box-shadow 0.2s;
            }

                .ekstre-item.selected-ekstre-row {
                    background-color: #e0f2fe; /* light blue */
                    border-color: #0ea5e9;
                    box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.4);
                }

            .ekstre-item-giris {
                border-left-width: 4px;
                border-left-color: #4ade80; /* yeşil */
            }

            .ekstre-item-cikis {
                border-left-width: 4px;
                border-left-color: #f87171; /* kırmızı */
            }

            .ekstre-blok-sag {
                display: flex;
                align-items: center;
                gap: 1rem;
                flex-shrink: 0;
                margin-left: auto; /* Sağa yaslamak için */
            }

                .ekstre-blok-sag .bakiye-grup {
                    display: flex;
                    flex-direction: column;
                    text-align: right;
                    font-family: 'Roboto Mono', monospace;
                    font-size: 0.75rem;
                    min-width: 140px
                }

                    .ekstre-blok-sag .bakiye-grup .eski-bakiye {
                        white-space: nowrap;
                        color: #6b7280;
                    }

                    .ekstre-blok-sag .bakiye-grup .son-bakiye {
                        white-space: nowrap;
                        color: #1f2937;
                        font-weight: 700;
                    }

                .ekstre-blok-sag .hareket-id {
                    font-size: 0.65rem;
                    font-family: 'Roboto Mono', monospace;
                    color: #9ca3af;
                    text-align: center;
                    margin-bottom: 2px;
                }

            .mutabakat-switch {
                position: relative;
                display: inline-block;
                width: 40px;
                height: 22px;
            }

                .mutabakat-switch input {
                    opacity: 0;
                    width: 0;
                    height: 0;
                }

            .mutabakat-slider {
                position: absolute;
                cursor: pointer;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: #ccc;
                transition: .4s;
                border-radius: 22px;
            }

                .mutabakat-slider:before {
                    position: absolute;
                    content: "";
                    height: 16px;
                    width: 16px;
                    left: 3px;
                    bottom: 3px;
                    background-color: white;
                    transition: .4s;
                    border-radius: 50%;
                }

            input:checked + .mutabakat-slider {
                background-color: #22c55e;
            }

                input:checked + .mutabakat-slider:before {
                    transform: translateX(18px);
                }

            .ekstre-modal-header {
                background: linear-gradient(to right, #f8f9fa, #e9ecef);
                border-bottom: 1px solid #dee2e6;
            }

            .ekstre-info-card {
                background-color: #ffffff;
                border: 1px solid #e5e7eb;
                border-radius: 0.75rem;
                padding: 1.75rem 1rem 1rem 1rem;
                box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
                position: relative;
            }

            .card-title-absolute {
                position: absolute;
                top: -0.7rem;
                left: 0.75rem;
                background-color: #ffffff;
                padding: 0 0.5rem;
                font-size: 0.8rem;
                font-weight: 600;
                color: #4b5563;
                display: flex;
                align-items: center;
            }

                .card-title-absolute i {
                    margin-right: 0.5rem;
                    color: #9ca3af;
                }
            /* Bakiye satırlarının altına %10 opaklıkta bir çizgi ekler */
            .bakiye-item {
                border-bottom: 1px solid rgba(0, 0, 0, 0.07);
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
            }

                /* Son satırın altındaki çizgiyi kaldırır */
                .bakiye-item:last-child {
                    border-bottom: none;
                }

            /* Rakam ve durumu içeren sağ taraf kabı */
            .bakiye-item-sag {
                display: flex;
                align-items: baseline;
                justify-content: flex-end;
            }

            /* Rakamları sağa yaslar ve okunaklı olması için sabit bir minimum genişlik verir */
            .bakiye-tutar-rakam {
                min-width: 90px;
                text-align: right;
                font-weight: 700; /* Rakamları kalın yapar */
            }

            /* Durum yazısını (ALACAKLI/BORÇLU) sola yaslar ve rakamdan biraz ayırır */
            .bakiye-tutar-durum {
                min-width: 75px;
                text-align: left;
                margin-left: 0.75rem;
                font-size: 0.75rem;
                font-weight: 600;
            }

                /* ===== YENİ EKLENDİ: Renklendirme ===== */
                /* Yeşil Renk (Alacaklı) */
                .bakiye-tutar-rakam.alacak,
                .bakiye-tutar-durum.alacak {
                    color: #16a34a; /* Tailwind Green-600 */
                }

                /* Kırmızı Renk (Borçlu) */
                .bakiye-tutar-rakam.borc,
                .bakiye-tutar-durum.borc {
                    color: #dc2626; /* Tailwind Red-600 */
                }

            #ekstre-bakiye-ozeti {
                max-height: 116px;
                overflow-y: auto;
            }

            .ekstre-bakiye-ozeti-v2 .bakiye-item {
                display: flex;
                justify-content: space-between;
                font-family: 'Roboto Mono', monospace;
                font-size: 0.8rem;
                padding: 0.25rem 0;
                height: 29px;
            }

                .ekstre-bakiye-ozeti-v2 .bakiye-item .birim {
                    font-weight: 600;
                    color: #4b5563;
                }

                .ekstre-bakiye-ozeti-v2 .bakiye-item .tutar.alacak {
                    color: #16a34a;
                    font-weight: 700;
                }

                .ekstre-bakiye-ozeti-v2 .bakiye-item .tutar.borc {
                    color: #dc2626;
                    font-weight: 700;
                }

            /* ===== YENİ EKSTRE SATIR TASARIMI (v3) ===== */
            .ekstre-v3-sol {
                display: flex;
                flex-direction: column;
                flex-shrink: 0;
                width: 110px;
                justify-content: center;
            }

                .ekstre-v3-sol .baslik {
                    font-size: 0.8rem;
                    font-weight: 700;
                    line-height: 1.2;
                }

                .ekstre-v3-sol .tarih {
                    font-size: 0.7rem;
                    color: #6b7280;
                }

            .ekstre-v3-orta {
                display: flex;
                flex-grow: 1;
                gap: 1.5rem;
                align-items: center;
                font-family: 'Roboto Mono', monospace;
            }

            .ekstre-v3-detay-grup {
                display: flex;
                flex-direction: column;
            }
            /* customer alanı kesin büyüsün */
            .app-shell-customer {
                display: flex;
                flex: 1 1 auto;
                min-width: 0;
            }

                .app-shell-customer .ss-main {
                    width: 100% !important;
                    flex: 1 1 auto !important;
                    min-width: 0 !important;
                }



            /* main ve grid alanı gerçekten ekran yüksekliğine otursun */
            main {
                flex: 1 1 auto;
                min-height: 0; /* önemli */
                overflow: hidden; /* içeride paneller scroll alsın */
            }



            /* sol kolon (fiş) zinciri küçülebilsin */
            .lg\:col-span-4 {
                min-height: 0;
            }

            #receipt-card {
                min-height: 0;
                height: 100%;
            }

            /* scroll alanı */
            #receipt-log {
                min-height: 0;
                overflow-y: auto;
            }

            /* Tri toggle slider tıklamayı engellemesin */
            .tri-toggle-container .tri-toggle-slider {
                pointer-events: none !important;
            }

            /* Optionlar tıklanabilir olsun */
            .tri-toggle-container .tri-toggle-option {
                pointer-events: auto !important;
                cursor: pointer;
                user-select: none;
            }

            html, body {
                height: 100% !important;
                margin: 0 !important;
                overflow: hidden !important; /* sayfanın kendisi scroll olmasın */
            }

            body {
                display: flex !important;
                flex-direction: column !important;
                min-height: 0 !important;
                height: 100vh !important;
            }

            /* main alanı ekranı doldursun */
            main {
                flex: 1 1 auto !important;
                min-height: 0 !important;
                height: auto !important;
                overflow: hidden !important;
            }

            /* grid ve kolonlar küçülebilsin (scroll için şart) */
            #receiptForm,
            #receiptForm > .grid,
            .lg\:col-span-4,
            #middle-panel,
            .lg\:col-span-3 {
                min-height: 0 !important;
            }

            /* fiş kartı ve log kesin scroll alsın */
            #receipt-card {
                height: 100% !important;
                min-height: 0 !important;
            }

            #receipt-log {
                min-height: 0 !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
            }


            /* ====== FIX: Layout + viewport yüksekliği uyumu ====== */
            html, body {
                height: 100%;
            }

            body {
                margin: 0; /* üst boşlukların büyük kısmı buradan da gelebiliyor */
                min-height: 100vh;
                overflow: hidden; /* sayfa değil, içeride paneller scroll alsın */
            }

            /* Ana içerik: header + main flex */
            header {
                flex: 0 0 auto;
            }

            #app-main {
                flex: 1 1 auto;
                min-height: 0; /* scroll için kritik */
                overflow: hidden; /* desktop'ta içeride scroll */
            }

            /* Desktop: 3 kolon yükseklik düzgün dağılsın */
            #app-grid {
                height: 100%;
                min-height: 0;
            }

            #receipt-card,
            #middle-panel,
            #right-panel {
                min-height: 0;
            }

            /* Sol fiş: log alanı kesin scroll alsın */
            #receipt-log {
                min-height: 0 !important;
                overflow-y: auto !important;
            }

            /* Orta panel: dinamik alan scroll */
            #dynamic-content-area {
                min-height: 0 !important;
                overflow-y: auto !important;
            }

            /* ====== MOBİL RESPONSIVE ====== */
            @@media (max-width: 1024px) {
                /* Mobilde sayfanın kendisi scroll alsın ki aşağı inebilesin */
                body {
                    overflow: auto;
                }


                #app-main {
                    overflow: visible; /* mobilde main içerik akışa bırak */
                }
                /* Grid'i mobilde column gibi davranacak şekilde güçlendir */
                #app-grid {
                    height: auto;
                }
                /* Kartların hepsi auto büyüsün */
                #receipt-card,
                #middle-panel,
                #right-panel {
                    height: auto !important;
                }
                /* Sol fiş kartı: ekranda çok yer kaplamasın, içeride scroll olsun */
                #receipt-card {
                    max-height: 55vh;
                }
                /* Orta panel de çok uzamasın */
                #middle-panel {
                    max-height: 55vh;
                }
                /* Sağ panel (butonlar): ekranın altında her zaman görünür olsun */
                #right-panel {
                    position: sticky;
                    bottom: 0;
                    z-index: 20;
                    background: transparent;
                }
                    /* Sağ panel içindeki ilk kutu (aksiyon butonları) scroll alabilsin */
                    #right-panel > .bg-white.rounded-xl.shadow-md.p-3.theme-border {
                        max-height: 42vh;
                        overflow-y: auto;
                    }
                    /* Sağ paneldeki Kaydet/Yeni İşlem kutusu sticky gibi dursun */
                    #right-panel > .bg-white.rounded-xl.shadow-md.p-3.flex-grow.flex.flex-col.theme-border {
                        position: sticky;
                        bottom: 0;
                        z-index: 25;
                        background: white;
                    }
            }

            /* ====== Ek küçük düzeltme: Tailwind p-2 yüzünden taşma olmasın ====== */

            @@media (max-width: 640px) {
                body {
                    padding: 8px !important;
                }
            }

            .app-shell-customer .ss-main,
            .salesperson-wrap .ss-main {
                max-width: 100% !important;
            }

            /* Bu sayfada grid gerçekten yüksekliği doldursun */
            #app-main {
                height: 100%;
                min-height: 0;
            }

            #receiptForm {
                height: 100%;
                min-height: 0;
            }

            /* Sağ panel çok uzarsa desktop'ta içi scroll alsın (opsiyonel ama iyi) */
            @@media (min-width: 1024px) {
                #right-panel {
                    min-height: 0;
                }
            }

            @@media (min-width: 1024px) {
                #right-panel {
                    overflow-y: auto;
                }
            }

            html, body {
                height: 100%;
            }

            @@media (max-width: 1023px) {
                body {
                    overflow: auto !important;
                }
            }

            /* Scrollbar görünümü (seninki) */
            .custom-scrollbar::-webkit-scrollbar {
                width: 5px;
            }

            .custom-scrollbar::-webkit-scrollbar-track {
                background: #f1f1f1;
            }

            .custom-scrollbar::-webkit-scrollbar-thumb {
                background: #d1d5db;
                border-radius: 10px;
            }

                .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                    background: #9ca3af;
                }

            html, body {
                height: 100%;
                margin: 0;
            }

            /* DESKTOP: body scroll yok, paneller scroll alır */
            body {
                display: flex;
                flex-direction: column;
                min-height: 0;
                height: 100dvh; /* mobil adres bar fix */
                overflow: hidden; /* desktop'ta sayfa scroll yok */
                font-family: 'Inter',sans-serif;
                background-color: #f7f8fc;
            }

            header {
                flex: 0 0 auto;
            }

            #app-main {
                flex: 1 1 auto;
                min-height: 0;
                overflow: hidden; /* içeride panel scroll */
                padding-top: .75rem; /* pt-3 */
            }

            #receiptForm {
                height: 100%;
                min-height: 0;
                display: flex;
                flex-direction: column;
            }

            #app-grid {
                flex: 1 1 auto;
                height: 100%;
                min-height: 0;
            }

            /* Sol fiş kartı */
            #receipt-card {
                min-height: 0;
                height: 100%;
            }

            #receipt-log {
                min-height: 0 !important;
                overflow-y: auto !important;
                overflow-x: hidden !important;
                -webkit-overflow-scrolling: touch;
            }

            /* Sağ panel: üst aksiyon scroll + alt footer sabit */
            #right-panel {
                display: flex;
                flex-direction: column;
                min-height: 0;
                height: 100%;
            }

            #right-actions {
                flex: 1 1 auto;
                min-height: 0;
                overflow-y: auto;
                overflow-x: hidden;
                padding-bottom: calc(24px + env(safe-area-inset-bottom)); /* en alt buton kesilmesin */
                -webkit-overflow-scrolling: touch;
            }

            #right-footer {
                flex: 0 0 auto;
                background: white;
            }

            /* Mobil: body scroll serbest, right-panel sticky yok */
            @@media (max-width:1023px) {
                body {
                    height: auto;
                    min-height: 100dvh;
                    overflow: auto; /* mobilde sayfa scroll */
                    padding: 8px; /* senin p-2 */
                }

                #app-main {
                    overflow: visible;
                }

                #receiptForm, #app-grid {
                    height: auto;
                }

                #receipt-card {
                    height: auto;
                    max-height: 55vh;
                }

                #right-panel {
                    height: auto;
                }

                #right-actions {
                    max-height: 45vh; /* mobilde aksiyonlar alanı scroll */
                    overflow-y: auto;
                }

                #right-footer {
                    position: static;
                }
            }

            /* Tri toggle slider tıklamayı engellemesin (senin fix) */
            .tri-toggle-container .tri-toggle-slider {
                pointer-events: none !important;
            }

            .tri-toggle-container .tri-toggle-option {
                pointer-events: auto !important;
                cursor: pointer;
                user-select: none;
            }

        </style>
    }

</head>
<div data-server-page="true" class="hidden"></div>
<body class="text-gray-800 p-2">

    <!-- HEADER SABİT -->
    <header class="bg-white p-3 rounded-xl shadow-sm theme-border">
        <div class="flex flex-col gap-3 lg:flex-row lg:items-center lg:gap-3">

            <!-- SOL BLOK -->
            <div class="flex items-center gap-3 flex-wrap lg:flex-nowrap lg:flex-1 min-w-0">

                <div class="toggle-container flex-shrink-0">
                    <input type="checkbox" id="operation-type-toggle" class="toggle-checkbox">
                    <label for="operation-type-toggle" class="toggle-label">
                        <span class="toggle-text">SATIŞ</span>
                        <span class="toggle-text">CARİ</span>
                    </label>
                </div>

                <select id="currency-select" name="currency-select"
                        class="flex-shrink-0 w-[92px] sm:w-auto bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-1.5 h-[38px]">
                    @foreach (var item in Model.getAllCurrencyQueryResponses)
                    {
                        <option value="@item.Id">@item.CurrencyCode</option>
                    }
                </select>

                <div class="app-shell-customer flex-1 min-w-0 w-full sm:w-auto">
                    <select id="customer-select" asp-for="createReceiptCommandRequest.CurrentAccountId" name="customer-select" class="w-full">
                        @foreach (var item in Model.getAllAccountQueryResponses.Where(x => !x.Tezgahtar))
                        {
                            <option value="@item.AccountId">@item.AccountName</option>
                        }
                    </select>
                </div>
            </div>

            <!-- SAĞ BLOK -->
            <div class="flex items-center gap-2 flex-wrap lg:flex-nowrap lg:flex-shrink-0 lg:justify-end w-full lg:w-auto min-w-0">

                <button class="h-[38px] bg-white hover:bg-gray-100 text-gray-800 font-semibold px-3 border border-gray-300 rounded-lg shadow-sm text-xs flex items-center whitespace-nowrap">
                    <i class="fas fa-users mr-1.5"></i>CRM
                </button>

                <button id="ekstre-button" class="h-[38px] bg-white hover:bg-gray-100 text-gray-800 font-semibold px-3 border border-gray-300 rounded-lg shadow-sm text-xs flex items-center whitespace-nowrap">
                    <i class="fas fa-file-invoice mr-1.5"></i>Ekstre
                </button>

                <button id="sales-list-button" class="h-[38px] bg-white hover:bg-gray-100 text-gray-800 font-semibold px-3 border border-gray-300 rounded-lg shadow-sm text-xs flex items-center whitespace-nowrap">
                    <i class="fas fa-list mr-1.5"></i>Satış Listesi
                </button>

                <div class="salesperson-wrap flex items-center flex-shrink-0 w-full sm:w-[220px] min-w-0">
                    <select id="salesperson-select" name="salesperson-select" class="w-full">
                        @foreach (var item in Model.getAllAccountQueryResponses.Where(x => x.AccountTypeId == 13))
                        {
                            <option value="@item.AccountId">@item.AccountName</option>
                        }
                    </select>
                </div>

            </div>

        </div>
    </header>

    <!-- MAIN ESNEK, İÇERİDE SCROLL KONTROLLÜ -->
    <main id="app-main" class="flex-1 min-h-0 overflow-hidden">
        <form id="receiptForm" asp-controller="Receipt" asp-action="Create" method="post" class="h-full min-h-0 flex flex-col">
            <div id="app-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-4 min-h-0 lg:h-full">

                <!-- SOL: RECEIPT -->
                <div class="flex flex-col gap-3 h-full min-h-0">
                    <div id="receipt-card" class="bg-white rounded-xl shadow-sm flex flex-col theme-border h-full overflow-hidden min-h-0">

                        <div class="p-3 border-b border-gray-200 flex-shrink-0">
                            <div class="flex flex-col gap-2 sm:flex-row sm:justify-between sm:items-center">
                                <h5 id="receipt-title" class="text-lg font-bold text-gray-700">Satış Fişi</h5>
                                <input type="datetime-local" id="fis-tarihi"
                                       class="text-sm bg-transparent text-gray-600 border-none focus:ring-0 p-0 w-full sm:w-auto">
                            </div>
                        </div>

                        <!-- SCROLL -->
                        <div id="receipt-log" class="flex-1 p-3 custom-scrollbar min-h-0 overflow-y-auto overflow-x-hidden"></div>

                        <div id="receipt-totals" class="p-3 border-t border-gray-200 flex-shrink-0">
                            <div id="satis-totals" class="space-y-1">
                                <div class="flex justify-between items-center text-xs">
                                    <strong class="font-medium text-gray-600">Giren Toplam:</strong>
                                    <span id="giren-toplam" class="font-bold text-green-600">
                                        <span id="giren-toplam-amount">0,00</span>
                                        <span id="giren-toplam-currency">TRY</span>
                                    </span>
                                </div>

                                <div class="flex justify-between items-center text-xs">
                                    <strong class="font-medium text-gray-600">Çıkan Toplam:</strong>
                                    <span id="cikan-toplam" class="font-bold text-red-600">
                                        <span id="cikan-toplam-amount">0,00</span>
                                        <span id="cikan-toplam-currency">TRY</span>
                                    </span>
                                </div>

                                <hr class="my-1">

                                <div class="flex justify-between items-center text-sm">
                                    <strong class="font-semibold text-gray-800">Fark:</strong>
                                    <span id="fark-toplam" class="font-extrabold text-blue-700">
                                        <span id="fark-amount">0,00</span>
                                        <span id="fark-currency">TRY</span>
                                    </span>
                                </div>
                            </div>

                            <div id="cari-totals" class="hidden"></div>
                        </div>

                    </div>
                </div>

                <!-- SAĞ PANEL -->
                <div id="right-panel" class="h-full min-h-0 flex flex-col gap-4">

                    <!-- AKSİYONLAR: SCROLL ALANI -->
                    <div id="right-actions" class="bg-white rounded-xl shadow-sm p-3 theme-border custom-scrollbar pr-2">
                        <div class="grid grid-cols-2 gap-2">
                            <button type="button" id="btn-nakit-tahsilat" class="action-btn flex flex-col items-center justify-center p-3 bg-white hover:bg-gray-50 rounded-lg theme-border-50">
                                <i id="icon-nakit-tahsilat" class="fas fa-hand-holding-dollar text-xl mb-1 theme-icon-color income" style="transform: scaleX(-1);"></i>
                                <span id="label-nakit-tahsilat" class="block text-xs font-semibold"></span>
                            </button>

                            <button type="button" id="btn-nakit-odeme" class="action-btn flex flex-col items-center justify-center p-3 bg-white hover:bg-gray-50 rounded-lg theme-border-50">
                                <i id="icon-nakit-odeme" class="fas fa-hand-holding-dollar text-xl mb-1 theme-icon-color expense"></i>
                                <span id="label-nakit-odeme" class="block text-xs font-semibold"></span>
                            </button>

                            <button type="button" id="btn-urun-alis" class="action-btn flex flex-col items-center justify-center p-3 bg-white hover:bg-gray-50 rounded-lg theme-border-50">
                                <i id="icon-urun-alis" class="fas fa-gem text-xl mb-1 theme-icon-color income"></i>
                                <span id="label-urun-alis" class="block text-xs font-semibold"></span>
                            </button>

                            <button type="button" id="btn-urun-satis" class="action-btn flex flex-col items-center justify-center p-3 bg-white hover:bg-gray-50 rounded-lg theme-border-50">
                                <i id="icon-urun-satis" class="fas fa-tag text-xl mb-1 theme-icon-color expense"></i>
                                <span id="label-urun-satis" class="block text-xs font-semibold"></span>
                            </button>

                            <button type="button" id="btn-iskonto" class="action-btn flex flex-col items-center justify-center p-3 bg-white hover:bg-gray-50 rounded-lg theme-border-50">
                                <i class="fas fa-percent text-xl mb-1 theme-icon-color expense"></i>
                                <span class="block text-xs font-semibold">İskonto</span>
                            </button>

                            <button type="button" id="btn-virman" class="action-btn flex flex-col items-center justify-center p-3 bg-white hover:bg-gray-50 rounded-lg theme-border-50">
                                <i class="fas fa-exchange-alt text-xl mb-1 theme-icon-color income"></i>
                                <span class="block text-xs font-semibold">Virman</span>
                            </button>

                            <button type="button" id="btn-acik-hesap" class="action-btn flex flex-col items-center justify-center p-3 bg-white hover:bg-gray-50 rounded-lg theme-border-50">
                                <i class="fas fa-book-open text-xl mb-1 theme-icon-color income"></i>
                                <span class="block text-xs font-semibold">Açık Hesap</span>
                            </button>

                            <button type="button" id="btn-ceviri" class="action-btn flex flex-col items-center justify-center p-3 bg-white hover:bg-gray-50 rounded-lg theme-border-50">
                                <i class="fas fa-random text-xl mb-1 theme-icon-color income"></i>
                                <span class="block text-xs font-semibold">Çeviri</span>
                            </button>
                        </div>

                        <!-- altta kesilmesin -->
                        <div class="h-6"></div>

                        <input type="hidden" name="MovementsJson" id="MovementsJson" />
                        <input type="hidden" name="ReceiptDate" id="hdn-ReceiptDate" />
                        <input type="hidden" name="CurrentAccountId" id="hdn-CurrentAccountId" />
                        <input type="hidden" name="EmployeeId" id="hdn-EmployeeId" />
                        <input type="hidden" name="IsCustomerReceipt" id="hdn-IsCustomerReceipt" />

                        <!-- Eğer bunları da ileride dolduracaksan -->
                        <input type="hidden" name="CurrencyCode" id="hdn-CurrencyCode" />
                        <input type="hidden" name="Description" id="hdn-Description" />
                        <input type="hidden" name="OpenBalanceAmount" id="hdn-OpenBalanceAmount" />
                        <input type="hidden" name="ReceiptNumber" id="hdn-ReceiptNumber" />
                    </div>

                    <!-- ALT BAR -->
                    <div id="right-footer" class="bg-white rounded-xl shadow-sm p-3 theme-border flex-shrink-0">
                        <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                            <button type="submit" id="btnSave"
                                    class="bg-green-200 hover:bg-green-300 text-green-800 font-semibold py-2 px-4 rounded-lg transition-colors border border-green-300 text-sm">
                                <i class="fas fa-save mr-2"></i>Kaydet
                            </button>

                            <button type="button" id="main-reset-button"
                                    class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-colors border border-gray-300 text-sm">
                                <i class="fas fa-sync-alt mr-2"></i>Yeni İşlem
                            </button>

                            <button id="main-delete-button"
                                    class="bg-red-200 hover:bg-red-300 text-red-800 font-semibold py-2 px-4 rounded-lg transition-colors border border-red-300 text-sm hidden sm:block">
                                <i class="fas fa-trash mr-2"></i>Sil
                            </button>
                        </div>

                        <button id="main-delete-button-mobile"
                                class="bg-red-200 hover:bg-red-300 text-red-800 font-semibold py-2 px-4 rounded-lg transition-colors border border-red-300 text-sm mt-2 w-full hidden sm:hidden">
                            <i class="fas fa-trash mr-2"></i>Sil
                        </button>
                    </div>

                </div>

            </div>
        </form>
    </main>
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 pt-10">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm rolex-green-border">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Uyarı</h3>
            <p id="modal-message" class="text-sm text-gray-600 mb-6"></p>
            <div class="flex justify-end gap-3">
                <button id="modal-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg text-sm">Vazgeç</button>
                <button id="modal-confirm" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">Devam Et</button>
            </div>
        </div>
    </div>
    <div id="error-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 pt-10">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm rolex-green-border">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Uyarı</h3>
            <p id="error-modal-message" class="text-sm text-gray-600 mb-6"></p>
            <div class="flex justify-end gap-3">
                <button id="error-modal-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg text-sm">Vazgeç</button>

            </div>
        </div>
    </div>
    <div id="toast-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-[60] pt-20">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm rolex-green-border transform transition-all duration-300 scale-95 opacity-0">
            <h3 class="text-lg font-bold mb-4">Uyarı</h3>
            <p class="text-sm text-gray-600 mb-6"></p>
            <div class="flex justify-end">
                <button class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">Tamam</button>
            </div>
        </div>
    </div>
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
        <div class="text-white text-center">
            <i class="fas fa-spinner fa-spin text-4xl mb-3"></i>
            <p class="text-lg font-semibold">Lütfen Bekleyiniz...</p>
        </div>
    </div>


    <template id="product-form-template">
        <h1 id="product-form-title" class="text-xl font-bold text-gray-800 mb-4">Ürün Giriş</h1>

        <div class="space-y-4">
            <div class="space-y-2">
                <input type="text" id="stokHiyerarsi" class="w-full p-2 bg-gray-100 border border-gray-200 rounded-md text-gray-600 text-sm mb-2" placeholder="Stok Kartı Seçiniz" disabled>
                <div class="relative" id="aramaKonteyneri">
                    <input type="text" id="stokArama" class="w-full px-3 py-2 text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Stok ara veya seç...">
                    <div id="stokKartiListesi" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto hidden">
                    </div>
                </div>
            </div>

            <div id="dinamik-alanlar-wrapper" class="relative" style="min-height: 280px;">
                <div id="initial-prompt" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 transition-opacity duration-300">
                    <i class="fas fa-hand-point-up fa-3x mb-3"></i>
                    <p class="font-semibold">Lütfen bir stok kartı seçiniz.</p>
                </div>

                <div id="defaultLayout" class="hidden space-y-6 opacity-0 transition-opacity duration-300">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label for="diger-miktar" id="diger-miktar-label" class="text-sm font-medium text-gray-700">Miktar</label>
                            <input type="text" id="diger-miktar" class="w-full px-3 py-2 text-right font-mono border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div class="space-y-2">
                            <label for="diger-birim-fiyat" id="diger-birim-fiyat-label" class="text-sm font-medium text-gray-700">Birim Fiyatı</label>
                            <input type="text" id="diger-birim-fiyat" class="w-full px-3 py-2 text-right font-mono border border-gray-300 rounded-md shadow-sm">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 border-t pt-4">
                        <div class="space-y-2">
                            <label for="diger-toplam-tutar" class="text-sm font-medium text-gray-700">Tutar</label>
                            <input type="text" id="diger-toplam-tutar" class="w-full px-3 py-2 text-right font-mono bg-gray-100" readonly>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-gray-700">Tutar Birimi</label>
                            <input type="text" id="diger-tutar-birimi" class="w-full px-3 py-2 text-center font-mono bg-gray-100" readonly>
                        </div>
                    </div>
                    <div class="space-y-2 border-t pt-4">
                        <label for="product-description-default" class="text-sm font-medium text-gray-700">Açıklama</label>
                        <textarea id="product-description-default" class="product-description-input w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm" rows="2" placeholder="İşlem için özel bir açıklama..."></textarea>
                    </div>
                </div>

                <div id="altinLayout" class="hidden space-y-2 opacity-0 transition-opacity duration-300">
                    <div class="grid gap-3" style="grid-template-columns: 2fr 1fr 2fr;">
                        <div class="space-y-2">
                            <label for="altin-miktar" class="text-sm font-medium text-gray-700">Miktar</label>
                            <input type="text" id="altin-miktar" class="w-full px-3 py-2 text-right font-mono border rounded-md">
                        </div>
                        <div class="space-y-2">
                            <label for="altin-milyem" class="text-sm font-medium text-gray-700">Milyem</label>
                            <input type="text" id="altin-milyem" class="w-full px-3 py-2 text-right font-mono bg-gray-100" readonly>
                        </div>
                        <div class="space-y-2">
                            <label for="altin-has" class="text-sm font-medium text-gray-700">HAS</label>
                            <input type="text" id="altin-has" class="w-full px-3 py-2 text-right font-mono bg-gray-100" readonly>
                        </div>
                    </div>
                    <div class="grid gap-3 items-center py-2" style="grid-template-columns: 2fr 1fr 2fr;">
                        <div class="flex items-center space-x-2">
                            <div class="karsilik-toggle-container">
                                <input type="checkbox" id="iscilik-dahil-toggle" class="karsilik-toggle" />
                                <label for="iscilik-dahil-toggle" class="karsilik-toggle-label"></label>
                            </div>
                            <label for="iscilik-dahil-toggle" class="text-sm font-medium text-gray-700 cursor-pointer">İşçilik Dahil</label>
                        </div>
                        <div class="space-y-2">
                            <input type="text" id="iscilik-dahil-deger" class="w-full px-3 py-2 text-right font-mono border rounded-md hidden">
                        </div>
                        <div></div>
                    </div>
                    <div class="border-t pt-4">
                        <div class="grid gap-x-3 gap-y-2" style="grid-template-columns: 2fr 1fr 2fr;">
                            <div class="space-y-2">
                                <label for="altin-birim-iscilik" class="text-sm font-medium text-gray-700">Birim İşçilik</label>
                                <input type="text" id="altin-birim-iscilik" class="w-full px-3 py-2 text-right font-mono border rounded-md">
                            </div>
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-gray-700">Birim</label>
                                <input type="text" id="altin-birim" class="w-full px-3 py-2 text-center font-mono bg-gray-100" readonly>
                            </div>
                            <div class="space-y-2">
                                <label for="altin-iscilik-tutari" class="text-sm font-medium text-gray-700">İşçilik Tutarı</label>
                                <input type="text" id="altin-iscilik-tutari" class="w-full px-3 py-2 text-right font-mono bg-gray-100" readonly>
                            </div>

                            <div id="gram-adet-container" class="flex items-center justify-start col-start-1">
                                <div class="flex items-center border border-blue-500 rounded-md p-0.5 text-sm">
                                    <button id="gram-btn" class="px-3 py-1 rounded-md toggle-btn-active">Gram</button>
                                    <button id="adet-btn" class="px-3 py-1 rounded-md toggle-btn-inactive">Adet</button>
                                </div>
                            </div>
                            <div class="space-y-2 col-start-2">
                                <input type="text" id="altin-adet" class="w-full px-3 py-2 text-right font-mono border rounded-md hidden" value="1">
                            </div>
                        </div>
                    </div>
                    <div class="space-y-2 border-t pt-4">
                        <label for="altin-toplam-has" class="text-sm font-medium text-gray-700">Toplam HAS Değeri</label>
                        <input type="text" id="altin-toplam-has" class="w-full px-3 py-2 text-right font-mono bg-gray-100" readonly>
                    </div>
                    <div class="space-y-2 border-t pt-4">
                        <label for="product-description-altin" class="text-sm font-medium text-gray-700">Açıklama</label>
                        <textarea id="product-description-altin" class="product-description-input w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm" rows="2" placeholder="İşlem için özel bir açıklama..."></textarea>
                    </div>
                </div>

                <div id="hurdaLayout" class="hidden space-y-6 opacity-0 transition-opacity duration-300">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label for="hurda-miktar" class="text-sm font-medium text-gray-700">Miktar</label>
                            <input type="text" id="hurda-miktar" class="w-full px-3 py-2 text-right font-mono border rounded-md">
                        </div>
                        <div class="space-y-2">
                            <label for="hurda-milyem" class="text-sm font-medium text-gray-700">Milyem</label>
                            <input type="text" id="hurda-milyem" class="w-full px-3 py-2 text-right font-mono border rounded-md">
                        </div>
                    </div>
                    <div class="space-y-2 border-t pt-4">
                        <label for="hurda-toplam-has" class="text-sm font-medium text-gray-700">Toplam HAS Değeri</label>
                        <input type="text" id="hurda-toplam-has" class="w-full px-3 py-2 text-right font-mono bg-gray-100" readonly>
                    </div>
                    <div class="space-y-2 border-t pt-4">
                        <label for="product-description-hurda" class="text-sm font-medium text-gray-700">Açıklama</label>
                        <textarea id="product-description-hurda" class="product-description-input w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm" rows="2" placeholder="İşlem için özel bir açıklama..."></textarea>
                    </div>
                </div>
            </div>

        </div>



    </template>
    <!-- Nakit Tahsilat Modal -->
    <div id="nakit-tahsilat-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="min-h-full flex items-start justify-center p-4">
            <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden theme-border flex flex-col max-h-[calc(100vh-2rem)]">

                <!-- Header (SABİT) -->
                <div class="px-6 pt-5 pb-4 border-b border-gray-200 flex items-center justify-between flex-shrink-0">
                    <h3 id="nakit-modal-title" class="text-xl font-extrabold text-gray-900">Nakit Tahsilat</h3>
                    <button id="nakit-tahsilat-close" class="text-gray-500 hover:text-gray-900 text-2xl leading-none">&times;</button>
                </div>

                <!-- Body (SCROLL) -->
                <div class="px-6 py-5 space-y-4 overflow-y-auto flex-1">
                    <!-- Tabs -->
                    <div class="bg-gray-100 rounded-xl p-1 flex gap-1">
                        <button type="button" class="nt-tab flex-1 py-2 rounded-lg font-bold text-sm" data-tab="kasalar">KASALAR</button>
                        <button type="button" class="nt-tab flex-1 py-2 rounded-lg font-bold text-sm" data-tab="bankalar">BANKALAR</button>
                        <button type="button" class="nt-tab flex-1 py-2 rounded-lg font-bold text-sm" data-tab="poslar">POSLAR</button>
                    </div>

                    <!-- Tab contents -->
                    <div id="nt-tab-kasalar" class="nt-panel space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-blue-600 mb-1">Kasa Seçiniz</label>
                            <select id="nt-kasa" class="w-full h-[44px] px-4 rounded-xl border border-gray-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Seçiniz...</option>
                                @foreach (var item in Model.getAllAccountQueryResponses.Where(x => x.AccountTypeId == 7))
                                {
                                    <option value=@item.AccountId>@item.AccountName</option>
                                }
                            </select>
                        </div>
                    </div>

                    <div id="nt-tab-bankalar" class="nt-panel hidden space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-blue-600 mb-1">Banka Seçiniz</label>
                            <select id="nt-banka" class="w-full h-[44px] px-4 rounded-xl border border-gray-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Seçiniz...</option>
                                @foreach (var item in Model.getAllAccountQueryResponses.Where(x => x.AccountTypeId == 5))
                                {
                                    <option value=@item.AccountId>@item.AccountName</option>
                                }
                            </select>
                        </div>
                    </div>

                    <div id="nt-tab-poslar" class="nt-panel hidden space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-blue-600 mb-1">POS Seçiniz</label>
                            <select id="nt-pos" class="w-full h-[44px] px-4 rounded-xl border border-gray-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Seçiniz...</option>
                                @foreach (var item in Model.getAllAccountQueryResponses.Where(x => x.AccountTypeId == 6))
                                {
                                    <option value=@item.AccountId>@item.AccountName</option>
                                }
                            </select>
                        </div>
                    </div>

                    <!-- Amount row -->
                    <div class="grid grid-cols-12 gap-3 items-end">
                        <div class="col-span-3">
                            <label class="block text-sm font-semibold text-blue-600 mb-1">Birim</label>
                            <select id="nt-birim" class="w-full h-[44px] px-4 rounded-xl border border-gray-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">

                                @foreach (var item in Model.getAllCurrencyQueryResponses)
                                {
                                    <option value=@item.Id>@item.CurrencyCode</option>
                                }
                            </select>
                        </div>
                        <div class="col-span-6">
                            <label class="block text-sm font-semibold text-blue-600 mb-1">Tutar</label>
                            <input id="nt-tutar" type="text" value="0,00"
                                   class="w-full h-[44px] px-4 rounded-xl border border-gray-300 bg-white shadow-sm text-right font-mono focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        </div>
                        <div class="col-span-3">
                            <label class="block text-sm font-semibold text-blue-600 mb-1">Kur</label>
                            <input id="nt-kur" type="text" value="0,0000"
                                   class="w-full h-[44px] px-4 rounded-xl border border-gray-300 bg-white shadow-sm text-right font-mono focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        </div>
                    </div>

                    <!-- Karsiligi -->
                    <div>
                        <label class="block text-sm font-semibold text-blue-600 mb-1">Karşılığı</label>
                        <div class="w-full h-[44px] px-4 rounded-xl border border-gray-300 bg-gray-50 shadow-sm flex items-center justify-between">
                            <span id="nt-karsilik" class="font-mono text-right w-full">0,00</span>
                            <span id="nt-karsilik-currency" class="ml-3 text-gray-500 font-semibold">TRY</span>
                        </div>
                    </div>

                    <!-- Button -->
                    <button type="button" id="nt-kalan-ekle"
                            class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-bold px-4 py-2 rounded-xl shadow">
                        <i class="fas fa-calculator"></i>
                        Kalanı Ekle (0,00)
                    </button>

                    <!-- Aciklama -->
                    <div>
                        <label class="block text-sm font-semibold text-blue-600 mb-1">Açıklama</label>
                        <textarea id="nt-aciklama" rows="4"
                                  class="w-full px-4 py-3 rounded-xl border border-gray-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                                  placeholder="Açıklama"></textarea>
                    </div>
                </div>

                <!-- Footer (SABİT) -->
                <div class="px-6 py-4 border-t border-gray-200 flex justify-end gap-3 bg-gray-50 flex-shrink-0">
                    <button type="button" id="nt-delete"
                            class="hidden bg-red-200 hover:bg-red-300 text-red-900 font-bold px-6 py-2 rounded-xl border border-red-300">
                        <i class="fas fa-trash mr-2"></i>Sil
                    </button>

                    <button type="button" id="nt-submit"
                            class="bg-blue-200 hover:bg-blue-300 text-blue-900 font-bold px-6 py-2 rounded-xl border border-blue-300">
                        <i class="fas fa-check mr-2"></i>Ekle
                    </button>
                    <button type="button" id="nt-cancel"
                            class="bg-gray-200 hover:bg-gray-300 text-gray-900 font-bold px-6 py-2 rounded-xl border border-gray-300">
                        <i class="fas fa-times mr-2"></i>Vazgeç
                    </button>
                </div>

            </div>
        </div>
    </div>


    <!-- EKSTRE MODAL -->
    <div id="ekstre-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="min-h-full flex items-start justify-center p-4">
            <div class="bg-gray-50 rounded-lg shadow-xl w-full max-w-7xl flex flex-col max-h-[calc(100vh-2rem)] overflow-hidden">

                <!-- Header (SABİT) -->
                <div class="flex justify-between items-center p-4 ekstre-modal-header rounded-t-lg flex-shrink-0">
                    <h3 class="text-lg font-bold text-gray-700 flex items-center">
                        <i class="fas fa-file-invoice-dollar text-gray-500 mr-3"></i>
                        Hesap Ekstresi
                    </h3>
                    <button id="ekstre-modal-close-button" class="text-gray-500 hover:text-red-600 text-2xl transition-colors">&times;</button>
                </div>

                <!-- Filters (SABİT) -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 p-4 border-b flex-shrink-0">
                    <div class="ekstre-info-card lg:col-span-1">
                        <h4 class="card-title-absolute"><i class="fas fa-user-circle"></i>Müşteri Bilgileri</h4>
                        <span id="ekstre-hesap-adi" class="font-bold text-gray-800 text-base truncate block" title="Hesap Adı"></span>
                        <span id="ekstre-hesap-tipi" class="block text-sm text-gray-500 mt-1"></span>
                        <span id="ekstre-hesap-telefon" class="block text-sm text-gray-600 mt-1"></span>
                        <span id="ekstre-hesap-id" class="text-xs font-mono text-gray-400 block mt-2"></span>
                    </div>

                    <div class="ekstre-info-card lg:col-span-1">
                        <h4 class="card-title-absolute"><i class="fas fa-balance-scale"></i>Bakiye Özeti</h4>
                        <div id="ekstre-bakiye-ozeti" class="custom-scrollbar pr-2 ekstre-bakiye-ozeti-v2">
                            <!-- JS -->
                        </div>
                    </div>

                    <div class="ekstre-info-card lg:col-span-1">
                        <h4 class="card-title-absolute"><i class="fas fa-calendar-alt"></i>Tarih Aralığı</h4>
                        <div class="flex items-stretch">
                            <input type="date" id="ekstre-baslangic-tarihi" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-l-md shadow-sm text-sm h-[38px] border-r-0">
                            <input type="date" id="ekstre-bitis-tarihi" class="block w-full px-3 py-2 bg-white border border-gray-300 shadow-sm text-sm h-[38px] rounded-none">
                            <button id="ekstre-getir-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-r-md text-sm h-[38px] border border-blue-600 flex items-center justify-center">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div class="mt-3 text-center w-full border-t pt-3">
                            <span id="ekstre-has-pozisyon" class="text-base font-semibold"></span>
                        </div>
                    </div>
                </div>

                <!-- Content (SCROLL) -->
                <div id="ekstre-content" class="p-4 overflow-y-auto bg-white rounded-b-lg flex-1">
                    <!-- JS -->
                </div>
            </div>
        </div>
    </div>


    <!-- Satış Fiş Listesi Modal -->
    <div id="fis-list-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="modal-bg absolute inset-0"></div>
        <div class="modal-content bg-white w-full max-w-4xl h-full flex flex-col shadow-2xl relative">
            <div class="flex justify-between items-center p-4 border-b sticky top-0 bg-white z-10">
                <h3 id="fis-list-modal-title" class="text-lg font-bold text-gray-800">Satış Fiş Listesi</h3>
                <button id="fis-list-modal-close-button" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>

            <div id="fis-list-filters" class="p-3 border-b bg-gray-50">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-end">

                    <!-- Hesap Filtresi -->
                    <div class="md:col-span-5">
                        <label for="fis-list-customer-filter" class="block text-xs font-semibold text-gray-600 mb-1">
                            Hesap Filtresi
                        </label>
                        <select id="fis-list-customer-filter"
                                class="w-full h-[38px] px-3 bg-white border border-gray-300 rounded-md shadow-sm text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">


                            @foreach (var item in Model.getAllAccountQueryResponses.Where(x => !x.Tezgahtar))
                            {
                                <option value="@item.AccountId">@item.AccountName</option>
                            }


                        </select>
                    </div>

                    <!-- Başlangıç -->
                    <div class="md:col-span-3">
                        <label for="fis-list-start-date" class="block text-xs font-semibold text-gray-600 mb-1">
                            Başlangıç Tarihi
                        </label>
                        <input type="date" id="fis-list-start-date"
                               class="block w-full h-[38px] px-3 py-1.5 bg-white border border-gray-300 rounded-md shadow-sm text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Bitiş -->
                    <div class="md:col-span-3">
                        <label for="fis-list-end-date" class="block text-xs font-semibold text-gray-600 mb-1">
                            Bitiş Tarihi
                        </label>
                        <input type="date" id="fis-list-end-date"
                               class="block w-full h-[38px] px-3 py-1.5 bg-white border border-gray-300 rounded-md shadow-sm text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <!-- Filtre Button -->
                    <div class="md:col-span-1">
                        <button id="fis-list-filter-button"
                                class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md text-sm h-[38px]">
                            <i class="fas fa-filter mr-1.5"></i>
                        </button>
                    </div>

                </div>
            </div>


            <div id="fis-list-content" class="flex-grow overflow-y-auto">
            </div>
        </div>
    </div>


    <!-- İSKONTO MODAL -->
    <div id="iskonto-panel" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="min-h-full flex items-start justify-center p-4">
            <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden theme-border flex flex-col max-h-[calc(100vh-2rem)]"
                 data-active-tab="borcuna">

                <!-- Header (SABİT) -->
                <div class="px-6 pt-5 pb-4 border-b border-gray-200 flex items-center justify-between hat-red flex-shrink-0">
                    <h3 class="text-lg font-bold text-gray-800">İskonto İşlemi</h3>
                    <button type="button" id="iskonto-modal-close" class="text-gray-500 hover:text-gray-900 text-2xl leading-none">&times;</button>
                </div>

                <!-- Body (SCROLL) -->
                <div class="px-6 py-5 space-y-4 overflow-y-auto flex-1">
                    <div>
                        <div id="iskonto-tipi-toggle" class="tri-toggle-container" data-selected="borcuna">
                            <div class="tri-toggle-slider" style="width: calc((100% - 6px) / 2);"></div>
                            <div class="tri-toggle-options">
                                <div class="tri-toggle-option active" data-value="borcuna" style="color: rgb(220, 38, 38);">HESABIN BORCUNA</div>
                                <div class="tri-toggle-option" data-value="alacagina">HESABIN ALACAĞINA</div>
                            </div>
                        </div>
                    </div>

                    <div id="iskonto-form-content">
                        <div class="grid grid-cols-12 gap-x-1 gap-y-1 items-end">
                            <div class="float-label-container col-span-2">
                                <select id="form-iskonto-currency" class="float-label-input float-label-select" disabled="">
                                    @foreach (var item in Model.getAllCurrencyQueryResponses)
                                    {
                                        <option value=@item.Id>@item.CurrencyCode</option>
                                    }
                                </select>
                                <label for="form-iskonto-currency" class="float-label">Birim</label>
                            </div>
                            <div class="float-label-container col-span-7">
                                <input type="text" id="form-iskonto-amount" class="float-label-input text-right font-mono px-3" placeholder=" " value="6.338,11">
                                <label for="form-iskonto-amount" class="float-label">Miktar</label>
                            </div>
                            <div class="float-label-container col-span-3">
                                <input type="text" id="form-iskonto-rate" class="float-label-input text-right font-mono px-3" placeholder=" " value="1,0000">
                                <label for="form-iskonto-rate" class="float-label">Kur</label>
                            </div>
                        </div>
                    </div>

                    <div class="float-label-container">
                        <input type="text" id="form-iskonto-karsi-hesap" class="float-label-input" value="İSKONTO SATIŞTAN" readonly="">
                        <label for="form-iskonto-karsi-hesap" class="float-label">Karşı Hesap</label>
                    </div>

                    <div id="iskonto-has-container">
                        <div class="grid grid-cols-12 gap-x-1 gap-y-1 items-end">
                            <div class="float-label-container col-span-2">
                                <select id="form-iskonto-equiv-currency" class="float-label-input float-label-select" disabled="">
                                    <option value="1">HAS</option>
                                </select>
                                <label for="form-iskonto-equiv-currency" class="float-label">Bilanço</label>
                            </div>
                            <div class="float-label-container col-span-7">
                                <input type="text" id="form-iskonto-equiv-amount" class="float-label-input text-right font-mono px-3" placeholder=" " value="0,00" readonly="">
                                <label for="form-iskonto-equiv-amount" class="float-label">HAS Karşılığı</label>
                            </div>
                            <div class="float-label-container col-span-3">
                                <input type="text" id="form-iskonto-equiv-rate" class="float-label-input text-right font-mono px-3" placeholder=" " value="0,0000" readonly="">
                                <label for="form-iskonto-equiv-rate" class="float-label">HAS Kuru</label>
                            </div>
                        </div>
                    </div>

                    <div class="float-label-container mt-4">
                        <textarea id="form-iskonto-aciklama" class="float-label-input" placeholder=" " rows="3"></textarea>
                        <label for="form-iskonto-aciklama" class="float-label">Açıklama</label>
                    </div>
                </div>

                <!-- Footer (SABİT) -->
                <div class="p-4 border-t border-gray-200 flex justify-end gap-2 flex-shrink-0 bg-white">
                    <button id="iskonto-delete-button"
                            class="hidden bg-red-100 hover:bg-red-200 text-red-800 font-semibold py-1.5 px-4 rounded-md text-sm transition-colors border border-red-200">
                        <i class="fas fa-trash mr-1.5"></i>Sil
                    </button>

                    <button id="iskonto-add-button"
                            class="bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold py-1.5 px-4 rounded-md text-sm transition-colors border border-blue-200">
                        <i class="fas fa-check mr-1.5"></i>Ekle
                    </button>

                    <button id="iskonto-cancel-button"
                            class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-1.5 px-4 rounded-md text-sm transition-colors border border-gray-200">
                        <i class="fas fa-times mr-1.5"></i>Vazgeç
                    </button>
                </div>

            </div>
        </div>
    </div>


    <!-- VİRMAN MODAL -->
    <div id="virman-panel" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="min-h-full flex items-start justify-center p-4">
            <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl theme-border hat-green overflow-hidden flex flex-col max-h-[calc(100vh-2rem)]">

                <!-- Header (SABİT) -->
                <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between flex-shrink-0">
                    <h3 class="font-bold text-lg text-gray-800">Virman İşlemi</h3>
                    <button id="virman-close" class="text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button>
                </div>

                <!-- Body (SCROLL) -->
                <div class="p-6 overflow-y-auto custom-scrollbar flex-1" data-active-tab="alacagina">
                    <div class="space-y-4">

                        <div>
                            <div id="virman-tipi-toggle" class="tri-toggle-container" data-selected="alacagina">
                                <div class="tri-toggle-slider" style="width: calc((100% - 6px) / 2);"></div>
                                <div class="tri-toggle-options">
                                    <div class="tri-toggle-option" data-value="borcuna" style="color: rgb(107, 114, 128);">
                                        HESABIN BORCUNA (-)
                                    </div>
                                    <div class="tri-toggle-option active" data-value="alacagina" style="color: rgb(5, 150, 105);">
                                        HESABIN ALACAĞINA (+)
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-6 gap-x-2 gap-y-1 items-end">
                            <div class="float-label-container col-span-1 select-has-value">
                                <select id="form-virman-currency" class="float-label-input float-label-select" required disabled>
                                    <option value="3">TRY</option>
                                </select>
                                <label for="form-virman-currency" class="float-label">Birim</label>
                            </div>

                            <div class="float-label-container col-span-3">
                                <input type="text" id="form-virman-amount" class="float-label-input text-right font-mono" placeholder=" " value="0,00">
                                <label for="form-virman-amount" class="float-label">Miktar</label>
                            </div>

                            <div class="float-label-container col-span-2">
                                <input type="text" id="form-virman-rate" class="float-label-input text-right font-mono" placeholder=" " value="1,0000">
                                <label for="form-virman-rate" class="float-label">Kur</label>
                            </div>
                        </div>

                        <div class="float-label-container">
                            <select id="form-virman-karsi-hesap" class="float-label-input float-label-select" required>
                                <option value=""></option>
                                <option value="68">AHLATÇI</option>
                                <option value="14">AHMET KAVALCI</option>
                                <option value="7">ANA SERMAYE</option>
                                <option value="53">DOVİZ ALIŞ-SATIŞ K/Z</option>
                                <option value="65">ELMAS TAŞ GRUBU STOKLARI</option>
                                <option value="30">GİDER AİDAT</option>
                                <option value="31">GİDER ALARM TESİSAT BAKIM</option>
                                <option value="32">GİDER AMBALAJ</option>
                                <option value="34">GİDER BAĞIŞ YARDIM</option>
                                <option value="36">GİDER BANKA KOMİSYONLARI</option>
                                <option value="35">GİDER BANKA MASRAFLARI</option>
                                <option value="50">GİDER DİĞER</option>
                                <option value="38">GİDER ELEKTRİK FATURASI</option>
                                <option value="39">GİDER İKRAM ve YEMEK</option>
                                <option value="33">GİDER İNTERNET</option>
                                <option value="40">GİDER KARGO</option>
                                <option value="41">GİDER KİRA</option>
                                <option value="37">GİDER MAĞAZA TAMİR BAKIM</option>
                                <option value="42">GİDER MUHASEBE</option>
                                <option value="43">GİDER PERSONEL MAAŞ</option>
                                <option value="44">GİDER PERSONEL PRİMLERİ</option>
                                <option value="46">GİDER PERSONEL SİGORTA</option>
                                <option value="47">GİDER PERSONEL YEMEK</option>
                                <option value="45">GİDER REKLAM</option>
                                <option value="49">GİDER ULAŞIM</option>
                                <option value="48">GİDER VERGİ</option>
                                <option value="60">HAKİ MUSTAFA ALKAN</option>
                                <option value="52">HURDA ALIŞ-SATIŞ K/Z</option>
                                <option value="62">HURDA GRUBU STOKLARI</option>
                                <option value="55">İSKONTO CARİDEN</option>
                                <option value="54">İSKONTO SATIŞTAN</option>
                                <option value="61">MADEN GRUBU STOKLARI</option>
                                <option value="27">MAHMUT KAVALCI</option>
                                <option value="63">MAMUL GRUBU STOKLARI</option>
                                <option value="4">MAZLUM KUYUMCULUK</option>
                                <option value="64">PIRLANTA TAŞ GRUBU STOKLARI</option>
                                <option value="58">RAŞİT DUMAN</option>
                                <option value="66">RENKLİ TAŞ GRUBU STOKLARI</option>
                                <option value="51">ÜRÜN SATIŞ-İADE K/Z</option>
                                <option value="5">ZERAY KUYUMCULUK</option>
                            </select>
                            <label for="form-virman-karsi-hesap" class="float-label">Karşı Hesap</label>
                        </div>

                        <div class="p-2 border border-gray-200 rounded-md bg-gray-50">
                            <div class="flex justify-between items-center">
                                <label for="virman-karsilik-toggle" class="text-sm font-medium text-gray-700 select-none">
                                    Farklı Birim Karşılığı
                                </label>
                                <div class="karsilik-toggle-container">
                                    <input type="checkbox" id="virman-karsilik-toggle" class="karsilik-toggle">
                                    <label for="virman-karsilik-toggle" class="karsilik-toggle-label"></label>
                                </div>
                            </div>
                        </div>

                        <div id="virman-karsilik-details" class="hidden space-y-3 pt-3 border-t border-gray-200 mt-3">
                            <div class="grid grid-cols-6 gap-x-2 gap-y-1 items-end">
                                <div class="float-label-container col-span-1 select-has-value">
                                    <select id="form-virman-karsilik-currency" class="float-label-input float-label-select" required>
                                        <option value=""></option>
                                        <option value="1">HAS</option>
                                        <option value="2">USD</option>
                                        <option value="3">TRY</option>
                                        <option value="4">EUR</option>
                                        <option value="6">CHF</option>
                                        <option value="7">SAR</option>
                                        <option value="8">GHS</option>
                                    </select>
                                    <label for="form-virman-karsilik-currency" class="float-label">Karşılık Birim</label>
                                </div>

                                <div class="float-label-container col-span-3">
                                    <input type="text" id="form-virman-karsilik-amount" class="float-label-input text-right font-mono" placeholder=" " value="0,00">
                                    <label for="form-virman-karsilik-amount" class="float-label">Karşılık Miktar</label>
                                </div>

                                <div class="float-label-container col-span-2">
                                    <input type="text" id="form-virman-karsilik-rate" class="float-label-input text-right font-mono" placeholder=" " value="1,0000">
                                    <label for="form-virman-karsilik-rate" class="float-label">Karşılık Kur</label>
                                </div>
                            </div>
                        </div>

                        <div class="float-label-container mt-6">
                            <textarea id="form-virman-aciklama" class="float-label-input pt-4" placeholder=" " rows="5"></textarea>
                            <label for="form-virman-aciklama" class="float-label">Açıklama</label>
                        </div>

                    </div>
                </div>

                <!-- Footer (SABİT) -->
                <div class="p-4 border-t border-gray-200 flex justify-end gap-2 flex-shrink-0 bg-white">
                    <button id="virman-delete-button"
                            class="hidden bg-red-100 hover:bg-red-200 text-red-800 font-semibold py-1.5 px-4 rounded-md text-sm transition-colors border border-red-200">
                        <i class="fas fa-trash mr-1.5"></i>Sil
                    </button>

                    <button id="virman-add-button"
                            class="bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold py-1.5 px-4 rounded-md text-sm transition-colors border border-blue-200">
                        <i class="fas fa-check mr-1.5"></i>Ekle
                    </button>

                    <button id="virman-cancel-button"
                            class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-1.5 px-4 rounded-md text-sm transition-colors border border-gray-200">
                        <i class="fas fa-times mr-1.5"></i>Vazgeç
                    </button>
                </div>

            </div>
        </div>
    </div>


    <!-- AÇIK HESAP MODAL -->
    <div id="acik-hesap-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
        <div class="min-h-full flex items-start justify-center p-4">
            <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden theme-border hat-red flex flex-col max-h-[calc(100vh-2rem)]">

                <!-- Header (SABİT) -->
                <div class="px-6 pt-5 pb-4 border-b border-gray-200 flex items-center justify-between flex-shrink-0">
                    <h3 class="text-xl font-extrabold text-gray-900">Açık Hesap İşlemi</h3>
                    <button type="button" id="acik-hesap-close" class="text-gray-500 hover:text-gray-900 text-2xl leading-none">&times;</button>
                </div>

                <!-- Body (SCROLL) -->
                <div id="acik-hesap-body" class="px-6 py-5 space-y-4 overflow-y-auto flex-1" data-active-tab="borcuna">

                    <div>
                        <div id="acikhesap-tipi-toggle" class="tri-toggle-container" data-selected="borcuna">
                            <div class="tri-toggle-slider" style="width: calc((100% - 6px) / 2);"></div>
                            <div class="tri-toggle-options">
                                <div class="tri-toggle-option active" data-value="borcuna" style="color: rgb(220, 38, 38);">
                                    HESABIN BORCUNA (-)
                                </div>
                                <div class="tri-toggle-option" data-value="alacagina">
                                    HESABIN ALACAĞINA (+)
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="acikhesap-form-content">
                        <div class="grid grid-cols-12 gap-x-1 gap-y-1 items-end">
                            <div class="float-label-container col-span-2">
                                <select id="form-acikhesap-currency" class="float-label-input float-label-select" disabled>
                                    <option value="3">TRY</option>
                                </select>
                                <label for="form-acikhesap-currency" class="float-label">Birim</label>
                            </div>

                            <div class="float-label-container col-span-7">
                                <input type="text" id="form-acikhesap-amount"
                                       class="float-label-input text-right font-mono px-3"
                                       placeholder=" " value="0,00">
                                <label for="form-acikhesap-amount" class="float-label">Miktar</label>
                            </div>

                            <div class="float-label-container col-span-3">
                                <input type="text" id="form-acikhesap-rate"
                                       class="float-label-input text-right font-mono px-3"
                                       placeholder=" " value="1,0000">
                                <label for="form-acikhesap-rate" class="float-label">Kur</label>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Footer (SABİT) -->
                <div class="px-6 py-4 border-t border-gray-200 flex justify-end gap-2 bg-gray-50 flex-shrink-0">
                    <button id="acik-hesap-delete-button"
                            class="hidden bg-red-100 hover:bg-red-200 text-red-800 font-semibold py-1.5 px-4 rounded-md text-sm transition-colors border border-red-200">
                        <i class="fas fa-trash mr-1.5"></i>Sil
                    </button>

                    <button id="acik-hesap-add-button"
                            class="bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold py-1.5 px-4 rounded-md text-sm transition-colors border border-blue-200">
                        <i class="fas fa-check mr-1.5"></i>Ekle
                    </button>

                    <button id="acik-hesap-cancel"
                            class="bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-1.5 px-4 rounded-md text-sm transition-colors border border-gray-200">
                        <i class="fas fa-times mr-1.5"></i>Vazgeç
                    </button>
                </div>

            </div>
        </div>
    </div>






</body>
</html>
@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {



                  

          // -----------------------------------
          // Global error logger (debug)
          // -----------------------------------
          window.addEventListener("error", (ev) => {
            console.error("JS Error:", ev.message, ev.filename, ev.lineno, ev.colno);
          });

                  ["main-delete-button", "main-delete-button-mobile"].forEach(id => {
          const b = document.getElementById(id);
          if (b && b.tagName === "BUTTON") b.type = "button";
        });

                const deleteBtn = document.getElementById("main-delete-button");
        const deleteBtnMobile = document.getElementById("main-delete-button-mobile");

        const confirmModal = document.getElementById("confirmation-modal");
        const confirmMsg = document.getElementById("modal-message");
        const confirmYes = document.getElementById("modal-confirm");
        const confirmNo = document.getElementById("modal-cancel");


          // -----------------------------------
          // Helpers
          // -----------------------------------
          const fmt2 = new Intl.NumberFormat("tr-TR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
          const fmt4 = new Intl.NumberFormat("tr-TR", { minimumFractionDigits: 4, maximumFractionDigits: 4 });

          const el = (id) => (typeof id === "string" ? document.getElementById(id) : null);

          function sanitizeNumericText(raw) {
            let s = (raw ?? "").toString().trim().replace(/[^\d,.\-]/g, "");
            s = s.replace(/(?!^)-/g, "");
            s = s.replace(/\./g, "");
            const firstComma = s.indexOf(",");
            if (firstComma !== -1) {
              s = s.slice(0, firstComma + 1) + s.slice(firstComma + 1).replace(/,/g, "");
            }
            return s;
          }

          function parseTrNumber(raw) {
            const s = sanitizeNumericText(raw);
            if (!s || s === "-" || s === ",") return 0;
            const normalized = s.replace(",", ".");
            const n = Number.parseFloat(normalized);
            return Number.isFinite(n) ? n : 0;
          }

          function parseDecimalTr(value) {
            if (value == null) return null;
            let s = String(value).trim();
            if (!s) return null;
            s = s.replace(/\./g, "").replace(",", ".");
            const n = Number(s);
            return Number.isFinite(n) ? n : null;
          }

          function wireTrMoneyInput(inputEl, decimals) {
            if (!inputEl) return;
            if (inputEl.dataset.wired === "1") return;
            inputEl.dataset.wired = "1";

            inputEl.addEventListener("input", () => {
              const before = inputEl.value;
              const after = sanitizeNumericText(before);
              if (before !== after) inputEl.value = after;
            });

            const formatNow = () => {
              const n = parseTrNumber(inputEl.value);
              inputEl.value = (decimals === 4 ? fmt4 : fmt2).format(n);
            };

            inputEl.addEventListener("blur", formatNow);
            inputEl.addEventListener("change", formatNow);
          }

          function getSelectedText(selectEl) {
            const opt = selectEl?.options?.[selectEl.selectedIndex];
            return (opt?.textContent || "").trim();
          }

          function selectByText(selectEl, wantedText) {
            if (!selectEl) return false;
            const t = (wantedText || "").trim();
            if (!t) return false;
            const opts = Array.from(selectEl.options || []);
            const found = opts.find(o => (o.textContent || "").trim() === t);
            if (!found) return false;
            selectEl.value = found.value;
            selectEl.dispatchEvent(new Event("change", { bubbles: true }));
            return true;
          }

          function safeNumber(v) {
            const n = Number(v);
            return Number.isFinite(n) ? n : null;
          }

          // -----------------------------------
          // Form & Hidden fields (KESİN DOLDUR)
          // -----------------------------------
          const form = el("receiptForm");
          if (!form) {
            console.warn("receiptForm bulunamadı");
            return;
          }

          const dt = el("fis-tarihi");
          const customerSelect = el("customer-select");
          const employeeSelect = el("salesperson-select"); // tezgahtar
          const opToggle = el("operation-type-toggle");
          const currencySelect = el("currency-select");

          const hdnDate = el("hdn-ReceiptDate");
          const hdnCustomer = el("hdn-CurrentAccountId");
          const hdnEmployee = el("hdn-EmployeeId");
          const hdnIsCustomer = el("hdn-IsCustomerReceipt");
          const hdnCurrencyCode = el("hdn-CurrencyCode");
          const hdnMovements = el("MovementsJson");



          function normalizeDateTimeLocal(value) {
            if (!value) return "";
            return value.length === 16 ? value + ":00" : value;
          }

          function getSelectedCurrencyCode() {
            if (!currencySelect) return "TRY";
            const opt = currencySelect.options?.[currencySelect.selectedIndex];
            const code = (opt?.textContent || currencySelect.value || "TRY").trim();
            return code || "TRY";
          }

          function fillHiddenFields() {
            if (hdnDate && dt) hdnDate.value = normalizeDateTimeLocal(dt.value);
            if (hdnCustomer && customerSelect) hdnCustomer.value = customerSelect.value || "";
            if (hdnEmployee && employeeSelect) hdnEmployee.value = employeeSelect.value || "";
            if (hdnIsCustomer && opToggle) hdnIsCustomer.value = opToggle.checked ? "true" : "false";
            if (hdnCurrencyCode) hdnCurrencyCode.value = getSelectedCurrencyCode();
          }

          dt?.addEventListener("change", fillHiddenFields);
          customerSelect?.addEventListener("change", fillHiddenFields);
          employeeSelect?.addEventListener("change", fillHiddenFields);
          opToggle?.addEventListener("change", fillHiddenFields);
          currencySelect?.addEventListener("change", fillHiddenFields);

          // En erken submit yakala (capture=true) => her şey garanti
          form.addEventListener("submit", (event) => {

                      // ---- SATIŞ MODUNDA FARK KONTROLÜ (KAYDETMEYİ ENGELLE) ----
                const isSalesMode = document.body.classList.contains("satis-active"); // satış modu
                if (isSalesMode) {
                  // Fark tutarını DOM'dan çek
                  const farkText =
                    document.getElementById("fark-amount")?.textContent ||
                    document.getElementById("fark-toplam")?.dataset?.amount ||
                    "0,00";

                  const fark = parseTrNumber(farkText);

                  // 0 değilse (küçük küsuratları da tolere edelim)
                  if (Math.abs(fark) > 0.000001) {
                    // submit'i durdur
                    event.preventDefault();
                    event.stopPropagation();

                    // Mesajı hazırla
                    const msg = `Satışta Giren ile Çıkan aynı değerde olmalıdır. Mevcut Fark: ${fmt2.format(fark)} ${getSelectedCurrencyCode()}`;

                    // --- Senin error modalını aç ---
                    // 1) Eğer hazır modalın varsa: #error-modal / #errorMessageModal / #error-message-modal gibi
                    const modal =
                      document.getElementById("error-modal");

                    // 2) Mesajı basacağımız alan (senin yapına göre)
                    const modalTitle =
                      document.getElementById("error-modal-title") ||
                      modal?.querySelector("[data-error-title]") ||
                      modal?.querySelector(".modal-title");

                    const modalBody =
                      document.getElementById("error-modal-message") ||
                      modal?.querySelector("[data-error-message]") ||
                      modal?.querySelector(".modal-body") ||
                      modal?.querySelector("p");

                    // Başlık & içerik
                    if (modalTitle) modalTitle.textContent = "Uyarı";
                    if (modalBody) modalBody.textContent = msg;

                    // Modal açma (senin mevcut Modal.open'un varsa onu kullanır)
                    if (modal && typeof Modal !== "undefined" && typeof Modal.open === "function") {
                      Modal.open(modal);
                    } else if (modal) {
                      // basit fallback
                      modal.classList.remove("hidden");
                      modal.style.display = "flex";
                      modal.style.zIndex = "9999";
                    } else {
                      // modal bulunamazsa fallback alert
                      alert("Uyarı\n" + msg);
                    }

                    return; // devam etmesin
                  }
                }

            try {
              fillHiddenFields();
              if (hdnMovements) hdnMovements.value = JSON.stringify(state.movements || []);
              console.log("✅ SUBMIT PAYLOAD", {
                ReceiptDate: hdnDate?.value,
                CurrentAccountId: hdnCustomer?.value,
                EmployeeId: hdnEmployee?.value,
                IsCustomerReceipt: hdnIsCustomer?.value,
                CurrencyCode: hdnCurrencyCode?.value,
                MovementsJson_len: (hdnMovements?.value || "").length
              });
            } catch (err) {
              console.error("submit handler crashed:", err);
            }
          }, true);

          // İlk yükleme
          fillHiddenFields();

          // -----------------------------------
          // Totals DOM safety
          // -----------------------------------
          function ensureTotalDom(wrapperId, amountId, currencyId) {
            const wrap = el(wrapperId);
            if (!wrap) return null;

            if (!wrap.dataset.amount) {
              const raw = (wrap.textContent || "").trim();
              const maybeAmount = raw.split(" ")[0] || "0,00";
              wrap.dataset.amount = maybeAmount;
            }

            let amountEl = el(amountId);
            let currEl = el(currencyId);

            if (!amountEl || !currEl || !wrap.contains(amountEl) || !wrap.contains(currEl)) {
              wrap.innerHTML = `
                <span id="${amountId}">${wrap.dataset.amount || "0,00"}</span>
                <span id="${currencyId}">TRY</span>
              `;
              amountEl = el(amountId);
              currEl = el(currencyId);
            }

            return { wrap, amountEl, currEl };
          }

          function setTotal(wrapperId, amountId, currencyId, amountText) {
            const dom = ensureTotalDom(wrapperId, amountId, currencyId);
            if (!dom) return;
            dom.wrap.dataset.amount = amountText ?? "0,00";
            dom.amountEl.textContent = dom.wrap.dataset.amount;
            dom.currEl.textContent = getSelectedCurrencyCode();
          }

          function syncTotalsCurrencyOnly() {
            const code = getSelectedCurrencyCode();

            const a = ensureTotalDom("giren-toplam", "giren-toplam-amount", "giren-toplam-currency");
            if (a) a.currEl.textContent = code;

            const b = ensureTotalDom("cikan-toplam", "cikan-toplam-amount", "cikan-toplam-currency");
            if (b) b.currEl.textContent = code;

            const c = ensureTotalDom("fark-toplam", "fark-amount", "fark-currency");
            if (c) c.currEl.textContent = code;

            const nt = el("nt-karsilik-currency");
            if (nt) nt.textContent = code;
          }

          // -----------------------------------
          // DateTime init
          // -----------------------------------
          const fisTarihi = el("fis-tarihi");
          if (fisTarihi && !fisTarihi.value) {
            const now = new Date();
            const pad = (n) => String(n).padStart(2, "0");
            fisTarihi.value =
              now.getFullYear() + "-" +
              pad(now.getMonth() + 1) + "-" +
              pad(now.getDate()) + "T" +
              pad(now.getHours()) + ":" +
              pad(now.getMinutes());
          }

          // -----------------------------------
          // UI Elements
          // -----------------------------------
          const receiptLog = el("receipt-log");
          const toggleMode = el("operation-type-toggle");
          const receiptTitle = el("receipt-title");

          const lblNakitTahsilat = el("label-nakit-tahsilat");
          const lblNakitOdeme = el("label-nakit-odeme");
          const lblUrunAlis = el("label-urun-alis");
          const lblUrunSatis = el("label-urun-satis");
          const lbllistModalTitle = el("fis-list-modal-title");
          const lblSalesListButton = el("sales-list-button");

          // Modals
          const nakitModal = el("nakit-tahsilat-modal");
          const iskontoModal = el("iskonto-panel");
          const virmanModal = el("virman-panel");
          const acikModal = el("acik-hesap-modal");
          const ekstreModal = el("ekstre-modal");
          const fisListModal = el("fis-list-modal");
          const errorsModal = el("error-modal");


          // -----------------------------------
          // Modal Manager
          // -----------------------------------
          const Modal = {
            open(modalEl) {
              if (!modalEl) return;
              modalEl.classList.remove("hidden");
              modalEl.style.display = "flex";
              modalEl.style.opacity = "1";
              modalEl.style.pointerEvents = "auto";
              modalEl.style.visibility = "visible";
              modalEl.style.zIndex = "9999";
              document.body.classList.add("overflow-hidden");
            },
            close(modalEl) {
              if (!modalEl) return;
              modalEl.classList.add("hidden");
              modalEl.style.display = "none";
              document.body.classList.remove("overflow-hidden");
            },
            isOpen(modalEl) {
              return !!modalEl && !modalEl.classList.contains("hidden");
            }
          };

          function closeAllModals() {
            Modal.close(nakitModal);
            Modal.close(iskontoModal);
            Modal.close(virmanModal);
            Modal.close(acikModal);
            Modal.close(ekstreModal);
            Modal.close(fisListModal);
          }

          document.addEventListener("keydown", (e) => {
            if (e.key !== "Escape") return;
            if (Modal.isOpen(nakitModal)) return Modal.close(nakitModal);
            if (Modal.isOpen(iskontoModal)) return Modal.close(iskontoModal);
            if (Modal.isOpen(virmanModal)) return Modal.close(virmanModal);
            if (Modal.isOpen(acikModal)) return Modal.close(acikModal);
            if (Modal.isOpen(ekstreModal)) return Modal.close(ekstreModal);
            if (Modal.isOpen(fisListModal)) return Modal.close(fisListModal);
          });

          function wireBackdropClose(modalEl) {
            if (!modalEl) return;
            modalEl.addEventListener("click", (e) => {
              if (e.target === modalEl) Modal.close(modalEl);
            });
          }

          wireBackdropClose(nakitModal);
          wireBackdropClose(iskontoModal);
          wireBackdropClose(virmanModal);
          wireBackdropClose(acikModal);
          wireBackdropClose(ekstreModal);
          wireBackdropClose(fisListModal);

          // -----------------------------------
          // Form içindeki butonlar submit olmasın
          // -----------------------------------
          [
            "btn-nakit-tahsilat", "btn-nakit-odeme", "btn-iskonto", "btn-virman", "btn-acik-hesap",
            "ekstre-button", "sales-list-button", "main-reset-button",
            "nt-submit", "nt-delete", "nt-cancel", "nakit-tahsilat-close",
            "iskonto-add-button", "iskonto-delete-button", "iskonto-cancel-button", "iskonto-modal-close",
            "virman-add-button", "virman-delete-button", "virman-cancel-button", "virman-close",
            "acik-hesap-add-button", "acik-hesap-delete-button", "acik-hesap-cancel", "acik-hesap-close"
          ].forEach(id => {
            const b = el(id);
            if (b && b.tagName === "BUTTON") b.type = "button";
          });

          // -----------------------------------
          // State
          // -----------------------------------
          const state = window.state ?? {
            items: [],
            movements: [],
            edit: { kind: null, index: null },
            currentCashOperation: "GIRIS",
          };
          window.state = state;

          // -----------------------------------
          // Totals / Receipt
          // -----------------------------------
          function writeTotals(giren, cikan) {
            const fark = giren - cikan;
            setTotal("giren-toplam", "giren-toplam-amount", "giren-toplam-currency", fmt2.format(giren));
            setTotal("cikan-toplam", "cikan-toplam-amount", "cikan-toplam-currency", fmt2.format(cikan));
            setTotal("fark-toplam", "fark-amount", "fark-currency", fmt2.format(fark));
          }

          function ensureSection(id, title, colorMode /* green|red */) {
            if (!receiptLog) return null;
            let section = el(id);
            if (section) return section;

            section = document.createElement("div");
            section.id = id;
            section.className = "theme-border-50 rounded-xl overflow-hidden mb-3";

            const borderClass = colorMode === "red"
              ? "border-red-200 text-red-700"
              : "border-green-200 text-green-700";

            section.innerHTML = `
              <div class="px-4 py-2 border-b ${borderClass} font-extrabold tracking-widest text-xs">
                ${title}
              </div>
              <div class="p-3 space-y-2" data-items></div>
            `;
            receiptLog.prepend(section);
            return section;
          }

          function ensureSectionNeutral(id, title) {
            if (!receiptLog) return null;
            let section = el(id);
            if (section) return section;

            section = document.createElement("div");
            section.id = id;
            section.className = "theme-border-50 rounded-xl overflow-hidden mb-3";

            section.innerHTML = `
              <div class="px-4 py-2 border-b border-gray-200 text-gray-700 font-extrabold tracking-widest text-xs">
                ${title}
              </div>
              <div class="p-3 space-y-2" data-items></div>
            `;
            receiptLog.prepend(section);
            return section;
          }

          function rowHtml({ leftTop, leftBottom, rightTop, rightBottom, isGreen }) {
            return `
              <div class="flex items-start justify-between gap-3">
                <div class="min-w-0">
                  <div class="${isGreen ? "text-green-700" : "text-red-700"} font-extrabold text-sm">${leftTop}</div>
                  <div class="text-gray-700 font-mono text-xs mt-1 truncate">${leftBottom || ""}</div>
                </div>
                <div class="text-right">
                  <div class="${isGreen ? "text-green-700" : "text-red-700"} font-extrabold text-sm">${rightTop}</div>
                  <div class="text-gray-500 font-mono text-xs mt-1">${rightBottom || ""}</div>
                </div>
              </div>
            `;
          }

          function addRowToUI(sectionId, sectionTitle, sectionKind, item, index, render, isGreenRow) {
            const section =
              sectionKind === "neutral"
                ? ensureSectionNeutral(sectionId, sectionTitle)
                : ensureSection(sectionId, sectionTitle, sectionKind);

            if (!section) return;

            const wrap = section.querySelector("[data-items]");
            const row = document.createElement("div");
            row.setAttribute("data-receipt-item", "1");
            row.dataset.index = String(index);
            row.dataset.kind = item.kind;
            row.style.cursor = "pointer";

            row.className = `rounded-lg border ${isGreenRow ? "border-green-100" : "border-red-100"} bg-white px-3 py-2`;
            row.innerHTML = render(isGreenRow);

            wrap.appendChild(row);
          }

          function renderItem(item, index) {
            if (item.kind === "NAKIT") {
              const isGiris = item.type === "GIRIS";
              addRowToUI(
                isGiris ? "section-nakit-girisler" : "section-nakit-cikislar",
                isGiris ? "NAKİT GİRİŞLER" : "NAKİT ÇIKIŞLAR",
                isGiris ? "green" : "red",
                item,
                index,
                (isGreen) => rowHtml({
                  isGreen,
                  leftTop: `${isGiris ? "+" : "-"}${fmt2.format(item.tutar)} ${item.currency}`,
                  rightTop: `${fmt2.format(item.karsilikTry)} TRY`,
                  leftBottom: `${item.hesapAdi} - ${isGiris ? "Nakit Giriş" : "Nakit Çıkış"}`,
                  rightBottom: `TRY Kuru: ${fmt4.format(item.kur)}`
                }),
                isGiris
              );
              return;
            }

            if (item.kind === "ISKONTO") {
              const isGiris = item.type === "GIRIS";
              addRowToUI(
                "section-iskonto",
                "İSKONTO",
                "neutral",
                item,
                index,
                (isGreen) => rowHtml({
                  isGreen,
                  leftTop: `${isGiris ? "+" : "-"}${fmt2.format(item.amount)} ${item.currency}`,
                  rightTop: `${fmt2.format(item.karsilikTry)} TRY`,
                  leftBottom: item.karsiHesapAdi || "İSKONTO",
                  rightBottom: `Kur: ${fmt4.format(item.rate)}`
                }),
                isGiris
              );
              return;
            }

            if (item.kind === "VIRMAN") {
              addRowToUI(
                "section-virmanlar",
                "VİRMAN",
                "green",
                item,
                index,
                () => rowHtml({
                  isGreen: true,
                  leftTop: `${fmt2.format(item.amount)} ${item.currency}`,
                  rightTop: `${fmt2.format(item.karsilikTry)} TRY`,
                  leftBottom: `${item.from} → ${item.to}`,
                  rightBottom: `Kur: ${fmt4.format(item.rate)}`
                }),
                true
              );
              return;
            }

            if (item.kind === "ACIK_HESAP") {
              const isGiris = item.type === "GIRIS";
              addRowToUI(
                "section-acik-hesap",
                "AÇIK HESAP",
                "neutral",
                item,
                index,
                (isGreen) => rowHtml({
                  isGreen,
                  leftTop: `${isGiris ? "+" : "-"}${fmt2.format(item.amount)} TRY`,
                  rightTop: `${fmt2.format(item.amount)} TRY`,
                  leftBottom: item.karsiHesapAdi || "Açık Hesap",
                  rightBottom: item.aciklama || ""
                }),
                isGiris
              );
              return;
            }
          }

          function rerenderReceipt() {
            if (!receiptLog) return;

            receiptLog.innerHTML = "";
            let giren = 0, cikan = 0;

            state.items.forEach((item, index) => {
              renderItem(item, index);

              if (item.kind === "NAKIT" || item.kind === "ISKONTO") {
                if (item.type === "GIRIS") giren += (item.karsilikTry || 0);
                else cikan += (item.karsilikTry || 0);
              }

              if (item.kind === "VIRMAN") {
                giren += (item.karsilikTry || 0);
                cikan += (item.karsilikTry || 0);
              }

              if (item.kind === "ACIK_HESAP") {
                if (item.type === "GIRIS") giren += (item.amount || 0);
                else cikan += (item.amount || 0);
              }
            });

            writeTotals(giren, cikan);
          }

          // -----------------------------------
          // Mode Toggle (SATIŞ/CARİ) + Uyarı
          // -----------------------------------
          function setButtonLabels(isCari) {
            if (lblNakitTahsilat) lblNakitTahsilat.textContent = isCari ? "Nakit Giriş" : "Nakit Tahsilat";
            if (lblNakitOdeme) lblNakitOdeme.textContent = isCari ? "Nakit Çıkış" : "Nakit Ödeme";
            if (lblUrunAlis) lblUrunAlis.textContent = isCari ? "Ürün Giriş" : "Ürün Alış";
            if (lblUrunSatis) lblUrunSatis.textContent = isCari ? "Ürün Çıkış" : "Ürün Satış";
            if (lbllistModalTitle) lbllistModalTitle.textContent = isCari ? "Cari Fiş Listesi" : "Satış Fiş Listesi";
            if (lblSalesListButton) lblSalesListButton.textContent = isCari ? "Cari Listesi" : "Satış Listesi";
          }

          function applyMode(isCari) {
            document.body.classList.toggle("cari-active", isCari);
            document.body.classList.toggle("satis-active", !isCari);
            if (receiptTitle) receiptTitle.textContent = isCari ? "Cari Fişi" : "Satış Fişi";
            setButtonLabels(isCari);
            fillHiddenFields();
          }

          function hasAnyReceiptData() {
            return (state.items?.length || 0) > 0 || (state.movements?.length || 0) > 0;
          }

          function clearReceiptState() {
            state.items = [];
            state.movements = [];
            state.edit = { kind: null, index: null };
            state.currentCashOperation = "GIRIS";
            closeAllModals();
            rerenderReceipt();
          }

          if (toggleMode) {
            if (!document.body.classList.contains("satis-active") && !document.body.classList.contains("cari-active")) {
              document.body.classList.add("satis-active");
            }

            applyMode(toggleMode.checked);

            toggleMode.addEventListener("change", (e) => {
              const wantCari = e.target.checked;
              const wasCari = document.body.classList.contains("cari-active");
              const goingSalesToCari = (wasCari === false && wantCari === true);

              if (goingSalesToCari && hasAnyReceiptData()) {
                const ok = confirm("Yapılan işlemler kaybolacak. Devam etmek istiyor musunuz?");
                if (!ok) {
                  e.target.checked = false;
                  return;
                }
                clearReceiptState();
                applyMode(true);
                return;
              }

              applyMode(wantCari);
            });
          }

          // -----------------------------------
          // TRI TOGGLE helper (borcuna/alacagina)
          // -----------------------------------
          function wireTriToggle(toggleId, onChange) {
            const root = el(toggleId);
            if (!root) return null;
            if (root.dataset.wired === "1") return root;
            root.dataset.wired = "1";

            const slider = root.querySelector(".tri-toggle-slider");
            const options = Array.from(root.querySelectorAll(".tri-toggle-option"));

            const setSelected = (val) => {
              root.dataset.selected = val;
              root.setAttribute("data-selected", val);

              options.forEach((opt) => {
                const active = opt.dataset.value === val;
                opt.classList.toggle("active", active);

                // renkleri senin html’ine göre ayarla
                if (toggleId.includes("virman")) {
                  opt.style.color = active ? "rgb(5, 150, 105)" : "rgb(107, 114, 128)";
                } else {
                  opt.style.color = active ? "rgb(220, 38, 38)" : "rgb(107, 114, 128)";
                }
              });

              if (slider) {
                const idx = options.findIndex(o => o.dataset.value === val);
                slider.style.transform = `translateX(${Math.max(0, idx) * 100}%)`;
              }

              if (typeof onChange === "function") onChange(val);
            };

            root.addEventListener("click", (e) => {
              const opt = e.target.closest(".tri-toggle-option");
              if (!opt) return;
              e.preventDefault();
              setSelected(opt.dataset.value);
            });

            const initial = root.dataset.selected || root.getAttribute("data-selected") || "borcuna";
            setSelected(initial);
            root._setSelected = setSelected;

            return root;
          }

          function getTriToggleValue(toggleId) {
            const root = el(toggleId);
            return root?.dataset?.selected || root?.getAttribute("data-selected") || "borcuna";
          }

          function mapToggleToType(val) {
            // borcuna = (-) => CIKIS
            if (val === "borcuna") return "CIKIS";
            // alacagina = (+) => GIRIS
            return "GIRIS";
          }

          // -----------------------------------
          // NAKIT Modal
          // -----------------------------------
          const ntTabs = nakitModal ? Array.from(nakitModal.querySelectorAll(".nt-tab")) : [];
          const ntPanels = {
            kasalar: el("nt-tab-kasalar"),
            bankalar: el("nt-tab-bankalar"),
            poslar: el("nt-tab-poslar"),
          };

          const ntTutar = el("nt-tutar");
          const ntKur = el("nt-kur");
          const ntKarsilik = el("nt-karsilik");
          const ntBirim = el("nt-birim");

          function setActiveTab(tabName) {
            if (!nakitModal) return;
            ntTabs.forEach(t => {
              const isActive = (t.dataset.tab === tabName);
              t.classList.toggle("bg-white", isActive);
              t.classList.toggle("text-black", isActive);
              t.classList.toggle("text-gray-600", !isActive);
            });
            Object.entries(ntPanels).forEach(([name, panel]) => {
              if (!panel) return;
              panel.classList.toggle("hidden", name !== tabName);
            });
          }

          function getActiveTabName() {
            if (!nakitModal) return "kasalar";
            const active = nakitModal.querySelector(".nt-tab.bg-white");
            return active?.dataset?.tab ?? "kasalar";
          }

          function getSelectedAccountName(activeTab) {
            if (activeTab === "bankalar") return el("nt-banka")?.selectedOptions?.[0]?.textContent?.trim() || "BANKA";
            if (activeTab === "poslar") return el("nt-pos")?.selectedOptions?.[0]?.textContent?.trim() || "POS";
            return el("nt-kasa")?.selectedOptions?.[0]?.textContent?.trim() || "KASA";
          }

          function updateKarsilikLive() {
            if (!ntTutar || !ntKur || !ntKarsilik) return;
            const tutar = parseTrNumber(ntTutar.value);
            const kur = parseTrNumber(ntKur.value);
            ntKarsilik.textContent = fmt2.format(tutar * kur);
          }

          function makeEditableKarsilik() {
            if (!ntKarsilik) return;
            if (ntKarsilik.dataset.wired === "1") return;
            ntKarsilik.dataset.wired = "1";

            ntKarsilik.setAttribute("contenteditable", "true");
            ntKarsilik.style.outline = "none";

            ntKarsilik.addEventListener("input", () => {
              const before = ntKarsilik.textContent;
              const after = sanitizeNumericText(before);
              if (before !== after) ntKarsilik.textContent = after;
            });

            ntKarsilik.addEventListener("keydown", (e) => {
              if (e.key === "Enter") { e.preventDefault(); ntKarsilik.blur(); }
            });

            ntKarsilik.addEventListener("blur", () => {
              const n = parseTrNumber(ntKarsilik.textContent);
              ntKarsilik.textContent = fmt2.format(n);
            });
          }

          function openNakit(operationType) {
            if (!nakitModal) return;

            state.edit.kind = null;
            state.edit.index = null;
            state.currentCashOperation = operationType;

            const titleEl = el("nakit-modal-title");
            if (titleEl) titleEl.textContent = operationType === "GIRIS" ? "Nakit Tahsilat" : "Nakit Ödeme";

            el("nt-delete")?.classList.add("hidden");
            const submitBtn = el("nt-submit");
            if (submitBtn) submitBtn.innerHTML = `<i class="fas fa-check mr-2"></i>Ekle`;

            setActiveTab("kasalar");
            updateKarsilikLive();
            syncTotalsCurrencyOnly();
            Modal.open(nakitModal);
          }

          function openNakitEdit(index, item) {
            if (!nakitModal) return;

            state.edit.kind = "NAKIT";
            state.edit.index = index;
            state.currentCashOperation = item.type === "GIRIS" ? "GIRIS" : "CIKIS";

            const titleEl = el("nakit-modal-title");
            if (titleEl) titleEl.textContent = item.type === "GIRIS" ? "Nakit Giriş Güncelle" : "Nakit Çıkış Güncelle";

            el("nt-delete")?.classList.remove("hidden");
            const submitBtn = el("nt-submit");
            if (submitBtn) submitBtn.innerHTML = `<i class="fas fa-save mr-2"></i>Güncelle`;

            setActiveTab(item.tab || "kasalar");
            const tab = item.tab || "kasalar";
            if (tab === "kasalar") selectByText(el("nt-kasa"), item.hesapAdi);
            if (tab === "bankalar") selectByText(el("nt-banka"), item.hesapAdi);
            if (tab === "poslar") selectByText(el("nt-pos"), item.hesapAdi);

            if (ntBirim) selectByText(ntBirim, item.currency);
            if (ntTutar) ntTutar.value = fmt2.format(item.tutar || 0);
            if (ntKur) ntKur.value = fmt4.format(item.kur || 0);
            if (ntKarsilik) ntKarsilik.textContent = fmt2.format(item.karsilikTry || 0);

            syncTotalsCurrencyOnly();
            Modal.open(nakitModal);
          }

          // DTO (NAKİT için mevcut)
          function getSelectedAccountFromPosOrBank() {
            const tab = getActiveTabName();
            const kasaSel = el("nt-kasa");
            const bankaSel = el("nt-banka");
            const posSel = el("nt-pos");

            const pick = (selectEl) => {
              const val = (selectEl?.value || "").trim();
              if (!val || val === "0") return null;
              const id = safeNumber(val);
              if (id == null) return null;
              return { accountId: id, accountName: getSelectedText(selectEl) };
            };

            if (tab === "kasalar") return pick(kasaSel);
            if (tab === "bankalar") return pick(bankaSel);
            if (tab === "poslar") return pick(posSel);
            return pick(kasaSel) || pick(posSel) || pick(bankaSel);
          }

          function buildCashMovementDto(transactionTypeId) {
            const customerSel = el("customer-select");
            const customerAccountId = safeNumber(customerSel?.value || 0) || 0;
            const customerName = getSelectedText(customerSel);

            const cashAccount = getSelectedAccountFromPosOrBank();
            if (!cashAccount) {
              alert("Lütfen seçili sekmeden bir hesap seçiniz (Kasa / Banka / POS).");
              return null;
            }

            const counterSel = el("currency-select");
            const foreignSel = el("nt-birim");

            const counterCurrencyId = safeNumber(counterSel?.value);
            const foreignCurrencyId = safeNumber(foreignSel?.value);

            if (counterCurrencyId == null) { alert("Ana para birimi seçimi bulunamadı."); return null; }
            if (foreignCurrencyId == null) { alert("Nakit para birimi seçimi bulunamadı."); return null; }

            const foreignCurrencyAmount = parseDecimalTr(ntTutar?.value);
            const foreignExchangeRate = parseDecimalTr(ntKur?.value);
            const counterCurrencyAmount = parseDecimalTr(ntKarsilik?.textContent);

            const counterExchangeRate = 1;

            const description =
              transactionTypeId === 1
                ? `Finansal Hesap: ${cashAccount.accountName} - Nakit Giriş`
                : `Karşı Hesap: ${cashAccount.accountName} - Nakit Çıkış`;

            return {
              transactionTypeId,
              accountId: customerAccountId,
              stockId: null,
              description,
              foreignCurrencyAmount,
              foreignCurrencyId,
              foreignExchangeRate,
              counterCurrencyAmount,
              counterCurrencyId,
              counterExchangeRate
            };
          }

          wireTrMoneyInput(ntTutar, 2);
          wireTrMoneyInput(ntKur, 4);
          makeEditableKarsilik();
          ntTutar?.addEventListener("input", updateKarsilikLive);
          ntKur?.addEventListener("input", updateKarsilikLive);

          el("nt-submit")?.addEventListener("click", (e) => {
            e.preventDefault();

            const activeTab = getActiveTabName();
            const hesapAdi = getSelectedAccountName(activeTab);

            const currency = ntBirim?.selectedOptions?.[0]?.textContent?.trim() || "TRY";
            const tutar = parseTrNumber(ntTutar?.value);
            const kur = parseTrNumber(ntKur?.value);
            const karsilikTry = parseTrNumber(ntKarsilik?.textContent);

            const uiItem = { kind: "NAKIT", type: state.currentCashOperation, currency, tutar, kur, karsilikTry, hesapAdi, tab: activeTab };
            const transactionTypeId = (state.currentCashOperation === "GIRIS") ? 1 : 2;
            const dto = buildCashMovementDto(transactionTypeId);
            if (!dto) return;

            if (state.edit.kind === "NAKIT" && Number.isFinite(state.edit.index)) {
              const i = state.edit.index;
              state.items[i] = uiItem;
              state.movements[i] = dto;
              state.edit.kind = null;
              state.edit.index = null;
              rerenderReceipt();
              Modal.close(nakitModal);
              return;
            }

            state.items.push(uiItem);
            state.movements.push(dto);
            rerenderReceipt();
            Modal.close(nakitModal);
          });

          el("nt-delete")?.addEventListener("click", (e) => {
            e.preventDefault();
            if (!(state.edit.kind === "NAKIT" && Number.isFinite(state.edit.index))) {
              Modal.close(nakitModal);
              return;
            }
            const i = state.edit.index;
            state.items.splice(i, 1);
            state.movements.splice(i, 1);
            state.edit.kind = null;
            state.edit.index = null;
            rerenderReceipt();
            Modal.close(nakitModal);
          });

          el("nakit-tahsilat-close")?.addEventListener("click", () => Modal.close(nakitModal));
          el("nt-cancel")?.addEventListener("click", () => Modal.close(nakitModal));
          el("error-modal-cancel")?.addEventListener("click", () => Modal.close(errorsModal));

          ntTabs.forEach(t => t.addEventListener("click", (e) => {
            e.preventDefault();
            setActiveTab(t.dataset.tab);
          }));

          // -----------------------------------
          // İSKONTO
          // -----------------------------------
          wireTriToggle("iskonto-tipi-toggle");

          const iskAmount = el("form-iskonto-amount");
          const iskRate   = el("form-iskonto-rate");
          const iskCurr   = el("form-iskonto-currency");
          const iskKarsi  = el("form-iskonto-karsi-hesap");
          const iskHasAmt = el("form-iskonto-equiv-amount");
          const iskHasRate= el("form-iskonto-equiv-rate");
          const iskAcik   = el("form-iskonto-aciklama");

          wireTrMoneyInput(iskAmount, 2);
          wireTrMoneyInput(iskRate, 4);

          function openIskontoForCreate() {
            state.edit.kind = null;
            state.edit.index = null;
            el("iskonto-tipi-toggle")?._setSelected?.("borcuna");

            el("iskonto-delete-button")?.classList.add("hidden");
            const btn = el("iskonto-add-button");
            if (btn) btn.innerHTML = `<i class="fas fa-check mr-1.5"></i>Ekle`;

            Modal.open(iskontoModal);
          }

          function openIskontoForEdit(index) {
            const item = state.items[index];
            if (!item || item.kind !== "ISKONTO") return;

            state.edit.kind = "ISKONTO";
            state.edit.index = index;

            const toggleVal = (item.type === "GIRIS") ? "alacagina" : "borcuna";
            el("iskonto-tipi-toggle")?._setSelected?.(toggleVal);

            if (iskAmount) iskAmount.value = fmt2.format(item.amount || 0);
            if (iskRate) iskRate.value = fmt4.format(item.rate || 1);

            if (iskCurr) selectByText(iskCurr, item.currency);
            if (iskKarsi) iskKarsi.value = item.karsiHesapAdi || iskKarsi.value || "";

            if (iskHasAmt) iskHasAmt.value = fmt2.format(item.hasAmount || 0);
            if (iskHasRate) iskHasRate.value = fmt4.format(item.hasRate || 0);
            if (iskAcik) iskAcik.value = item.aciklama || "";

            el("iskonto-delete-button")?.classList.remove("hidden");
            const btn = el("iskonto-add-button");
            if (btn) btn.innerHTML = `<i class="fas fa-check mr-1.5"></i>Güncelle`;

            Modal.open(iskontoModal);
          }

          function buildIskontoUiItem() {
            const toggleVal = getTriToggleValue("iskonto-tipi-toggle");
            const type = mapToggleToType(toggleVal);

            const currencyText = iskCurr?.selectedOptions?.[0]?.textContent?.trim() || "TRY";
            const amount = parseTrNumber(iskAmount?.value);
            const rate = parseTrNumber(iskRate?.value);
            const karsilikTry = amount * rate;

            return {
              kind: "ISKONTO",
              type,
              currency: currencyText,
              amount,
              rate,
              karsilikTry,
              karsiHesapAdi: iskKarsi?.value || "İSKONTO",
              hasAmount: parseTrNumber(iskHasAmt?.value),
              hasRate: parseTrNumber(iskHasRate?.value),
              aciklama: iskAcik?.value || ""
            };
          }

          el("iskonto-add-button")?.addEventListener("click", (e) => {
            e.preventDefault();
            const uiItem = buildIskontoUiItem();

            if (state.edit.kind === "ISKONTO" && Number.isFinite(state.edit.index)) {
              state.items[state.edit.index] = uiItem;
              // movements DTO gerekiyorsa sonra ekleriz
            } else {
              state.items.push(uiItem);
            }

            rerenderReceipt();
            Modal.close(iskontoModal);
          });

          el("iskonto-delete-button")?.addEventListener("click", (e) => {
            e.preventDefault();
            if (state.edit.kind !== "ISKONTO") return;
            const i = state.edit.index;
            if (!Number.isFinite(i)) return;

            state.items.splice(i, 1);
            state.edit.kind = null;
            state.edit.index = null;

            rerenderReceipt();
            Modal.close(iskontoModal);
          });

          // -----------------------------------
          // VİRMAN
          // -----------------------------------
          wireTriToggle("virman-tipi-toggle");

          const virAmount = el("form-virman-amount");
          const virRate   = el("form-virman-rate");
          const virCurr   = el("form-virman-currency");
          const virKarsi  = el("form-virman-karsi-hesap");
          const virAcik   = el("form-virman-aciklama");

          wireTrMoneyInput(virAmount, 2);
          wireTrMoneyInput(virRate, 4);

          function openVirmanForCreate() {
            state.edit.kind = null;
            state.edit.index = null;

            el("virman-tipi-toggle")?._setSelected?.("alacagina");
            el("virman-delete-button")?.classList.add("hidden");

            const btn = el("virman-add-button");
            if (btn) btn.innerHTML = `<i class="fas fa-check mr-1.5"></i>Ekle`;

            Modal.open(virmanModal);
          }

          function openVirmanForEdit(index) {
            const item = state.items[index];
            if (!item || item.kind !== "VIRMAN") return;

            state.edit.kind = "VIRMAN";
            state.edit.index = index;

            el("virman-tipi-toggle")?._setSelected?.(item.toggleVal || "alacagina");

            if (virAmount) virAmount.value = fmt2.format(item.amount || 0);
            if (virRate) virRate.value = fmt4.format(item.rate || 1);

            if (virAcik) virAcik.value = item.aciklama || "";

            el("virman-delete-button")?.classList.remove("hidden");
            const btn = el("virman-add-button");
            if (btn) btn.innerHTML = `<i class="fas fa-check mr-1.5"></i>Güncelle`;

            Modal.open(virmanModal);
          }

          function buildVirmanUiItem() {
            const toggleVal = getTriToggleValue("virman-tipi-toggle");
            const currencyText = virCurr?.selectedOptions?.[0]?.textContent?.trim() || "TRY";
            const amount = parseTrNumber(virAmount?.value);
            const rate = parseTrNumber(virRate?.value);
            const karsilikTry = amount * rate;
            const toName = virKarsi?.selectedOptions?.[0]?.textContent?.trim() || "KARŞI HESAP";

            return {
              kind: "VIRMAN",
              toggleVal,
              currency: currencyText,
              amount,
              rate,
              karsilikTry,
              from: "ANA HESAP",
              to: toName,
              aciklama: virAcik?.value || ""
            };
          }

          el("virman-add-button")?.addEventListener("click", (e) => {
            e.preventDefault();
            const uiItem = buildVirmanUiItem();

            if (state.edit.kind === "VIRMAN" && Number.isFinite(state.edit.index)) {
              state.items[state.edit.index] = uiItem;
            } else {
              state.items.push(uiItem);
            }

            rerenderReceipt();
            Modal.close(virmanModal);
          });

          el("virman-delete-button")?.addEventListener("click", (e) => {
            e.preventDefault();
            if (state.edit.kind !== "VIRMAN") return;
            const i = state.edit.index;
            if (!Number.isFinite(i)) return;

            state.items.splice(i, 1);
            state.edit.kind = null;
            state.edit.index = null;

            rerenderReceipt();
            Modal.close(virmanModal);
          });

          // -----------------------------------
          // AÇIK HESAP
          // -----------------------------------
          wireTriToggle("acikhesap-tipi-toggle");

          const ahAmount = el("form-acikhesap-amount");
          const ahRate   = el("form-acikhesap-rate");

          wireTrMoneyInput(ahAmount, 2);
          wireTrMoneyInput(ahRate, 4);

          function openAcikHesapForCreate() {
            state.edit.kind = null;
            state.edit.index = null;

            el("acikhesap-tipi-toggle")?._setSelected?.("borcuna");
            el("acik-hesap-delete-button")?.classList.add("hidden");

            const btn = el("acik-hesap-add-button");
            if (btn) btn.innerHTML = `<i class="fas fa-check mr-1.5"></i>Ekle`;

            Modal.open(acikModal);
          }

          function openAcikHesapForEdit(index) {
            const item = state.items[index];
            if (!item || item.kind !== "ACIK_HESAP") return;

            state.edit.kind = "ACIK_HESAP";
            state.edit.index = index;

            const toggleVal = (item.type === "GIRIS") ? "alacagina" : "borcuna";
            el("acikhesap-tipi-toggle")?._setSelected?.(toggleVal);

            if (ahAmount) ahAmount.value = fmt2.format(item.amount || 0);
            if (ahRate) ahRate.value = fmt4.format(item.rate || 1);

            el("acik-hesap-delete-button")?.classList.remove("hidden");
            const btn = el("acik-hesap-add-button");
            if (btn) btn.innerHTML = `<i class="fas fa-check mr-1.5"></i>Güncelle`;

            Modal.open(acikModal);
          }

          function buildAcikHesapUiItem() {
            const toggleVal = getTriToggleValue("acikhesap-tipi-toggle");
            const type = mapToggleToType(toggleVal);

            const amount = parseTrNumber(ahAmount?.value);
            const rate = parseTrNumber(ahRate?.value);

            return {
              kind: "ACIK_HESAP",
              type,
              amount,
              rate,
              karsiHesapAdi: "Açık Hesap",
              aciklama: ""
            };
          }

          el("acik-hesap-add-button")?.addEventListener("click", (e) => {
            e.preventDefault();
            const uiItem = buildAcikHesapUiItem();

            if (state.edit.kind === "ACIK_HESAP" && Number.isFinite(state.edit.index)) {
              state.items[state.edit.index] = uiItem;
            } else {
              state.items.push(uiItem);
            }

            rerenderReceipt();
            Modal.close(acikModal);
          });

          el("acik-hesap-delete-button")?.addEventListener("click", (e) => {
            e.preventDefault();
            if (state.edit.kind !== "ACIK_HESAP") return;
            const i = state.edit.index;
            if (!Number.isFinite(i)) return;

            state.items.splice(i, 1);
            state.edit.kind = null;
            state.edit.index = null;

            rerenderReceipt();
            Modal.close(acikModal);
          });

          // -----------------------------------
          // Receipt satır tıklayınca edit
          // -----------------------------------
          if (receiptLog) {
            receiptLog.addEventListener("click", (e) => {
              const row = e.target.closest("[data-receipt-item='1']");
              if (!row) return;

              const index = Number(row.dataset.index);
              const kind = row.dataset.kind;
              if (!Number.isFinite(index)) return;

              const item = state.items[index];
              if (!item) return;

              if (kind === "NAKIT") return openNakitEdit(index, item);
              if (kind === "ISKONTO") return openIskontoForEdit(index);
              if (kind === "VIRMAN") return openVirmanForEdit(index);
              if (kind === "ACIK_HESAP") return openAcikHesapForEdit(index);
            });
          }

          // -----------------------------------
          // Top bar buttons + modal open
          // -----------------------------------
          document.addEventListener("click", (e) => {
            const t = e.target;

            if (t.closest("#btn-nakit-tahsilat")) { e.preventDefault(); return openNakit("GIRIS"); }
            if (t.closest("#btn-nakit-odeme")) { e.preventDefault(); return openNakit("CIKIS"); }

            if (t.closest("#btn-iskonto")) { e.preventDefault(); return openIskontoForCreate(); }
            if (t.closest("#btn-virman")) { e.preventDefault(); return openVirmanForCreate(); }
            if (t.closest("#btn-acik-hesap")) { e.preventDefault(); return openAcikHesapForCreate(); }

            if (t.closest("#ekstre-button")) { e.preventDefault(); Modal.open(ekstreModal); return; }
            if (t.closest("#sales-list-button")) { e.preventDefault(); Modal.open(fisListModal); return; }
          });

          // Close buttons
          el("iskonto-modal-close")?.addEventListener("click", (e) => { e.preventDefault(); Modal.close(iskontoModal); });
          el("iskonto-cancel-button")?.addEventListener("click", (e) => { e.preventDefault(); Modal.close(iskontoModal); });

          el("virman-close")?.addEventListener("click", (e) => { e.preventDefault(); Modal.close(virmanModal); });
          el("virman-cancel-button")?.addEventListener("click", (e) => { e.preventDefault(); Modal.close(virmanModal); });

          el("acik-hesap-close")?.addEventListener("click", (e) => { e.preventDefault(); Modal.close(acikModal); });
          el("acik-hesap-cancel")?.addEventListener("click", (e) => { e.preventDefault(); Modal.close(acikModal); });

          el("ekstre-modal-close-button")?.addEventListener("click", (e) => { e.preventDefault(); Modal.close(ekstreModal); });
          el("fis-list-modal-close-button")?.addEventListener("click", (e) => { e.preventDefault(); Modal.close(fisListModal); });



         const isSalesMode = document.body.classList.contains("satis-active");

          // Currency label sync
          currencySelect?.addEventListener("change", syncTotalsCurrencyOnly);

                  // modal aç / kapa
        function openConfirmModal(message) {
          if (!confirmModal) return;
          if (confirmMsg) confirmMsg.textContent = message;
          confirmModal.classList.remove("hidden");
          document.body.classList.add("overflow-hidden");
        }

        function closeConfirmModal() {
          if (!confirmModal) return;
          confirmModal.classList.add("hidden");
          document.body.classList.remove("overflow-hidden");
        }

        // fiş datası var mı?
        function hasReceiptData() {
          return (window.state?.items?.length || 0) > 0 ||
                 (window.state?.movements?.length || 0) > 0;
        }

         function fillEkstreHeader(apiResponse) {
          // apiResponse: { data: [ { ... } ], statusCode, isSuccess, errors }

          const elName = document.getElementById("ekstre-hesap-adi");
          const elType = document.getElementById("ekstre-hesap-tipi");
          const elId   = document.getElementById("ekstre-hesap-id");

          if (!apiResponse || apiResponse.isSuccess !== true) {
            if (elName) elName.textContent = "-";
            if (elType) elType.textContent = "Hesap Tipi: -";
            if (elId)   elId.textContent = "Müşteri No: -";
            return;
          }

          const first = Array.isArray(apiResponse.data) ? apiResponse.data[0] : null;
          if (!first) {
            if (elName) elName.textContent = "-";
            if (elType) elType.textContent = "Hesap Tipi: -";
            if (elId)   elId.textContent = "Müşteri No: -";
            return;
          }

          const accountName = first.accountName ?? "-";
          const accountTypeName = first.accountTypeName ?? "-";

          // ⚠️ Burada karar:
          // - "Müşteri No" genelde accountId olur
          // - first.id ise receiptId (fiş id)
          const customerNo = first.accountId ?? first.id ?? "-";

          if (elName) {
            elName.textContent = accountName;
            elName.title = accountName;
          }

          if (elType) {
            elType.textContent = `Hesap Tipi: ${accountTypeName}`;
          }

          if (elId) {
            elId.textContent = `Müşteri No: ${customerNo}`;
          }
        }

        // FİŞİ TAMAMEN TEMİZLE
        function clearReceiptAll() {
          if (!window.state) return;

          window.state.items = [];
          window.state.movements = [];
          window.state.edit = { kind: null, index: null };
          window.state.currentCashOperation = "GIRIS";

          // UI temizle
          if (typeof rerenderReceipt === "function") rerenderReceipt();

          // totals sıfırla (güvenli)
          try {
            setTotal("giren-toplam", "giren-toplam-amount", "giren-toplam-currency", "0,00");
            setTotal("cikan-toplam", "cikan-toplam-amount", "cikan-toplam-currency", "0,00");
            setTotal("fark-toplam", "fark-amount", "fark-currency", "0,00");
          } catch {}

          closeConfirmModal();
        }

        // SIL BUTONU CLICK
        function handleDeleteClick(e) {
          e.preventDefault();

          if (!hasReceiptData()) return; // data yoksa hiçbir şey yapma

          openConfirmModal(
            "Fiş içerisindeki tüm işlemler silinecek. Devam etmek istiyor musunuz?"
          );
        }

        deleteBtn?.addEventListener("click", handleDeleteClick);
        deleteBtnMobile?.addEventListener("click", handleDeleteClick);

        // MODAL BUTTONS
        confirmNo?.addEventListener("click", (e) => {
          e.preventDefault();
          closeConfirmModal();
        });

        confirmYes?.addEventListener("click", (e) => {
          e.preventDefault();
          clearReceiptAll();
        });

        // backdrop tıklayınca kapansın
        confirmModal?.addEventListener("click", (e) => {
          if (e.target === confirmModal) closeConfirmModal();
        });

         function renderEkstreMovements(apiResponse) {
          const container = document.getElementById("ekstre-content");
          if (!container) return;

          // temizle
          container.innerHTML = "";

          const first = Array.isArray(apiResponse?.data) ? apiResponse.data[0] : null;
          const list = first?.getMovementByCustomerIdResponses || [];

          // liste yoksa mesaj bas
          if (!Array.isArray(list) || list.length === 0) {
            container.innerHTML = `<div class="text-gray-500 text-sm">Kayıt bulunamadı.</div>`;
            return;
          }

          // Giriş / Çıkış transactionTypeId setleri
          const girisSet = new Set([1, 3, 5, 7, 9]);
          const cikisSet = new Set([2, 4, 6, 8, 10]);

          // list wrapper
          const wrap = document.createElement("div");
          wrap.className = "ekstre-list-container";

          // yardımcı formatlar (senin fmt2/fmt4 varsa onları kullan)
          const fmt2 = new Intl.NumberFormat("tr-TR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
          const fmt4 = new Intl.NumberFormat("tr-TR", { minimumFractionDigits: 4, maximumFractionDigits: 4 });

          const formatDateTR = (iso) => {
            if (!iso) return "";
            const d = new Date(iso);
            if (Number.isNaN(d.getTime())) return iso;
            const pad = (n) => String(n).padStart(2, "0");
            return `${pad(d.getDate())}.${pad(d.getMonth() + 1)}.${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
          };

          // Basit bakiye hesap (EB/SB): counterCurrencyCode bazında yürütür
          // İstersen currency bazlı farklı bakiyeler tutarız, ama şimdilik tek currency üzerinden.
          const balances = {}; // { "HAS": 0, "EUR": 0, ... }

          const getBal = (code) => balances[code] ?? 0;
          const setBal = (code, val) => { balances[code] = val; };

          list.forEach((m) => {
            const tId = Number(m.transactionTypeId);
            const isGiris = girisSet.has(tId);
            const isCikis = cikisSet.has(tId);

            // bilinmeyen type: geç
            if (!isGiris && !isCikis) return;

            const transactionName = m.transactionName ?? "";
            const receiptDate = formatDateTR(first?.receiptDate); // sen örnekte receiptDate üst objede
            // Eğer movement bazlı tarih varsa: formatDateTR(m.receiptDate)

            const foreignAmount = Number(m.foreignCurrencyAmount ?? 0);
            const foreignCode = m.foreignCurrencyCode ?? "";
            const foreignRate = Number(m.foreignExchangeRate ?? 0);

            const counterAmount = Number(m.counterCurrencyAmount ?? 0);
            const counterCode = m.counterCurrencyCode ?? "";
            const counterRate = Number(m.counterExchangeRate ?? 0);

            // EB/SB hesabı: counter currency üstünden
            const eb = getBal(counterCode);
            const sb = isGiris ? (eb + counterAmount) : (eb - counterAmount);
            setBal(counterCode, sb);

            const row = document.createElement("div");
            row.className = `ekstre-item ${isGiris ? "ekstre-item-giris" : "ekstre-item-cikis"}`;
            row.setAttribute("data-balances", JSON.stringify({ [counterCode]: sb }));

            // sign
            const sign = isGiris ? "+" : "-";
            const titleColor = isGiris ? "text-green-600" : "text-red-600";

            row.innerHTML = `
              <div style="display: contents;">
                <div class="ekstre-v3-sol">
                  <span class="baslik ${titleColor}">${transactionName}</span>
                  <span class="tarih">${receiptDate}</span>
                </div>

                <div class="ekstre-v3-orta">
                  <div class="ekstre-v3-detay-grup">
                    <span class="font-semibold text-sm">${sign}${fmt2.format(foreignAmount)} ${foreignCode}</span>
                    <span class="text-xs text-gray-600">Kur: ${fmt4.format(foreignRate)}</span>
                  </div>
                  <div class="ekstre-v3-detay-grup">
                    <span class="font-semibold text-sm">${fmt2.format(counterAmount)} ${counterCode}</span>
                    <span class="text-xs text-gray-600">Kur: ${fmt4.format(counterRate)}</span>
                  </div>
                </div>
              </div>

              <div class="ekstre-blok-sag">
                <div class="bakiye-grup">
                  <span class="eski-bakiye">EB: ${fmt2.format(eb)} ${counterCode}</span>
                  <span class="son-bakiye">SB: ${fmt2.format(sb)} ${counterCode}</span>
                </div>

                <div class="flex flex-col items-center">
                  <span class="hareket-id">ID:${m.id}</span>
                  <label class="mutabakat-switch">
                    <input type="checkbox" id="mutabakat-${m.id}">
                    <span class="mutabakat-slider"></span>
                  </label>
                </div>

                <div class="ml-2">
                  <button class="edit-ekstre-fis-btn bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-md hover:bg-blue-200"
                          data-fis-id="${m.receiptId ?? ""}">
                    <i class="fas fa-pencil-alt"></i>
                  </button>
                </div>
              </div>
            `;

            wrap.appendChild(row);
          });

          container.appendChild(wrap);
        }

          // -------------------------------------------------
         // EKSTRE GETİR (POST: /Receipt/GetEkstreByCustomerIdAndDate)
        // -------------------------------------------------
        (function wireEkstreFetch() {
          const btn = document.getElementById("ekstre-getir-button");
          const startInp = document.getElementById("ekstre-baslangic-tarihi");
          const endInp = document.getElementById("ekstre-bitis-tarihi");
          const customerSel = document.getElementById("customer-select");

          if (!btn || !startInp || !endInp || !customerSel) return;

          // date input (yyyy-mm-dd) => "yyyy-mm-ddT00:00:00"
          function toDateTimeString(dateStr, endOfDay) {
            if (!dateStr) return null;
            return endOfDay ? `${dateStr}T23:59:59` : `${dateStr}T00:00:00`;
          }

          function getSelectedCustomerId() {
            const v = (customerSel.value || "").trim();
            const id = Number(v);
            return Number.isFinite(id) ? id : null;
          }

          btn.addEventListener("click", async (e) => {
            e.preventDefault();

            const customerId = getSelectedCustomerId();
            const startDateRaw = startInp.value; // yyyy-mm-dd
            const endDateRaw = endInp.value;     // yyyy-mm-dd

            if (!customerId) {
              alert("Lütfen müşteri seçiniz.");
              return;
            }
            if (!startDateRaw || !endDateRaw) {
              alert("Lütfen başlangıç ve bitiş tarihlerini seçiniz.");
              return;
            }
            if (startDateRaw > endDateRaw) {
              alert("Başlangıç tarihi, bitiş tarihinden büyük olamaz.");
              return;
            }

            const payload = {
              CustomerId: customerId,
              StartDate: toDateTimeString(startDateRaw, false),
              EndDate: toDateTimeString(endDateRaw, true),
            };

            try {
              // (opsiyonel) loading overlay varsa aç
              document.getElementById("loading-overlay")?.classList.remove("hidden");

              const res = await fetch("/Receipt/GetEkstreByCustomerIdAndDate", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "Accept": "application/json",
                  // ASP.NET Core Anti-forgery kullanıyorsan buraya token eklemelisin (aşağıya not yazdım)
                },
                body: JSON.stringify(payload),
              });

              if (!res.ok) {
                const txt = await res.text().catch(() => "");
                throw new Error(`HTTP ${res.status} - ${txt}`);
              }

              const data = await res.json();
              fillEkstreHeader(data);
              renderEkstreMovements(data);


            } catch (err) {
              console.error(err);
              alert("Ekstre alınırken hata oluştu.");
            } finally {
              document.getElementById("loading-overlay")?.classList.add("hidden");
            }
          });

          // güvenli pre render için
          function escapeHtml(s) {
            return String(s)
              .replaceAll("&", "&amp;")
              .replaceAll("<", "&lt;")
              .replaceAll(">", "&gt;")
              .replaceAll('"', "&quot;")
              .replaceAll("'", "&#039;");
          }
        })();







          // INIT totals
          setTotal("giren-toplam", "giren-toplam-amount", "giren-toplam-currency", "0,00");
          setTotal("cikan-toplam", "cikan-toplam-amount", "cikan-toplam-currency", "0,00");
          setTotal("fark-toplam", "fark-amount", "fark-currency", "0,00");

          syncTotalsCurrencyOnly();
          rerenderReceipt();

          console.log("✅ script çalıştı (single js)");
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", () => {
          const filterBtn = document.getElementById("fis-list-filter-button");
          const customerSelect = document.getElementById("fis-list-customer-filter");
          const startDateInput = document.getElementById("fis-list-start-date");
          const endDateInput = document.getElementById("fis-list-end-date");
          const listContent = document.getElementById("fis-list-content");

          if (!filterBtn || !customerSelect || !startDateInput || !endDateInput || !listContent) return;

          // ISO tarih (yyyy-MM-dd) -> TR format (dd.MM.yyyy HH:mm)
          function formatDateTR(dateStr) {
            if (!dateStr) return "";
            const d = new Date(dateStr);
            if (isNaN(d.getTime())) return dateStr;

            const pad = (n) => String(n).padStart(2, "0");
            const dd = pad(d.getDate());
            const mm = pad(d.getMonth() + 1);
            const yyyy = d.getFullYear();
            const hh = pad(d.getHours());
            const mi = pad(d.getMinutes());
            return `${dd}.${mm}.${yyyy} ${hh}:${mi}`;
          }

          function escapeHtml(str) {
            if (str === null || str === undefined) return "";
            return String(str)
              .replaceAll("&", "&amp;")
              .replaceAll("<", "&lt;")
              .replaceAll(">", "&gt;")
              .replaceAll('"', "&quot;")
              .replaceAll("'", "&#039;");
          }

          function renderFisList(receipts) {
            if (!Array.isArray(receipts) || receipts.length === 0) {
              listContent.innerHTML = `
                <div class="p-4 text-sm text-gray-500">Kayıt bulunamadı.</div>
              `;
              return;
            }

            const itemsHtml = receipts.map((r) => {
              const id = r.id ?? "";
              const receiptDate = formatDateTR(r.receiptDate);
              const accountName = escapeHtml(r.accountName ?? "");
              const receiptNumber = escapeHtml(r.receiptNumber ?? "");

              return `
                <div class="ekstre-item fis-list-item flex items-center gap-3 p-3 border border-gray-200 rounded-lg mb-2 hover:bg-gray-50"
                     data-fis-id="${id}">
                  <span class="font-mono text-gray-600 w-36 flex-shrink-0">${escapeHtml(receiptDate)}</span>
                  <span class="font-mono text-gray-500 w-20 flex-shrink-0">#${id}</span>
                  <span class="font-semibold text-gray-800 flex-grow truncate" title="${accountName}">${accountName}</span>
                  <span class="font-mono text-gray-700 w-40 flex-shrink-0">${receiptNumber}</span>
                  <div class="ml-auto">
                    <button class="edit-fis-btn bg-blue-100 text-blue-800 text-xs font-semibold px-3 py-1 rounded-md hover:bg-blue-200"
                            data-fis-id="${id}">
                      <i class="fas fa-pencil-alt"></i>
                    </button>
                  </div>
                </div>
              `;
            }).join("");

            listContent.innerHTML = `<div class="ekstre-list-container p-2">${itemsHtml}</div>`;
          }

          filterBtn.addEventListener("click", async () => {
            const customerId = parseInt(customerSelect.value || "0", 10);
            const startDate = startDateInput.value; // yyyy-MM-dd
            const endDate = endDateInput.value;     // yyyy-MM-dd

            if (!customerId) {
              alert("Lütfen Hesap seçin.");
              return;
            }
            if (!startDate || !endDate) {
              alert("Lütfen başlangıç ve bitiş tarihini seçin.");
              return;
            }

            // küçük bir loading
            listContent.innerHTML = `<div class="p-4 text-sm text-gray-500">Yükleniyor...</div>`;

            // ASP.NET MVC model binder için ISO string göndermek en temiz yöntem:
            // "2026-02-04" -> "2026-02-04T00:00:00"
            const payload = {
              CustomerId: customerId,
              StartDate: startDate + "T00:00:00",
              EndDate: endDate + "T23:59:59"
            };

            try {
              const res = await fetch("/Receipt/GetEkstreByCustomerIdAndDate", {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "Accept": "application/json"
                },
                body: JSON.stringify(payload)
              });

              if (!res.ok) {
                const txt = await res.text();
                console.error("HTTP Error:", res.status, txt);
                listContent.innerHTML = `<div class="p-4 text-sm text-red-600">İstek başarısız: ${res.status}</div>`;
                return;
              }

              const json = await res.json();

              // Senin response: { data: [...], isSuccess: true, ... }
              const receipts = Array.isArray(json?.data) ? json.data : [];
              // getMovementByCustomerIdResponses'u umursamıyoruz, zaten receipt seviyesinde basıyoruz
              renderFisList(receipts);

            } catch (err) {
              console.error(err);
              listContent.innerHTML = `<div class="p-4 text-sm text-red-600">Bir hata oluştu.</div>`;
            }
          });

          // (Opsiyonel) Edit butonlarına event delegation (dinamik elemanlar için)
          listContent.addEventListener("click", (e) => {
            const btn = e.target.closest(".edit-fis-btn");
            if (!btn) return;

            const fisId = btn.dataset.fisId;
            console.log("Edit fis:", fisId);
            // burada senin edit akışın neyse çağırırsın (modal kapat, fişi yükle vs.)
          });
        });

          function openErrorModal(message) {
          const errorModal = document.getElementById("error-modal");
          const errorMessageEl = document.getElementById("error-modal-message"); // sende farklıysa id'yi düzelt
          const cancelBtn = document.getElementById("error-modal-cancel");

          if (errorMessageEl) errorMessageEl.textContent = message;

          if (errorModal) errorModal.classList.remove("hidden");

          // Vazgeç -> kapat
          if (cancelBtn) {
            cancelBtn.onclick = () => {
              if (errorModal) errorModal.classList.add("hidden");
            };
          }
        }

                     document.addEventListener("click", (e) => {
          const btn = e.target.closest("#btnSave");
          if (!btn) return;

          const girenEl = document.getElementById("giren-toplam-amount");

          // Eğer cari modda bu span farklıysa / yoksa burada yakalarız
          const rawText = (girenEl?.textContent || "0").trim();

          const normalized = rawText
            .replace(/\./g, "")   // binlik ayırıcı
            .replace(",", ".");   // ondalık

          const girenToplam = parseFloat(normalized) || 0;

          if (girenToplam === 0) {
            e.preventDefault();
            e.stopPropagation();

            openErrorModal("Uyarı\nFiş boş, kaydedilecek bir işlem yok.");
            return;
          }

          // boş değilse akış devam
        }, true); // <- capture: bazı framework/handlerlar stopPropagation yaparsa bile yakalasın diye



    </script>
    <script>

                document.addEventListener("DOMContentLoaded", () => {
            const ntBirim = document.getElementById("nt-birim");
            const ntKur = document.getElementById("nt-kur");

            if (!ntBirim || !ntKur) return;

            // 🔹 Para birimi id → code eşlemesi
            const currencyMap = {
                1: "HAS",
                2: "USD",
                3: "TRY",
                4: "EUR",
                5: "CHF",
                6: "SAR",
                7: "GHS"
            };

            // 🔹 Modal ilk açıldığında TRY seçili olsun
            ntBirim.value = "3";
            ntKur.value = "1,0000"; // TRY → TRY her zaman 1

            // 🔹 Para birimi değişince anlık kur çek
            ntBirim.addEventListener("change", async () => {
                const currencyId = Number(ntBirim.value);
                const code = currencyMap[currencyId];

                if (!code) return;

                // TRY seçilirse API'ye gitme
                if (code === "TRY") {
                    ntKur.value = "1,0000";
                    return;
                }

                try {
                    const response = await fetch(`/Cure/GetLastCure/${currencyId}`, {
                        method: "GET",
                        headers: {
                            "Accept": "application/json"
                        }
                    });

                    if (!response.ok) {
                        throw new Error("Kur bilgisi alınamadı");
                    }

                    const rate = await response.json(); // double geliyor

                    // 4 haneli format
                    ntKur.value = Number(rate).toFixed(4).replace(".", ",");

                } catch (err) {
                    console.error("Kur çekme hatası:", err);
                    ntKur.value = "0,0000";
                }
            });
        });



    </script>




}



















