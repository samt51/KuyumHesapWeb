@using KuyumHesapWeb.Core.Commond.Models.Dtos
@model GetAllAccountResponseDto
@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<!DOCTYPE html>
<html lang="tr">
<head>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/slim-select/2.8.2/slimselect.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/slim-select/2.8.2/slimselect.min.js"></script>
    <style>
        .ekstre-list-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .ekstre-item.selected-ekstre-row {
            background-color: #e0f2fe; /* light blue */
            border-color: #0ea5e9;
            box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.4);
        }
        /* YENİ: Floating Label Stilleri */
        .float-label-container {
            position: relative;
            margin-top: 1.5rem; /* Etiketin yukarı kayması için yer aç */
        }

        .float-label-input {
            width: 100%;
            padding: 0.75rem 0.75rem 0.25rem 0.75rem; /* Üst padding etikete yer açar */
            border: 1px solid #d1d5db; /* Tailwind border-gray-300 */
            border-radius: 0.375rem; /* Tailwind rounded-md */
            font-size: 0.875rem; /* Tailwind text-sm */
            height: 38px; /* Diğer inputlarla aynı yükseklik */
            transition: border-color 0.2s ease-in-out;
            background-color: white;
            padding-top: 0.15rem; /* Üst padding'i biraz artırarak metni aşağı itin */
            padding-bottom: 0rem; /* Alt padding'i azaltın */
            line-height: 1.25; /* Satır yüksekliğini ayarlayın (gerekirse) */
        }
        /* Select için özel padding ayarı */
        .float-label-select {
            padding-top: 0.15rem; /* Üst padding'i artır */
            padding-bottom: 0rem; /* Alt padding'i azalt */
        }

        .float-label-input.pt-4 { /* textarea için kullandığımız sınıf */
            padding-top: 1.25rem !important; /* Etikete daha fazla yer aç */
        }

        .float-label {
            position: absolute;
            top: 0.65rem; /* Inputun ortasına yakın */
            left: 0.75rem;
            font-size: 0.875rem; /* Tailwind text-sm */
            color: #6b7280; /* Tailwind text-gray-500 */
            pointer-events: none; /* Üzerine tıklanınca input'a odaklanılsın */
            transition: all 0.2s ease-in-out;
            background-color: white; /* Arkasındaki çizgiyi silmek için */
            padding: 0 0.25rem; /* Kenarlara hafif boşluk */
        }
        /* Textarea Stilleri (Otomatik Genişleyen ve Şık Görünümlü) */
        textarea.float-label-input {
            /* Temel Görünüm ve Floating Label Uyumu */
            padding-top: 1.25rem; /* Floating label için yer */
            padding-bottom: 0.25rem;
            line-height: 1.5; /* Satır yüksekliği - içeriğe göre ayarlanabilir */
            min-height: calc(1.5em * 2 + 1.5rem); /* Yaklaşık 3 satır + padding için min yükseklik */
            height: auto; /* Başlangıçta yüksekliği içeriğe göre ayarla */
            /* Otomatik Genişleme ve Kaydırma */
            overflow-y: hidden; /* Dikey kaydırma çubuğunu HER ZAMAN gizle */
            resize: none; /* Yeniden boyutlandırma tutamacını kaldır */
            /* Tarayıcı varsayılan görünümünü sıfırlama (isteğe bağlı) */
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-clip: padding-box; /* Border'ın içeriğin üzerine binmesini engelle */
        }

            /* İnce Kaydırma Çubuğu (Gerekirse diye, ama overflow:hidden ile gizlenmeli) */
            textarea.float-label-input::-webkit-scrollbar {
                display: none; /* Webkit'te tamamen gizle */
            }

        textarea.float-label-input {
            scrollbar-width: none; /* Firefox'ta tamamen gizle */
        }
        /* Input focus olduğunda veya içinde değer olduğunda label'ı yukarı taşı */
        .float-label-input:focus + .float-label,
        .float-label-input:not(:placeholder-shown) + .float-label,
        .float-label-container.select-has-value .float-label { /* Select için özel durum */
            top: -0.6rem; /* Inputun üstüne taşı */
            left: 0.5rem;
            font-size: 0.75rem; /* Tailwind text-xs */
            color: #3b82f6; /* Tailwind text-blue-600 */
        }
        /* Focus olduğunda border rengini değiştir */
        .float-label-input:focus {
            outline: none;
            border-color: #3b82f6; /* Tailwind focus:border-blue-500 */
            box-shadow: 0 0 0 1px #3b82f6; /* Tailwind focus:ring-1 focus:ring-blue-500 */
        }
        /* Readonly inputlar için farklı stil */
        .float-label-input[readonly] {
            background-color: #f3f4f6; /* Tailwind bg-gray-100 */
            cursor: not-allowed;
        }

        .ekstre-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background-color: #fff;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            border-left-width: 5px;
            transition: box-shadow 0.2s ease-in-out;
        }

            .ekstre-item:hover {
                box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            }

        .ekstre-item-giris {
            border-left-color: #22c55e; /* green-500 */
        }

        .ekstre-item-cikis {
            border-left-color: #ef4444; /* red-500 */
        }

        .ekstre-sol {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

            .ekstre-sol .baslik {
                font-weight: 600;
                font-size: 0.9rem;
            }

            .ekstre-sol .tarih {
                font-size: 0.75rem;
                color: #6b7280;
                margin-top: 2px;
            }

        .ekstre-orta {
            display: flex;
            align-items: center;
            gap: 20px; /* Gruplar arası boşluk */
            font-family: 'Roboto Mono', monospace;
            margin: 0 24px;
        }

        .ekstre-detay-grup {
            display: flex;
            flex-direction: column;
        }

        .ekstre-sag {
            display: flex;
            align-items: center;
            font-family: 'Roboto Mono', monospace;
            margin-left: auto;
        }

        .bakiye-grup {
            display: flex;
            flex-direction: column;
            text-align: right;
            margin-right: 16px;
        }

            .bakiye-grup .eski-bakiye {
                font-size: 0.7rem;
                color: #6b7280;
            }

            .bakiye-grup .son-bakiye {
                font-size: 0.8rem;
                font-weight: 700;
                color: #1f2937;
            }

        .hareket-id {
            font-size: 0.7rem;
            color: #9ca3af;
            margin-bottom: 2px;
        }

        .mutabakat-switch {
            position: relative;
            display: inline-block;
            width: 34px;
            height: 20px;
        }

            .mutabakat-switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }

        .mutabakat-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }

            .mutabakat-slider:before {
                position: absolute;
                content: "";
                height: 14px;
                width: 14px;
                left: 3px;
                bottom: 3px;
                background-color: white;
                transition: .4s;
                border-radius: 50%;
            }

        input:checked + .mutabakat-slider {
            background-color: #3B82F6;
        }

            input:checked + .mutabakat-slider:before {
                transform: translateX(14px);
            }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f8fc;
            transition: background-color 0.4s ease;
        }

        #receipt-log, #receipt-totals {
            font-family: 'Roboto Mono', monospace;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }

            .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                background: #9ca3af;
            }

        .theme-border {
            border: 1px solid;
            transition: border-color 0.4s ease, border-top-width 0.3s ease, border-top-color 0.3s ease;
        }

        .theme-border-50 {
            border: 1px solid;
            transition: border-color 0.4s ease;
        }

        .theme-icon-color {
            transition: color 0.4s ease;
        }

        .modal-bg {
            background-color: rgba(0,0,0,0.5);
            transition: opacity 0.3s ease;
        }

        #fis-list-modal.hidden .modal-bg {
            opacity: 0;
        }

        #fis-list-modal .modal-content {
            transition: transform 0.3s ease;
            transform: translateX(100%);
        }

        #fis-list-modal:not(.hidden) .modal-content {
            transform: translateX(0);
        }

        #fis-list-table tbody tr:hover {
            background-color: #f9fafb;
        }

        #fis-list-table tbody tr.selected-row {
            background-color: #eff6ff;
            --tw-ring-color: #3b82f6;
            --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color);
            --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color);
            box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000);
        }

        body.satis-active .theme-border {
            border-color: rgba(30, 132, 73, 0.35);
        }

        body.satis-active .theme-border-50 {
            border-color: rgba(30, 132, 73, 0.5);
        }

        body.satis-active .theme-icon-color.income {
            color: #16a34a;
        }

        body.satis-active .theme-icon-color.expense {
            color: #dc2626;
        }

        .account-type-btn {
            transition: background-color 0.2s ease, color 0.2s ease;
            border: 1px solid #d1d5db;
        }

        .active-account-type-btn {
            background-color: #3b82f6;
            color: white;
            border-color: #3b82f6;
            font-weight: 600;
        }

        body.cari-active .theme-border {
            border-color: rgba(59, 130, 246, 0.4);
        }

        body.cari-active .theme-border-50 {
            border-color: rgba(59, 130, 246, 0.55);
        }

        body.cari-active .theme-icon-color.income {
            color: #16a34a;
        }

        body.cari-active .theme-icon-color.expense {
            color: #dc2626;
        }
        /* YENİ: 3'lü Nakit Hesap Tipi Toggle Stilleri */
        .tri-toggle-container {
            position: relative;
            display: inline-block; /* Veya inline-flex */
            width: 100%; /* Form içinde tam genişlik */
            /* max-width: 240px; İsterseniz maksimum genişlik verebilirsiniz */
            height: 38px;
            background-color: #e5e7eb; /* Tailwind bg-gray-200 */
            border-radius: 8px; /* Tailwind rounded-lg */
            padding: 3px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }

        .tri-toggle-slider { /* Kayacak olan beyaz kısım */
            position: absolute;
            height: 32px; /* Konteyner yüksekliği - (padding * 2) */
            width: calc((100% - 6px) / 3); /* 3 seçenek var, padding'i hesaba kat */
            top: 3px;
            left: 3px;
            background-color: white;
            border-radius: 6px; /* Konteyner border-radius'undan biraz küçük */
            transition: transform 0.4s ease; /* Yumuşak geçiş animasyonu */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.06); /* Tailwind shadow */
            z-index: 1;
        }

        .tri-toggle-options {
            display: flex;
            height: 100%;
            position: relative;
            z-index: 2; /* Yazılar slider'ın üzerinde olmalı */
        }

        .tri-toggle-option {
            flex: 1; /* Seçenekler eşit genişlikte */
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600; /* Tailwind font-semibold */
            color: #6b7280; /* Pasif yazı rengi - Tailwind text-gray-500 */
            user-select: none;
            transition: color 0.4s ease; /* Yazı rengi geçişi */
        }

        #acikhesap-tipi-toggle[data-selected="borcuna"] .tri-toggle-slider {
            transform: translateX(0%);
        }

        #acikhesap-tipi-toggle[data-selected="alacagina"] .tri-toggle-slider {
            transform: translateX(100%);
        }

        #ceviri-tipi-toggle[data-selected="borcundaki"] .tri-toggle-slider {
            transform: translateX(0%);
        }

        #ceviri-tipi-toggle[data-selected="alacagindaki"] .tri-toggle-slider {
            transform: translateX(100%);
        }
        /* Aktif seçeneğin yazı rengi */
        .tri-toggle-option.active {
            color: #3b82f6; /* Aktif yazı rengi - Tailwind text-blue-600 */
        }

        /* Slider'ın pozisyonunu data attribute'una göre ayarla */
        /* ÖNEMLİ: Buradaki değerler ('KASALAR', 'BANKALAR', 'POSLAR') JavaScript'teki accountTypes.value ile eşleşmeli */
        .tri-toggle-container[data-selected="KASALAR"] .tri-toggle-slider {
            transform: translateX(0%);
        }

        .tri-toggle-container[data-selected="BANKALAR"] .tri-toggle-slider {
            transform: translateX(100%);
        }

        .tri-toggle-container[data-selected="POSLAR"] .tri-toggle-slider {
            transform: translateX(200%);
        }

        .toggle-container {
            position: relative;
            display: inline-block;
            width: 110px;
            height: 38px;
        }

        .toggle-checkbox {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-label {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: 8px;
            transition: background-color 0.4s, opacity 0.4s;
            display: flex;
            align-items: center;
            color: white;
            font-weight: bold;
            font-size: 13px;
            user-select: none;
        }

            .toggle-label::before {
                content: '';
                position: absolute;
                height: 32px;
                width: 52px;
                left: 3px;
                top: 3px;
                background-color: white;
                border-radius: 6px;
                transition: transform 0.4s ease;
                box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                z-index: 1;
            }

        .toggle-text {
            flex: 1;
            text-align: center;
            position: relative;
            z-index: 2;
            transition: color 0.4s ease, opacity 0.4s ease;
        }

        body.satis-active .toggle-label {
            background-color: #1E8449;
        }

        body.satis-active .toggle-text:first-child {
            color: #1E8449;
            opacity: 1;
        }

        body.satis-active .toggle-text:last-child {
            color: #FFFFFF;
            opacity: 0.5;
        }

        body.cari-active .toggle-label {
            background-color: #3B82F6;
        }

        body.cari-active .toggle-text:first-child {
            color: #FFFFFF;
            opacity: 0.5;
        }

        body.cari-active .toggle-text:last-child {
            color: #3B82F6;
            opacity: 1;
        }

        .toggle-checkbox:checked + .toggle-label::before {
            transform: translateX(52px);
        }

        .toggle-checkbox:disabled + .toggle-label {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .karsilik-toggle-container {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .karsilik-toggle {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .karsilik-toggle-label {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

            .karsilik-toggle-label:before {
                position: absolute;
                content: "";
                height: 18px;
                width: 18px;
                left: 3px;
                bottom: 3px;
                background-color: white;
                transition: .4s;
                border-radius: 50%;
            }

        .karsilik-toggle:checked + .karsilik-toggle-label {
            background-color: #3B82F6;
        }

            .karsilik-toggle:checked + .karsilik-toggle-label:before {
                transform: translateX(20px);
            }

        .ss-main .ss-single-selected, .ss-main .ss-multi-selected {
            height: 38px;
            padding: 6px 10px;
            font-size: 0.875rem;
            border-color: #d1d5db;
        }

        .receipt-item.selected-item-income {
            background-color: #f0fdf4;
            border-color: #22c55e;
        }

        .receipt-item.selected-item-expense {
            background-color: #fef2f2;
            border-color: #ef4444;
        }

        .receipt-item.income-border {
            border: 1px solid #dcfce7;
        }

        .receipt-item.expense-border {
            border: 1px solid #fee2e2;
        }

        button:disabled {
            cursor: not-allowed;
            background-color: #e5e7eb !important;
            opacity: 0.7;
        }
        /* Üçlü anahtarın genel kapsayıcısı */
        .toggle-group {
            position: relative;
            display: flex;
            background-color: #e5e7eb; /* Tailwind gray-200 */
            border-radius: 0.5rem; /* Tailwind rounded-lg */
            padding: 0.25rem; /* Tailwind p-1 */
            width: 100%;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        /* Seçimi gösteren hareketli arkaplan */
        .toggle-slider {
            position: absolute;
            top: 0.25rem;
            left: 0.25rem;
            width: calc((100% - 0.5rem) / 3);
            height: calc(100% - 0.5rem);
            background-color: white;
            border-radius: 0.375rem; /* Tailwind rounded-md */
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1;
        }

        /* Görünmez radio butonlar */
        .toggle-radio {
            display: none;
        }

        /* Tıklanabilir metin etiketleri */
        .toggle-label {
            flex: 1;
            text-align: center;
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem; /* Tailwind text-sm */
            color: #4b5563; /* Tailwind gray-600 */
            cursor: pointer;
            z-index: 2;
            transition: color 0.3s ease;
            user-select: none;
        }

        #virman-tipi-toggle[data-selected="giris"] .tri-toggle-slider,
        #virman-tipi-toggle[data-selected="borcuna"] .tri-toggle-slider {
            transform: translateX(0%);
        }

        #virman-tipi-toggle[data-selected="cikis"] .tri-toggle-slider,
        #virman-tipi-toggle[data-selected="alacagina"] .tri-toggle-slider {
            transform: translateX(100%);
        }

        #iskonto-tipi-toggle[data-selected="borcuna"] .tri-toggle-slider {
            transform: translateX(0%);
        }

        #iskonto-tipi-toggle[data-selected="alacagina"] .tri-toggle-slider {
            transform: translateX(100%);
        }
        /* Seçili radio butona göre kaydırıcıyı hareket ettir ve metin rengini değiştir */
        #toggle-radio-kasa:checked ~ .toggle-slider {
            transform: translateX(0%);
        }

        #toggle-radio-kasa:checked ~ .toggle-label[for="toggle-radio-kasa"] {
            color: #1f2937; /* Tailwind gray-800 */
        }

        #toggle-radio-banka:checked ~ .toggle-slider {
            transform: translateX(100%);
        }

        #toggle-radio-banka:checked ~ .toggle-label[for="toggle-radio-banka"] {
            color: #1f2937;
        }

        #toggle-radio-pos:checked ~ .toggle-slider {
            transform: translateX(200%);
        }

        #toggle-radio-pos:checked ~ .toggle-label[for="toggle-radio-pos"] {
            color: #1f2937;
        }

        .hat-green {
            border-top-width: 4px;
            border-top-color: #22c55e !important;
        }

        .hat-red {
            border-top-width: 4px;
            border-top-color: #ef4444 !important;
        }

        .rolex-green-border {
            border: 1px solid #006039;
        }

        .toggle-btn-active {
            background-color: #3B82F6;
            color: white;
            font-weight: 600;
        }

        .toggle-btn-inactive {
            background-color: transparent;
            color: #3B82F6;
        }

        .ekstre-list-container {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .ekstre-item {
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            min-height: 64px;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s, box-shadow 0.2s;
        }

            .ekstre-item.selected-ekstre-row {
                background-color: #e0f2fe; /* light blue */
                border-color: #0ea5e9;
                box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.4);
            }

        .ekstre-item-giris {
            border-left-width: 4px;
            border-left-color: #4ade80; /* yeşil */
        }

        .ekstre-item-cikis {
            border-left-width: 4px;
            border-left-color: #f87171; /* kırmızı */
        }

        .ekstre-blok-sag {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-shrink: 0;
            margin-left: auto; /* Sağa yaslamak için */
        }

            .ekstre-blok-sag .bakiye-grup {
                display: flex;
                flex-direction: column;
                text-align: right;
                font-family: 'Roboto Mono', monospace;
                font-size: 0.75rem;
                min-width: 140px
            }

                .ekstre-blok-sag .bakiye-grup .eski-bakiye {
                    white-space: nowrap;
                    color: #6b7280;
                }

                .ekstre-blok-sag .bakiye-grup .son-bakiye {
                    white-space: nowrap;
                    color: #1f2937;
                    font-weight: 700;
                }

            .ekstre-blok-sag .hareket-id {
                font-size: 0.65rem;
                font-family: 'Roboto Mono', monospace;
                color: #9ca3af;
                text-align: center;
                margin-bottom: 2px;
            }

        .mutabakat-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 22px;
        }

            .mutabakat-switch input {
                opacity: 0;
                width: 0;
                height: 0;
            }

        .mutabakat-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 22px;
        }

            .mutabakat-slider:before {
                position: absolute;
                content: "";
                height: 16px;
                width: 16px;
                left: 3px;
                bottom: 3px;
                background-color: white;
                transition: .4s;
                border-radius: 50%;
            }

        input:checked + .mutabakat-slider {
            background-color: #22c55e;
        }

            input:checked + .mutabakat-slider:before {
                transform: translateX(18px);
            }

        .ekstre-modal-header {
            background: linear-gradient(to right, #f8f9fa, #e9ecef);
            border-bottom: 1px solid #dee2e6;
        }

        .ekstre-info-card {
            background-color: #ffffff;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1.75rem 1rem 1rem 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
            position: relative;
        }

        .card-title-absolute {
            position: absolute;
            top: -0.7rem;
            left: 0.75rem;
            background-color: #ffffff;
            padding: 0 0.5rem;
            font-size: 0.8rem;
            font-weight: 600;
            color: #4b5563;
            display: flex;
            align-items: center;
        }

            .card-title-absolute i {
                margin-right: 0.5rem;
                color: #9ca3af;
            }
        /* Bakiye satırlarının altına %10 opaklıkta bir çizgi ekler */
        .bakiye-item {
            border-bottom: 1px solid rgba(0, 0, 0, 0.07);
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }

            /* Son satırın altındaki çizgiyi kaldırır */
            .bakiye-item:last-child {
                border-bottom: none;
            }

        /* Rakam ve durumu içeren sağ taraf kabı */
        .bakiye-item-sag {
            display: flex;
            align-items: baseline;
            justify-content: flex-end;
        }

        /* Rakamları sağa yaslar ve okunaklı olması için sabit bir minimum genişlik verir */
        .bakiye-tutar-rakam {
            min-width: 90px;
            text-align: right;
            font-weight: 700; /* Rakamları kalın yapar */
        }

        /* Durum yazısını (ALACAKLI/BORÇLU) sola yaslar ve rakamdan biraz ayırır */
        .bakiye-tutar-durum {
            min-width: 75px;
            text-align: left;
            margin-left: 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

            /* ===== YENİ EKLENDİ: Renklendirme ===== */
            /* Yeşil Renk (Alacaklı) */
            .bakiye-tutar-rakam.alacak,
            .bakiye-tutar-durum.alacak {
                color: #16a34a; /* Tailwind Green-600 */
            }

            /* Kırmızı Renk (Borçlu) */
            .bakiye-tutar-rakam.borc,
            .bakiye-tutar-durum.borc {
                color: #dc2626; /* Tailwind Red-600 */
            }

        #ekstre-bakiye-ozeti {
            max-height: 116px;
            overflow-y: auto;
        }

        .ekstre-bakiye-ozeti-v2 .bakiye-item {
            display: flex;
            justify-content: space-between;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.8rem;
            padding: 0.25rem 0;
            height: 29px;
        }

            .ekstre-bakiye-ozeti-v2 .bakiye-item .birim {
                font-weight: 600;
                color: #4b5563;
            }

            .ekstre-bakiye-ozeti-v2 .bakiye-item .tutar.alacak {
                color: #16a34a;
                font-weight: 700;
            }

            .ekstre-bakiye-ozeti-v2 .bakiye-item .tutar.borc {
                color: #dc2626;
                font-weight: 700;
            }

        /* ===== YENİ EKSTRE SATIR TASARIMI (v3) ===== */
        .ekstre-v3-sol {
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            width: 110px;
            justify-content: center;
        }

            .ekstre-v3-sol .baslik {
                font-size: 0.8rem;
                font-weight: 700;
                line-height: 1.2;
            }

            .ekstre-v3-sol .tarih {
                font-size: 0.7rem;
                color: #6b7280;
            }

        .ekstre-v3-orta {
            display: flex;
            flex-grow: 1;
            gap: 1.5rem;
            align-items: center;
            font-family: 'Roboto Mono', monospace;
        }

        .ekstre-v3-detay-grup {
            display: flex;
            flex-direction: column;
        }
        /* customer alanı kesin büyüsün */
        .app-shell-customer {
            display: flex;
            flex: 1 1 auto;
            min-width: 0;
        }

            .app-shell-customer .ss-main {
                width: 100% !important;
                flex: 1 1 auto !important;
                min-width: 0 !important;
            }

    </style>
</head>
<body class="text-gray-800 p-2 overflow-hidden">

    <header class="bg-white p-3 rounded-xl shadow-sm theme-border">
        <!-- DEĞİŞTİ: justify-between kalktı -->
        <div class="flex items-center gap-3 flex-nowrap">

            <!-- SOL BLOK -->
            <div class="flex items-center gap-3 flex-1 min-w-0">
                <div class="toggle-container flex-shrink-0">
                    <input type="checkbox" id="operation-type-toggle" class="toggle-checkbox" name="operation-type-toggle">
                    <label for="operation-type-toggle" class="toggle-label">
                        <span class="toggle-text">SATIŞ</span>
                        <span class="toggle-text">CARİ</span>
                    </label>
                </div>

                <select id="currency-select" name="currency-select"
                        class="flex-shrink-0 form-select w-auto bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-1.5 h-[38px]">
                    @foreach (var item in Model.getAllCurrencyQueryResponses)
                    {
                        <option value="@item.Id">@item.CurrencyCode</option>
                    }
                </select>

                <!-- customer alanı kalan yeri dolduracak -->
                <div class="app-shell-customer flex-1 min-w-0">
                    <select id="customer-select" name="customer-select">
                        @foreach (var item in Model.getAllAccountQueryResponses.Where(x => !x.Tezgahtar))
                        {
                            <option value="@item.AccountId">@item.AccountName</option>
                        }
                    </select>
                </div>
            </div>

            <!-- ORTA BLOK: ml-auto eklendi (sağa yasla) -->
            <div class="flex items-center gap-2 flex-shrink-0 ml-auto">
                <button class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-1.5 px-3 border border-gray-300 rounded-lg shadow-sm text-xs">
                    <i class="fas fa-users mr-1.5"></i>CRM
                </button>
                <button id="ekstre-button" class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-1.5 px-3 border border-gray-300 rounded-lg shadow-sm text-xs">
                    <i class="fas fa-file-invoice mr-1.5"></i>Ekstre
                </button>
                <button id="sales-list-button" class="bg-white hover:bg-gray-100 text-gray-800 font-semibold py-1.5 px-3 border border-gray-300 rounded-lg shadow-sm text-xs">
                    <i class="fas fa-list mr-1.5"></i>Satış Listesi
                </button>
            </div>

            <!-- SAĞ BLOK: sabit kalsın -->
            <div class="salesperson-wrap flex items-center">
                <select id="salesperson-select" name="salesperson-select">
                    @foreach (var item in Model.getAllAccountQueryResponses.Where(x => x.AccountTypeId == 13))
                    {
                        <option value="@item.AccountId">@item.AccountName</option>
                    }
                </select>
            </div>

        </div>
    </header>

    <main class="pt-3 h-[calc(100vh-92px)]">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-4 h-full">
            <div class="lg:col-span-4 flex flex-col gap-3 h-full">
                <div class="bg-white rounded-xl shadow-sm flex flex-col theme-border h-full overflow-hidden">
                    <div class="p-3 border-b border-gray-200 flex-shrink-0">
                        <div class="flex justify-between items-center">
                            <h5 id="receipt-title" class="text-lg font-bold text-gray-700">Satış Fişi</h5>
                            <input type="datetime-local" id="fis-tarihi" class="text-sm bg-transparent text-gray-600 border-none focus:ring-0 p-0 w-auto">
                        </div>
                    </div>
                    <div id="receipt-log" class="flex-grow p-3 overflow-y-auto custom-scrollbar min-h-0"></div>
                    <div id="receipt-totals" class="p-3 border-t border-gray-200 flex-shrink-0 max-h-48 overflow-y-auto custom-scrollbar">
                        <div id="satis-totals" class="space-y-1">
                            <div class="flex justify-between items-center text-xs"><strong class="font-medium text-gray-600">Giren Toplam:</strong><span id="giren-toplam" class="font-bold text-green-600">0,00 TRY</span></div>
                            <div class="flex justify-between items-center text-xs"><strong class="font-medium text-gray-600">Çıkan Toplam:</strong><span id="cikan-toplam" class="font-bold text-red-600">0,00 TRY</span></div>
                            <hr class="my-1">
                            <div class="flex justify-between items-center text-sm"><strong class="font-semibold text-gray-800">Fark:</strong><span id="fark-toplam" class="font-extrabold text-blue-700">0,00 TRY</span></div>
                        </div>
                        <div id="cari-totals" class="hidden">
                        </div>
                    </div>
                </div>
            </div>

            <div id="middle-panel" class="lg:col-span-5 bg-white rounded-xl shadow-sm flex flex-col theme-border h-full overflow-hidden">
                <div id="dynamic-content-area" class="flex-grow p-4 overflow-y-auto custom-scrollbar min-h-0"></div>
                <div class="p-3 border-t border-gray-200 flex justify-end gap-2 flex-shrink-0">
                    <button id="delete-button" class="hidden bg-red-100 hover:bg-red-200 text-red-800 font-semibold py-1.5 px-4 rounded-md text-sm transition-colors border border-red-200"><i class="fas fa-trash mr-1.5"></i>Sil</button>
                    <button id="add-button" class="hidden bg-blue-100 hover:bg-blue-200 text-blue-800 font-semibold py-1.5 px-4 rounded-md text-sm transition-colors border border-blue-200"><i class="fas fa-check mr-1.5"></i>Ekle</button>
                    <button id="cancel-button" class="hidden bg-gray-100 hover:bg-gray-200 text-gray-800 font-semibold py-1.5 px-4 rounded-md text-sm transition-colors border border-gray-200"><i class="fas fa-times mr-1.5"></i>Vazgeç</button>
                </div>
            </div>

            <div class="lg:col-span-3 h-full flex flex-col gap-4">
                <div class="bg-white rounded-xl shadow-md p-3 theme-border">
                    <div class="border-b pb-2 mb-2">
                        <div class="grid grid-cols-2 gap-2">
                            <button id="btn-nakit-tahsilat" class="flex flex-col items-center justify-center p-2 bg-white hover:bg-gray-50 rounded-lg theme-border-50 action-btn"><i id="icon-nakit-tahsilat" class="fas fa-hand-holding-dollar text-xl mb-1 theme-icon-color income" style="transform: scaleX(-1);"></i><span id="label-nakit-tahsilat" class="block text-xs font-semibold"></span></button>
                            <button id="btn-nakit-odeme" class="flex flex-col items-center justify-center p-2 bg-white hover:bg-gray-50 rounded-lg theme-border-50 action-btn"><i id="icon-nakit-odeme" class="fas fa-hand-holding-dollar text-xl mb-1 theme-icon-color expense"></i><span id="label-nakit-odeme" class="block text-xs font-semibold"></span></button>
                        </div>
                    </div>
                    <div class="border-b pb-2 mb-2">
                        <div class="grid grid-cols-2 gap-2">
                            <button id="btn-urun-alis" class="flex flex-col items-center justify-center p-2 bg-white hover:bg-gray-50 rounded-lg theme-border-50 action-btn"><i id="icon-urun-alis" class="fas fa-gem text-xl mb-1 theme-icon-color income"></i><span id="label-urun-alis" class="block text-xs font-semibold"></span></button>
                            <button id="btn-urun-satis" class="flex flex-col items-center justify-center p-2 bg-white hover:bg-gray-50 rounded-lg theme-border-50 action-btn"><i id="icon-urun-satis" class="fas fa-tag text-xl mb-1 theme-icon-color expense"></i><span id="label-urun-satis" class="block text-xs font-semibold"></span></button>
                        </div>
                    </div>
                    <div>
                        <div class="grid grid-cols-2 gap-2">
                            <button id="btn-iskonto" class="flex flex-col items-center justify-center p-2 bg-white hover:bg-gray-50 rounded-lg theme-border-50 action-btn"><i class="fas fa-percent text-xl mb-1 theme-icon-color expense"></i><span class="block text-xs font-semibold">İskonto</span></button>
                            <button id="btn-virman" class="flex flex-col items-center justify-center p-2 bg-white hover:bg-gray-50 rounded-lg theme-border-50 action-btn"><i class="fas fa-exchange-alt text-xl mb-1 theme-icon-color income"></i><span class="block text-xs font-semibold">Virman</span></button>
                            <button id="btn-acik-hesap" class="flex flex-col items-center justify-center p-2 bg-white hover:bg-gray-50 rounded-lg theme-border-50 action-btn"><i class="fas fa-book-open text-xl mb-1 theme-icon-color income"></i><span class="block text-xs font-semibold">Açık Hesap</span></button>
                            <button id="btn-ceviri" class="flex flex-col items-center justify-center p-2 bg-white hover:bg-gray-50 rounded-lg theme-border-50 action-btn"><i class="fas fa-random text-xl mb-1 theme-icon-color income"></i><span class="block text-xs font-semibold">Çeviri</span></button>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-md p-3 flex-grow flex flex-col theme-border">
                    <div class="mt-auto flex gap-2">
                        <button id="main-save-button" class="flex-1 bg-green-200 hover:bg-green-300 text-green-800 font-semibold py-2 px-4 rounded-lg transition-colors border border-green-300 text-sm"><i class="fas fa-save mr-2"></i>Kaydet</button>
                        <button id="main-reset-button" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition-colors border border-gray-300 text-sm"><i class="fas fa-sync-alt mr-2"></i>Yeni İşlem</button>
                        <button id="main-delete-button" class="flex-1 bg-red-200 hover:bg-red-300 text-red-800 font-semibold py-2 px-4 rounded-lg transition-colors border border-red-300 text-sm hidden"><i class="fas fa-trash mr-2"></i>Sil</button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-50 pt-10">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm rolex-green-border">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Uyarı</h3>
            <p id="modal-message" class="text-sm text-gray-600 mb-6"></p>
            <div class="flex justify-end gap-3">
                <button id="modal-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg text-sm">Vazgeç</button>
                <button id="modal-confirm" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm">Devam Et</button>
            </div>
        </div>
    </div>
    <div id="toast-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-start justify-center z-[60] pt-20">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm rolex-green-border transform transition-all duration-300 scale-95 opacity-0">
            <h3 class="text-lg font-bold mb-4">Uyarı</h3>
            <p class="text-sm text-gray-600 mb-6"></p>
            <div class="flex justify-end">
                <button class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">Tamam</button>
            </div>
        </div>
    </div>
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
        <div class="text-white text-center">
            <i class="fas fa-spinner fa-spin text-4xl mb-3"></i>
            <p class="text-lg font-semibold">Lütfen Bekleyiniz...</p>
        </div>
    </div>
    <div id="ekstre-modal" class="hidden fixed inset-0 modal-bg flex items-start justify-center z-50 pt-10">
        <div class="bg-gray-50 rounded-lg shadow-xl w-full max-w-7xl max-h-[90vh] flex flex-col">

            <div class="flex justify-between items-center p-4 ekstre-modal-header rounded-t-lg">
                <h3 class="text-lg font-bold text-gray-700 flex items-center">
                    <i class="fas fa-file-invoice-dollar text-gray-500 mr-3"></i>
                    Hesap Ekstresi
                </h3>
                <button id="ekstre-modal-close-button" class="text-gray-500 hover:text-red-600 text-2xl transition-colors">&times;</button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 p-4 border-b">
                <!-- Müşteri Bilgi Kartı -->
                <div class="ekstre-info-card lg:col-span-1">
                    <h4 class="card-title-absolute"><i class="fas fa-user-circle"></i>Müşteri Bilgileri</h4>
                    <span id="ekstre-hesap-adi" class="font-bold text-gray-800 text-base truncate block" title="Hesap Adı"></span>
                    <span id="ekstre-hesap-tipi" class="block text-sm text-gray-500 mt-1"></span>
                    <span id="ekstre-hesap-telefon" class="block text-sm text-gray-600 mt-1"></span>
                    <span id="ekstre-hesap-id" class="text-xs font-mono text-gray-400 block mt-2"></span>
                </div>

                <!-- Bakiye Özeti Kartı -->
                <div class="ekstre-info-card lg:col-span-1">
                    <h4 class="card-title-absolute"><i class="fas fa-balance-scale"></i>Bakiye Özeti</h4>
                    <div id="ekstre-bakiye-ozeti" class="custom-scrollbar pr-2 ekstre-bakiye-ozeti-v2">
                        <!-- Bakiye içeriği JS ile dolacak -->
                    </div>
                </div>

                <!-- Tarih Filtreleme & Pozisyon Kartı -->
                <div class="ekstre-info-card lg:col-span-1">
                    <h4 class="card-title-absolute"><i class="fas fa-calendar-alt"></i>Tarih Aralığı</h4>
                    <div class="flex items-stretch">
                        <input type="date" id="ekstre-baslangic-tarihi" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-l-md shadow-sm text-sm h-[38px] border-r-0">
                        <input type="date" id="ekstre-bitis-tarihi" class="block w-full px-3 py-2 bg-white border border-gray-300 shadow-sm text-sm h-[38px] rounded-none">
                        <button id="ekstre-getir-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-r-md text-sm h-[38px] border border-blue-600 flex items-center justify-center">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div class="mt-3 text-center w-full border-t pt-3">
                        <span id="ekstre-has-pozisyon" class="text-base font-semibold"></span>
                    </div>
                </div>
            </div>

            <div id="ekstre-content" class="p-4 overflow-y-auto bg-white rounded-b-lg">
                <!-- Ekstre içeriği JS ile dolacak -->
            </div>
        </div>
    </div>
    <div id="fis-list-modal" class="hidden fixed inset-0 z-50 flex justify-end">
        <div class="modal-bg absolute inset-0"></div>
        <div class="modal-content bg-white w-full max-w-4xl h-full flex flex-col shadow-2xl relative">
            <div class="flex justify-between items-center p-4 border-b sticky top-0 bg-white z-10">
                <h3 id="fis-list-modal-title" class="text-lg font-bold text-gray-800"></h3>
                <button id="fis-list-modal-close-button" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>

            <div id="fis-list-filters" class="p-3 border-b bg-gray-50 flex flex-wrap gap-3 items-end">
                <div class="flex-grow min-w-[250px]">
                    <label for="fis-list-customer-filter" class="text-xs font-semibold text-gray-600">Hesap Filtresi</label>
                    <select id="fis-list-customer-filter"></select>
                </div>
                <div>
                    <label for="fis-list-start-date" class="text-xs font-semibold text-gray-600">Başlangıç Tarihi</label>
                    <input type="date" id="fis-list-start-date" class="block w-full px-3 py-1.5 bg-white border border-gray-300 rounded-md shadow-sm text-sm h-[38px]">
                </div>
                <div>
                    <label for="fis-list-end-date" class="text-xs font-semibold text-gray-600">Bitiş Tarihi</label>
                    <input type="date" id="fis-list-end-date" class="block w-full px-3 py-1.5 bg-white border border-gray-300 rounded-md shadow-sm text-sm h-[38px]">
                </div>
                <div>
                    <button id="fis-list-filter-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md text-sm h-[38px]">
                        <i class="fas fa-filter mr-1.5"></i>Filtrele
                    </button>
                </div>
            </div>

            <div id="fis-list-content" class="flex-grow overflow-y-auto">
            </div>
        </div>
    </div>
    <template id="product-form-template">
        <h1 id="product-form-title" class="text-xl font-bold text-gray-800 mb-4">Ürün Giriş</h1>

        <div class="space-y-4">
            <div class="space-y-2">
                <input type="text" id="stokHiyerarsi" class="w-full p-2 bg-gray-100 border border-gray-200 rounded-md text-gray-600 text-sm mb-2" placeholder="Stok Kartı Seçiniz" disabled>
                <div class="relative" id="aramaKonteyneri">
                    <input type="text" id="stokArama" class="w-full px-3 py-2 text-gray-700 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Stok ara veya seç...">
                    <div id="stokKartiListesi" class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto hidden">
                    </div>
                </div>
            </div>

            <div id="dinamik-alanlar-wrapper" class="relative" style="min-height: 280px;">
                <div id="initial-prompt" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400 transition-opacity duration-300">
                    <i class="fas fa-hand-point-up fa-3x mb-3"></i>
                    <p class="font-semibold">Lütfen bir stok kartı seçiniz.</p>
                </div>

                <div id="defaultLayout" class="hidden space-y-6 opacity-0 transition-opacity duration-300">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label for="diger-miktar" id="diger-miktar-label" class="text-sm font-medium text-gray-700">Miktar</label>
                            <input type="text" id="diger-miktar" class="w-full px-3 py-2 text-right font-mono border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div class="space-y-2">
                            <label for="diger-birim-fiyat" id="diger-birim-fiyat-label" class="text-sm font-medium text-gray-700">Birim Fiyatı</label>
                            <input type="text" id="diger-birim-fiyat" class="w-full px-3 py-2 text-right font-mono border border-gray-300 rounded-md shadow-sm">
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 border-t pt-4">
                        <div class="space-y-2">
                            <label for="diger-toplam-tutar" class="text-sm font-medium text-gray-700">Tutar</label>
                            <input type="text" id="diger-toplam-tutar" class="w-full px-3 py-2 text-right font-mono bg-gray-100" readonly>
                        </div>
                        <div class="space-y-2">
                            <label class="text-sm font-medium text-gray-700">Tutar Birimi</label>
                            <input type="text" id="diger-tutar-birimi" class="w-full px-3 py-2 text-center font-mono bg-gray-100" readonly>
                        </div>
                    </div>
                    <div class="space-y-2 border-t pt-4">
                        <label for="product-description-default" class="text-sm font-medium text-gray-700">Açıklama</label>
                        <textarea id="product-description-default" class="product-description-input w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm" rows="2" placeholder="İşlem için özel bir açıklama..."></textarea>
                    </div>
                </div>

                <div id="altinLayout" class="hidden space-y-2 opacity-0 transition-opacity duration-300">
                    <div class="grid gap-3" style="grid-template-columns: 2fr 1fr 2fr;">
                        <div class="space-y-2">
                            <label for="altin-miktar" class="text-sm font-medium text-gray-700">Miktar</label>
                            <input type="text" id="altin-miktar" class="w-full px-3 py-2 text-right font-mono border rounded-md">
                        </div>
                        <div class="space-y-2">
                            <label for="altin-milyem" class="text-sm font-medium text-gray-700">Milyem</label>
                            <input type="text" id="altin-milyem" class="w-full px-3 py-2 text-right font-mono bg-gray-100" readonly>
                        </div>
                        <div class="space-y-2">
                            <label for="altin-has" class="text-sm font-medium text-gray-700">HAS</label>
                            <input type="text" id="altin-has" class="w-full px-3 py-2 text-right font-mono bg-gray-100" readonly>
                        </div>
                    </div>
                    <div class="grid gap-3 items-center py-2" style="grid-template-columns: 2fr 1fr 2fr;">
                        <div class="flex items-center space-x-2">
                            <div class="karsilik-toggle-container">
                                <input type="checkbox" id="iscilik-dahil-toggle" class="karsilik-toggle" />
                                <label for="iscilik-dahil-toggle" class="karsilik-toggle-label"></label>
                            </div>
                            <label for="iscilik-dahil-toggle" class="text-sm font-medium text-gray-700 cursor-pointer">İşçilik Dahil</label>
                        </div>
                        <div class="space-y-2">
                            <input type="text" id="iscilik-dahil-deger" class="w-full px-3 py-2 text-right font-mono border rounded-md hidden">
                        </div>
                        <div></div>
                    </div>
                    <div class="border-t pt-4">
                        <div class="grid gap-x-3 gap-y-2" style="grid-template-columns: 2fr 1fr 2fr;">
                            <div class="space-y-2">
                                <label for="altin-birim-iscilik" class="text-sm font-medium text-gray-700">Birim İşçilik</label>
                                <input type="text" id="altin-birim-iscilik" class="w-full px-3 py-2 text-right font-mono border rounded-md">
                            </div>
                            <div class="space-y-2">
                                <label class="text-sm font-medium text-gray-700">Birim</label>
                                <input type="text" id="altin-birim" class="w-full px-3 py-2 text-center font-mono bg-gray-100" readonly>
                            </div>
                            <div class="space-y-2">
                                <label for="altin-iscilik-tutari" class="text-sm font-medium text-gray-700">İşçilik Tutarı</label>
                                <input type="text" id="altin-iscilik-tutari" class="w-full px-3 py-2 text-right font-mono bg-gray-100" readonly>
                            </div>

                            <div id="gram-adet-container" class="flex items-center justify-start col-start-1">
                                <div class="flex items-center border border-blue-500 rounded-md p-0.5 text-sm">
                                    <button id="gram-btn" class="px-3 py-1 rounded-md toggle-btn-active">Gram</button>
                                    <button id="adet-btn" class="px-3 py-1 rounded-md toggle-btn-inactive">Adet</button>
                                </div>
                            </div>
                            <div class="space-y-2 col-start-2">
                                <input type="text" id="altin-adet" class="w-full px-3 py-2 text-right font-mono border rounded-md hidden" value="1">
                            </div>
                        </div>
                    </div>
                    <div class="space-y-2 border-t pt-4">
                        <label for="altin-toplam-has" class="text-sm font-medium text-gray-700">Toplam HAS Değeri</label>
                        <input type="text" id="altin-toplam-has" class="w-full px-3 py-2 text-right font-mono bg-gray-100" readonly>
                    </div>
                    <div class="space-y-2 border-t pt-4">
                        <label for="product-description-altin" class="text-sm font-medium text-gray-700">Açıklama</label>
                        <textarea id="product-description-altin" class="product-description-input w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm" rows="2" placeholder="İşlem için özel bir açıklama..."></textarea>
                    </div>
                </div>

                <div id="hurdaLayout" class="hidden space-y-6 opacity-0 transition-opacity duration-300">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label for="hurda-miktar" class="text-sm font-medium text-gray-700">Miktar</label>
                            <input type="text" id="hurda-miktar" class="w-full px-3 py-2 text-right font-mono border rounded-md">
                        </div>
                        <div class="space-y-2">
                            <label for="hurda-milyem" class="text-sm font-medium text-gray-700">Milyem</label>
                            <input type="text" id="hurda-milyem" class="w-full px-3 py-2 text-right font-mono border rounded-md">
                        </div>
                    </div>
                    <div class="space-y-2 border-t pt-4">
                        <label for="hurda-toplam-has" class="text-sm font-medium text-gray-700">Toplam HAS Değeri</label>
                        <input type="text" id="hurda-toplam-has" class="w-full px-3 py-2 text-right font-mono bg-gray-100" readonly>
                    </div>
                    <div class="space-y-2 border-t pt-4">
                        <label for="product-description-hurda" class="text-sm font-medium text-gray-700">Açıklama</label>
                        <textarea id="product-description-hurda" class="product-description-input w-full px-3 py-2 text-sm border border-gray-300 rounded-md shadow-sm" rows="2" placeholder="İşlem için özel bir açıklama..."></textarea>
                    </div>
                </div>
            </div>

        </div>



    </template>
    <!-- Nakit Tahsilat Modal -->
    <div id="nakit-tahsilat-modal" class="hidden fixed inset-0 bg-black/50 flex items-start justify-center z-50 pt-10">
        <div class="bg-white w-full max-w-3xl rounded-2xl shadow-2xl overflow-hidden theme-border">
            <!-- Header -->
            <div class="px-6 pt-5 pb-4 border-b border-gray-200 flex items-center justify-between">
                <h3 id="nakit-modal-title" class="text-xl font-extrabold text-gray-900">Nakit Tahsilat</h3>
                <button id="nakit-tahsilat-close" class="text-gray-500 hover:text-gray-900 text-2xl leading-none">&times;</button>
            </div>

            <!-- Content -->
            <div class="px-6 py-5 space-y-4">
                <!-- Tabs -->
                <div class="bg-gray-100 rounded-xl p-1 flex gap-1">
                    <button type="button" class="nt-tab flex-1 py-2 rounded-lg font-bold text-sm"
                            data-tab="kasalar">
                        KASALAR
                    </button>
                    <button type="button" class="nt-tab flex-1 py-2 rounded-lg font-bold text-sm"
                            data-tab="bankalar">
                        BANKALAR
                    </button>
                    <button type="button" class="nt-tab flex-1 py-2 rounded-lg font-bold text-sm"
                            data-tab="poslar">
                        POSLAR
                    </button>
                </div>

                <!-- Tab contents -->
                <div id="nt-tab-kasalar" class="nt-panel space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-blue-600 mb-1">Kasa Seçiniz</label>
                        <select id="nt-kasa" class="w-full h-[44px] px-4 rounded-xl border border-gray-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Seçiniz...</option>
                            @foreach (var item in Model.getAllAccountQueryResponses.Where(x => x.AccountTypeId == 7))
                            {
                                <option value=@item.AccountId>@item.AccountName</option>
                            }
                        </select>
                    </div>
                </div>

                <div id="nt-tab-bankalar" class="nt-panel hidden space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-blue-600 mb-1">Banka Seçiniz</label>
                        <select id="nt-banka" class="w-full h-[44px] px-4 rounded-xl border border-gray-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Seçiniz...</option>
                            @foreach (var item in Model.getAllAccountQueryResponses.Where(x => x.AccountTypeId == 5))
                            {
                                <option value=@item.AccountId>@item.AccountName</option>
                            }
                        </select>
                    </div>
                </div>

                <div id="nt-tab-poslar" class="nt-panel hidden space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-blue-600 mb-1">POS Seçiniz</label>
                        <select id="nt-pos" class="w-full h-[44px] px-4 rounded-xl border border-gray-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="">Seçiniz...</option>
                            @foreach (var item in Model.getAllAccountQueryResponses.Where(x => x.AccountTypeId == 6))
                            {
                                <option value=@item.AccountId>@item.AccountName</option>
                            }
                        </select>
                    </div>
                </div>

                <!-- Amount row -->
                <div class="grid grid-cols-12 gap-3 items-end">
                    <div class="col-span-3">
                        <label class="block text-sm font-semibold text-blue-600 mb-1">Birim</label>
                        <select id="nt-birim" class="w-full h-[44px] px-4 rounded-xl border border-gray-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="TRY">TRY</option>
                            @foreach (var item in Model.getAllCurrencyQueryResponses)
                            {
                                <option value=@item.Id>@item.CurrencyCode</option>
                            }
                        </select>
                    </div>
                    <div class="col-span-6">
                        <label class="block text-sm font-semibold text-blue-600 mb-1">Tutar</label>
                        <input id="nt-tutar" type="text" value="0,00"
                               class="w-full h-[44px] px-4 rounded-xl border border-gray-300 bg-white shadow-sm text-right font-mono focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                    <div class="col-span-3">
                        <label class="block text-sm font-semibold text-blue-600 mb-1">Kur</label>
                        <input id="nt-kur" type="text" value="0,0000"
                               class="w-full h-[44px] px-4 rounded-xl border border-gray-300 bg-white shadow-sm text-right font-mono focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                </div>

                <!-- Karsiligi -->
                <div>
                    <label class="block text-sm font-semibold text-blue-600 mb-1">Karşılığı</label>
                    <div class="w-full h-[44px] px-4 rounded-xl border border-gray-300 bg-gray-50 shadow-sm flex items-center justify-between">
                        <span id="nt-karsilik" class="font-mono text-right w-full">0,00</span>
                        <span class="ml-3 text-gray-500 font-semibold">TRY</span>
                    </div>
                </div>

                <!-- Button -->
                <button type="button" id="nt-kalan-ekle"
                        class="inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-bold px-4 py-2 rounded-xl shadow">
                    <i class="fas fa-calculator"></i>
                    Kalanı Ekle (0,00)
                </button>

                <!-- Aciklama -->
                <div>
                    <label class="block text-sm font-semibold text-blue-600 mb-1">Açıklama</label>
                    <textarea id="nt-aciklama" rows="4"
                              class="w-full px-4 py-3 rounded-xl border border-gray-300 bg-white shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="Açıklama"></textarea>
                </div>
            </div>

            <!-- Footer -->
            <div class="px-6 py-4 border-t border-gray-200 flex justify-end gap-3 bg-gray-50">
                   <button type="button" id="nt-delete"
            class="hidden bg-red-200 hover:bg-red-300 text-red-900 font-bold px-6 py-2 rounded-xl border border-red-300">
        <i class="fas fa-trash mr-2"></i>Sil
    </button>
                
                <button type="button" id="nt-submit"
                        class="bg-blue-200 hover:bg-blue-300 text-blue-900 font-bold px-6 py-2 rounded-xl border border-blue-300">
                    <i class="fas fa-check mr-2"></i>Ekle
                </button>
                <button type="button" id="nt-cancel"
                        class="bg-gray-200 hover:bg-gray-300 text-gray-900 font-bold px-6 py-2 rounded-xl border border-gray-300">
                    <i class="fas fa-times mr-2"></i>Vazgeç
                </button>
            </div>
        </div>
    </div>

    <div id="ekstre-modal" class="hidden fixed inset-0 modal-bg flex items-start justify-center z-50 pt-10">
        <div class="bg-gray-50 rounded-lg shadow-xl w-full max-w-7xl max-h-[90vh] flex flex-col">

            <div class="flex justify-between items-center p-4 ekstre-modal-header rounded-t-lg">
                <h3 class="text-lg font-bold text-gray-700 flex items-center">
                    <i class="fas fa-file-invoice-dollar text-gray-500 mr-3"></i>
                    Hesap Ekstresi
                </h3>
                <button id="ekstre-modal-close-button" class="text-gray-500 hover:text-red-600 text-2xl transition-colors">&times;</button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 p-4 border-b">
                <!-- Müşteri Bilgi Kartı -->
                <div class="ekstre-info-card lg:col-span-1">
                    <h4 class="card-title-absolute"><i class="fas fa-user-circle"></i>Müşteri Bilgileri</h4>
                    <span id="ekstre-hesap-adi" class="font-bold text-gray-800 text-base truncate block" title="Hesap Adı"></span>
                    <span id="ekstre-hesap-tipi" class="block text-sm text-gray-500 mt-1"></span>
                    <span id="ekstre-hesap-telefon" class="block text-sm text-gray-600 mt-1"></span>
                    <span id="ekstre-hesap-id" class="text-xs font-mono text-gray-400 block mt-2"></span>
                </div>

                <!-- Bakiye Özeti Kartı -->
                <div class="ekstre-info-card lg:col-span-1">
                    <h4 class="card-title-absolute"><i class="fas fa-balance-scale"></i>Bakiye Özeti</h4>
                    <div id="ekstre-bakiye-ozeti" class="custom-scrollbar pr-2 ekstre-bakiye-ozeti-v2">
                        <!-- Bakiye içeriği JS ile dolacak -->
                    </div>
                </div>

                <!-- Tarih Filtreleme & Pozisyon Kartı -->
                <div class="ekstre-info-card lg:col-span-1">
                    <h4 class="card-title-absolute"><i class="fas fa-calendar-alt"></i>Tarih Aralığı</h4>
                    <div class="flex items-stretch">
                        <input type="date" id="ekstre-baslangic-tarihi" class="block w-full px-3 py-2 bg-white border border-gray-300 rounded-l-md shadow-sm text-sm h-[38px] border-r-0">
                        <input type="date" id="ekstre-bitis-tarihi" class="block w-full px-3 py-2 bg-white border border-gray-300 shadow-sm text-sm h-[38px] rounded-none">
                        <button id="ekstre-getir-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-r-md text-sm h-[38px] border border-blue-600 flex items-center justify-center">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div class="mt-3 text-center w-full border-t pt-3">
                        <span id="ekstre-has-pozisyon" class="text-base font-semibold"></span>
                    </div>
                </div>
            </div>

            <div id="ekstre-content" class="p-4 overflow-y-auto bg-white rounded-b-lg">
                <!-- Ekstre içeriği JS ile dolacak -->
            </div>
        </div>
    </div>
    <div id="fis-list-modal" class="hidden fixed inset-0 z-50 flex justify-end">
        <div class="modal-bg absolute inset-0"></div>
        <div class="modal-content bg-white w-full max-w-4xl h-full flex flex-col shadow-2xl relative">
            <div class="flex justify-between items-center p-4 border-b sticky top-0 bg-white z-10">
                <h3 id="fis-list-modal-title" class="text-lg font-bold text-gray-800"></h3>
                <button id="fis-list-modal-close-button" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </div>

            <div id="fis-list-filters" class="p-3 border-b bg-gray-50 flex flex-wrap gap-3 items-end">
                <div class="flex-grow min-w-[250px]">
                    <label for="fis-list-customer-filter" class="text-xs font-semibold text-gray-600">Hesap Filtresi</label>
                    <select id="fis-list-customer-filter"></select>
                </div>
                <div>
                    <label for="fis-list-start-date" class="text-xs font-semibold text-gray-600">Başlangıç Tarihi</label>
                    <input type="date" id="fis-list-start-date" class="block w-full px-3 py-1.5 bg-white border border-gray-300 rounded-md shadow-sm text-sm h-[38px]">
                </div>
                <div>
                    <label for="fis-list-end-date" class="text-xs font-semibold text-gray-600">Bitiş Tarihi</label>
                    <input type="date" id="fis-list-end-date" class="block w-full px-3 py-1.5 bg-white border border-gray-300 rounded-md shadow-sm text-sm h-[38px]">
                </div>
                <div>
                    <button id="fis-list-filter-button" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-md text-sm h-[38px]">
                        <i class="fas fa-filter mr-1.5"></i>Filtrele
                    </button>
                </div>
            </div>

            <div id="fis-list-content" class="flex-grow overflow-y-auto">
            </div>
        </div>
    </div>
</body>
</html>

<script>
    document.addEventListener("DOMContentLoaded", () => {

      // =======================
      // EKSTRE MODAL + TARİHLER
      // =======================
      const openBtn  = document.getElementById("ekstre-button");
      const modal    = document.getElementById("ekstre-modal");
      const closeBtn = document.getElementById("ekstre-modal-close-button");
      const ekstreBaslangic = document.getElementById('ekstre-baslangic-tarihi');
      const ekstreBitis = document.getElementById('ekstre-bitis-tarihi');
      const fisTarihiInput = document.getElementById('fis-tarihi');

      const toLocalISOString = (date) => {
        const tzoffset = (new Date()).getTimezoneOffset() * 60000;
        const localISOTime = (new Date(date - tzoffset)).toISOString().slice(0, -1);
        return localISOTime.substring(0, 16);
      };

      const getLocalDateString = (date) => {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
      };

      if (fisTarihiInput) fisTarihiInput.value = toLocalISOString(new Date());

      const today = new Date();
      const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
      if (ekstreBitis) ekstreBitis.value = getLocalDateString(today);
      if (ekstreBaslangic) ekstreBaslangic.value = getLocalDateString(firstDayOfMonth);

      if (openBtn && modal) {
        function openModal() { modal.classList.remove("hidden"); }
        function closeModal() { modal.classList.add("hidden"); }

        openBtn.addEventListener("click", openModal);
        closeBtn?.addEventListener("click", closeModal);

        modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && !modal.classList.contains("hidden")) closeModal();
        });
      }

      // =======================
      // SATIŞ/CARİ TOGGLE -> KUR SELECT GİZLE
      // =======================
      const currencySelect = document.getElementById("currency-select");
      const opToggle = document.getElementById("operation-type-toggle");

      if (currencySelect && opToggle) {
        function updateCurrencyVisibility() {
          const isCari = opToggle.checked;
          currencySelect.classList.toggle("hidden", isCari);
        }
        updateCurrencyVisibility();
        opToggle.addEventListener("change", updateCurrencyVisibility);
      }

      // =======================
      // SLIMSELECT (DOMContentLoaded içinde)
      // =======================
      try {
        if (document.querySelector('#customer-select')) {
          new SlimSelect({
            select: '#customer-select',
            settings: {
              placeholderText: 'Hesap Seçiniz...',
              searchPlaceholder: 'Hesap Ara...',
              allowDeselect: true
            }
          });
        }

        if (document.querySelector('#salesperson-select')) {
          new SlimSelect({
            select: '#salesperson-select',
            settings: {
              placeholderText: 'Tezgahtar Seç',
              searchPlaceholder: 'Ara',
              allowDeselect: true
            }
          });
        }
      } catch (e) {
        console.warn("SlimSelect init error:", e);
      }

      // init sonrası width fix
      setTimeout(() => {
        const c = document.querySelector('.app-shell-customer .ss-main');
        if (c) c.style.width = '100%';

        const s = document.querySelector('.salesperson-wrap .ss-main');
        if (s) s.style.width = '100%';
      }, 0);


      // =======================
      // ANA APP (IIFE)
      // =======================
      (() => {
        // ---------- STATE ----------
        const state = {
          receiptItems: [],
          pendingSwitchToCari: false,
          suppressToggle: false,
          currentCashOperation: "GIRIS",
          isEditing: false,
          editingIndex: null
        };

        // ---------- HELPERS ----------
        const fmt2 = new Intl.NumberFormat("tr-TR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const fmt4 = new Intl.NumberFormat("tr-TR", { minimumFractionDigits: 4, maximumFractionDigits: 4 });

        function sanitizeNumericText(raw) {
          let s = (raw ?? "").toString().trim().replace(/[^\d,.\-]/g, "");
          s = s.replace(/(?!^)-/g, "");
          s = s.replace(/\./g, "");
          const firstComma = s.indexOf(",");
          if (firstComma !== -1) {
            s = s.slice(0, firstComma + 1) + s.slice(firstComma + 1).replace(/,/g, "");
          }
          return s;
        }

        function parseTrNumber(raw) {
          const s = sanitizeNumericText(raw);
          if (!s || s === "-" || s === ",") return 0;
          const normalized = s.replace(",", ".");
          const n = Number.parseFloat(normalized);
          return Number.isFinite(n) ? n : 0;
        }

        function textToTryNumber(text) {
          return parseTrNumber(String(text || "").replace("TRY", "").trim());
        }

        function el(id) { return document.getElementById(id); }

        // ---------- UI ELEMENTS ----------
        const toggle = el("operation-type-toggle");
        const receiptTitle = el("receipt-title");
        const receiptLog = el("receipt-log");
        const girenToplamEl = el("giren-toplam");
        const cikanToplamEl = el("cikan-toplam");
        const farkToplamEl  = el("fark-toplam");

        const lblNakitTahsilat = el("label-nakit-tahsilat");
        const lblNakitOdeme    = el("label-nakit-odeme");
        const lblUrunAlis      = el("label-urun-alis");
        const lblUrunSatis     = el("label-urun-satis");
        const btnSatisListesi  = el("sales-list-button");

        const confirmModal  = el("confirmation-modal");
        const modalMessage  = el("modal-message");
        const modalCancel   = el("modal-cancel");
        const modalConfirm  = el("modal-confirm");

            const fisListModal = el("fis-list-modal");
    const fisListModalClose = el("fis-list-modal-close-button");
    const fisListModalBg = fisListModal?.querySelector(".modal-bg");

        // Nakit modal
        const nakitModal = el("nakit-tahsilat-modal");
        const btnNakitTahsilat = el("btn-nakit-tahsilat");
        const btnNakitOdeme = el("btn-nakit-odeme");
        const nakitClose = el("nakit-tahsilat-close");
        const nakitCancel = el("nt-cancel");
        const nakitSubmit = el("nt-submit");

        const ntTutar = el("nt-tutar");
        const ntKur = el("nt-kur");
        const ntKarsilik = el("nt-karsilik");
        const ntBirim = el("nt-birim");

        // Tabs
        const ntTabs = nakitModal ? Array.from(nakitModal.querySelectorAll(".nt-tab")) : [];
        const ntPanels = nakitModal ? {
          kasalar:  nakitModal.querySelector("#nt-tab-kasalar"),
          bankalar: nakitModal.querySelector("#nt-tab-bankalar"),
          poslar:   nakitModal.querySelector("#nt-tab-poslar"),
        } : {};

        // ---------- MODE ----------
        function setButtonLabels(isCari) {
          if (lblNakitTahsilat) lblNakitTahsilat.textContent = isCari ? "Nakit Giriş" : "Nakit Tahsilat";
          if (lblNakitOdeme)    lblNakitOdeme.textContent    = isCari ? "Nakit Çıkış" : "Nakit Ödeme";
          if (lblUrunAlis)      lblUrunAlis.textContent      = isCari ? "Ürün Giriş"  : "Ürün Alış";
          if (lblUrunSatis)     lblUrunSatis.textContent     = isCari ? "Ürün Çıkış"  : "Ürün Satış";
          if (btnSatisListesi)  btnSatisListesi.textContent  = isCari ? "Cari Listesi" : "Satış Listesi";
        }

        function applyMode(isCari) {
          document.body.classList.toggle("cari-active", isCari);
          document.body.classList.toggle("satis-active", !isCari);

          if (receiptTitle) receiptTitle.textContent = isCari ? "Cari Fişi" : "Satış Fişi";
          setButtonLabels(isCari);
        }

        function hasReceiptData() {
          return state.receiptItems.length > 0;
        }

        function readTotals() {
          const giren = textToTryNumber(girenToplamEl?.textContent);
          const cikan = textToTryNumber(cikanToplamEl?.textContent);
          return { giren, cikan };
        }
            function wireFisListModal() {
      if (!btnSatisListesi || !fisListModal) return;

      const open = () => fisListModal.classList.remove("hidden");
      const close = () => fisListModal.classList.add("hidden");

      // buton -> aç
      btnSatisListesi.addEventListener("click", open);

      // X -> kapa
      fisListModalClose?.addEventListener("click", close);

      // arkaplana tıkla -> kapa (en doğru yer burası)
      fisListModalBg?.addEventListener("click", close);

      // ESC -> kapa
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && !fisListModal.classList.contains("hidden")) close();
      });
    }


        function writeTotals(giren, cikan) {
          const fark = giren - cikan;
          if (girenToplamEl) girenToplamEl.textContent = `${fmt2.format(giren)} TRY`;
          if (cikanToplamEl) cikanToplamEl.textContent = `${fmt2.format(cikan)} TRY`;
          if (farkToplamEl)  farkToplamEl.textContent  = `${fmt2.format(fark)} TRY`;
        }

        function clearReceipt() {
          state.receiptItems = [];
          if (receiptLog) receiptLog.innerHTML = "";
          writeTotals(0, 0);
        }

        // ---------- CONFIRM MODAL ----------
        function showConfirmationModal(message, onConfirm, onCancel) {
          if (!confirmModal) return;
          if (modalMessage) modalMessage.textContent = message;

          const cancelClone = modalCancel?.cloneNode(true);
          const confirmClone = modalConfirm?.cloneNode(true);

          if (modalCancel && cancelClone) modalCancel.parentNode.replaceChild(cancelClone, modalCancel);
          if (modalConfirm && confirmClone) modalConfirm.parentNode.replaceChild(confirmClone, modalConfirm);

          const cBtn = el("modal-cancel");
          const okBtn = el("modal-confirm");

          cBtn?.addEventListener("click", () => {
            confirmModal.classList.add("hidden");
            onCancel?.();
          });

          okBtn?.addEventListener("click", () => {
            confirmModal.classList.add("hidden");
            onConfirm?.();
          });

          confirmModal.addEventListener("click", (e) => {
            if (e.target === confirmModal) {
              confirmModal.classList.add("hidden");
              onCancel?.();
            }
          }, { once: true });

          confirmModal.classList.remove("hidden");
        }

        // ---------- TOGGLE HANDLER ----------
        function wireToggle() {
          if (!toggle) return;

          applyMode(toggle.checked);

          toggle.addEventListener("change", (e) => {
            if (state.suppressToggle) return;

            const wantCari = e.target.checked;
            const currentlySales = !document.body.classList.contains("cari-active");

            if (currentlySales && wantCari && hasReceiptData()) {
              showConfirmationModal(
                "Yapılan işlemler kaybolacak. Devam etmek istiyor musunuz?",
                () => {
                  clearReceipt();
                  applyMode(true);
                  state.suppressToggle = true;
                  toggle.checked = true;
                  state.suppressToggle = false;
                },
                () => {
                  state.suppressToggle = true;
                  toggle.checked = false;
                  state.suppressToggle = false;
                }
              );
              return;
            }

            applyMode(wantCari);
          });
        }

        // ---------- NAKIT MODAL ----------
        function setActiveTab(name) {
          Object.keys(ntPanels).forEach(k => {
            const p = ntPanels[k];
            if (!p) return;
            p.classList.toggle("hidden", k !== name);
          });

          ntTabs.forEach(t => {
            const isActive = t.dataset.tab === name;
            t.classList.toggle("bg-white", isActive);
            t.classList.toggle("shadow", isActive);
            t.classList.toggle("text-blue-700", isActive);

            t.classList.toggle("text-gray-600", !isActive);
            t.classList.toggle("bg-transparent", !isActive);
          });
        }

        function openNakitModal(operationType /* GIRIS|CIKIS */) {
          if (!nakitModal) return;

          // ✅ her açılışta Ekle moduna reset
          state.isEditing = false;
          state.editingIndex = null;

          if (nakitSubmit) {
            nakitSubmit.innerHTML = `<i class="fas fa-check mr-2"></i>Ekle`;
          }

          // ✅ title
          const titleEl = nakitModal.querySelector("h3");
          if (titleEl) titleEl.textContent = operationType === "GIRIS" ? "Nakit Tahsilat" : "Nakit Ödeme";

          state.currentCashOperation = operationType;

          nakitModal.classList.remove("hidden");
          setActiveTab("kasalar");
          updateKarsilikLive();
        }

        function closeNakitModal() {
          nakitModal?.classList.add("hidden");
        }

        function enforceNumericInput(inputEl, decimals) {
          if (!inputEl) return;
          inputEl.addEventListener("input", () => {
            const before = inputEl.value;
            const after = sanitizeNumericText(before);
            if (before !== after) inputEl.value = after;
            updateKarsilikLive();
          });
          inputEl.addEventListener("blur", () => {
            const n = parseTrNumber(inputEl.value);
            inputEl.value = decimals === 2 ? fmt2.format(n) : fmt4.format(n);
            updateKarsilikLive();
          });
        }

        function makeEditableKarsilik() {
          if (!ntKarsilik) return;
          ntKarsilik.setAttribute("contenteditable", "true");
          ntKarsilik.style.outline = "none";

          ntKarsilik.addEventListener("input", () => {
            const before = ntKarsilik.textContent;
            const after = sanitizeNumericText(before);
            if (before !== after) ntKarsilik.textContent = after;
          });

          ntKarsilik.addEventListener("keydown", (e) => {
            if (e.key === "Enter") { e.preventDefault(); ntKarsilik.blur(); }
          });

          ntKarsilik.addEventListener("blur", () => {
            const n = parseTrNumber(ntKarsilik.textContent);
            ntKarsilik.textContent = fmt2.format(n);
          });
        }

        function updateKarsilikLive() {
          if (!ntTutar || !ntKur || !ntKarsilik) return;
          if (document.activeElement === ntKarsilik) return;

          const tutar = parseTrNumber(ntTutar.value);
          const kur = parseTrNumber(ntKur.value);
          ntKarsilik.textContent = fmt2.format(tutar * kur);
        }

        function getActiveTabName() {
          if (!nakitModal) return "kasalar";
          const active = nakitModal.querySelector(".nt-tab.bg-white");
          return active?.dataset?.tab ?? "kasalar";
        }

        function getSelectedAccountName(activeTab) {
          if (activeTab === "bankalar") return el("nt-banka")?.selectedOptions?.[0]?.textContent?.trim() || "BANKA";
          if (activeTab === "poslar")   return el("nt-pos")?.selectedOptions?.[0]?.textContent?.trim() || "POS";
          return el("nt-kasa")?.selectedOptions?.[0]?.textContent?.trim() || "KASA";
        }

        function ensureSection(id, title, colorMode /* green|red */) {
          if (!receiptLog) return null;
          let section = el(id);
          if (section) return section;

          section = document.createElement("div");
          section.id = id;
          section.className = "theme-border-50 rounded-xl overflow-hidden mb-3";

          const borderClass = colorMode === "red" ? "border-red-200 text-red-700" : "border-green-200 text-green-700";

          section.innerHTML = `
            <div class="px-4 py-2 border-b ${borderClass} font-extrabold tracking-widest text-xs">
              ${title}
            </div>
            <div class="p-3 space-y-2" data-items></div>
          `;
          receiptLog.prepend(section);
          return section;
        }

        function getCashRowLabel(itemType /* "GIRIS"|"CIKIS" */) {
          const isCari = document.body.classList.contains("cari-active");
          if (isCari) return itemType === "GIRIS" ? "Nakit Giriş" : "Nakit Çıkış";
          return itemType === "GIRIS" ? "Nakit Tahsilat" : "Nakit Ödeme";
        }

        function addReceiptItemToUI(item) {
          const isGiris = item.type === "GIRIS";
          const section = ensureSection(
            isGiris ? "section-nakit-girisler" : "section-nakit-cikislar",
            isGiris ? "NAKİT GİRİŞLER" : "NAKİT ÇIKIŞLAR",
            isGiris ? "green" : "red"
          );
          if (!section) return;

          const wrap = section.querySelector("[data-items]");
          const row = document.createElement("div");
          row.setAttribute("data-receipt-item", "1");
          row.className = `rounded-lg border ${isGiris ? "border-green-100" : "border-red-100"} bg-white px-3 py-2`;

          const leftTop = `${isGiris ? "+" : "-"}${fmt2.format(item.tutar)} ${item.currency}`;
          const rightTop = `${fmt2.format(item.karsilikTry)} TRY`;
          const leftBottom = `${item.hesapAdi} - ${getCashRowLabel(item.type)}`;
          const rightBottom = `TRY Kuru: ${fmt4.format(item.kur)}`;

          row.innerHTML = `
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="${isGiris ? "text-green-700" : "text-red-700"} font-extrabold text-sm">${leftTop}</div>
                <div class="text-gray-700 font-mono text-xs mt-1 truncate">${leftBottom}</div>
              </div>
              <div class="text-right">
                <div class="${isGiris ? "text-green-700" : "text-red-700"} font-extrabold text-sm">${rightTop}</div>
                <div class="text-gray-500 font-mono text-xs mt-1">${rightBottom}</div>
              </div>
            </div>
          `;

          wrap.appendChild(row);
        }

        function wireNakitModal() {
          if (!nakitModal) return;

          // open
          btnNakitTahsilat?.addEventListener("click", () => openNakitModal("GIRIS"));
          btnNakitOdeme?.addEventListener("click", () => openNakitModal("CIKIS"));

          // close
          nakitClose?.addEventListener("click", closeNakitModal);
          nakitCancel?.addEventListener("click", closeNakitModal);
          nakitModal.addEventListener("click", (e) => { if (e.target === nakitModal) closeNakitModal(); });
          document.addEventListener("keydown", (e) => { if (e.key === "Escape" && !nakitModal.classList.contains("hidden")) closeNakitModal(); });

          // tabs
          ntTabs.forEach(t => t.addEventListener("click", () => setActiveTab(t.dataset.tab)));

          // numeric + karsilik
          enforceNumericInput(ntTutar, 2);
          enforceNumericInput(ntKur, 4);
          makeEditableKarsilik();

          // initial format
          if (ntTutar) ntTutar.value = fmt2.format(parseTrNumber(ntTutar.value));
          if (ntKur) ntKur.value = fmt4.format(parseTrNumber(ntKur.value));
          updateKarsilikLive();

          // submit => add to receipt
          nakitSubmit?.addEventListener("click", () => {
            const activeTab = getActiveTabName();
            const hesapAdi = getSelectedAccountName(activeTab);

            const currency = ntBirim?.selectedOptions?.[0]?.textContent?.trim() || "TRY";
            const tutar = parseTrNumber(ntTutar?.value);
            const kur = parseTrNumber(ntKur?.value);
            const karsilikTry = parseTrNumber(ntKarsilik?.textContent);

            const item = {
              type: state.currentCashOperation,
              currency,
              tutar,
              kur,
              karsilikTry,
              hesapAdi
            };

            state.receiptItems.push(item);
            addReceiptItemToUI(item);

            const { giren, cikan } = readTotals();
            if (item.type === "GIRIS") writeTotals(giren + item.karsilikTry, cikan);
            else writeTotals(giren, cikan + item.karsilikTry);

            closeNakitModal();
          });
        }

        // ---------- INIT ----------
        if (!document.body.classList.contains("satis-active") && !document.body.classList.contains("cari-active")) {
          document.body.classList.add("satis-active");
        }

        wireToggle();
        wireNakitModal();
        wireFisListModal();
        setButtonLabels(toggle?.checked ?? false);


      })();

    });
</script>



<script>
    (() => {
      // ---------- STATE ----------
      const state = {
        receiptItems: [], // { type:"GIRIS"|"CIKIS", currency, tutar, kur, karsilikTry, hesapAdi, tab }
        suppressToggle: false,
        currentCashOperation: "GIRIS",

        // edit state
        isEditing: false,
        editingIndex: null,
      };

      // ---------- HELPERS ----------
      const fmt2 = new Intl.NumberFormat("tr-TR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      const fmt4 = new Intl.NumberFormat("tr-TR", { minimumFractionDigits: 4, maximumFractionDigits: 4 });

      function sanitizeNumericText(raw) {
        let s = (raw ?? "").toString().trim().replace(/[^\d,.\-]/g, "");
        s = s.replace(/(?!^)-/g, "");
        s = s.replace(/\./g, "");
        const firstComma = s.indexOf(",");
        if (firstComma !== -1) {
          s = s.slice(0, firstComma + 1) + s.slice(firstComma + 1).replace(/,/g, "");
        }
        return s;
      }

      function parseTrNumber(raw) {
        const s = sanitizeNumericText(raw);
        if (!s || s === "-" || s === ",") return 0;
        const normalized = s.replace(",", ".");
        const n = Number.parseFloat(normalized);
        return Number.isFinite(n) ? n : 0;
      }

      function textToTryNumber(text) {
        return parseTrNumber(String(text || "").replace("TRY", "").trim());
      }

      function el(id) { return document.getElementById(id); }

      // ---------- UI ELEMENTS ----------
      const toggle = el("operation-type-toggle");
      const receiptTitle = el("receipt-title");
      const receiptLog = el("receipt-log");
      const girenToplamEl = el("giren-toplam");
      const cikanToplamEl = el("cikan-toplam");
      const farkToplamEl  = el("fark-toplam");

      const lblNakitTahsilat = el("label-nakit-tahsilat");
      const lblNakitOdeme    = el("label-nakit-odeme");
      const lblUrunAlis      = el("label-urun-alis");
      const lblUrunSatis     = el("label-urun-satis");
      const btnSatisListesi  = el("sales-list-button");

      const confirmModal  = el("confirmation-modal");
      const modalMessage  = el("modal-message");
      const modalCancel   = el("modal-cancel");
      const modalConfirm  = el("modal-confirm");

      // Nakit modal
      const nakitModal = el("nakit-tahsilat-modal");
      const btnNakitTahsilat = el("btn-nakit-tahsilat");
      const btnNakitOdeme = el("btn-nakit-odeme");
      const nakitModalTitle = el("nakit-modal-title");

      const nakitClose = el("nakit-tahsilat-close");
      const nakitCancel = el("nt-cancel");
      const nakitSubmit = el("nt-submit");
      const nakitDelete = el("nt-delete"); // YENI

      const ntTutar = el("nt-tutar");
      const ntKur = el("nt-kur");
      const ntKarsilik = el("nt-karsilik");
      const ntBirim = el("nt-birim");

      // Tabs
      const ntTabs = nakitModal ? Array.from(nakitModal.querySelectorAll(".nt-tab")) : [];
      const ntPanels = nakitModal ? {
        kasalar:  nakitModal.querySelector("#nt-tab-kasalar"),
        bankalar: nakitModal.querySelector("#nt-tab-bankalar"),
        poslar:   nakitModal.querySelector("#nt-tab-poslar"),
      } : {};

      // ---------- MODE ----------
      function setButtonLabels(isCari) {
        if (lblNakitTahsilat) lblNakitTahsilat.textContent = isCari ? "Nakit Giriş" : "Nakit Tahsilat";
        if (lblNakitOdeme)    lblNakitOdeme.textContent    = isCari ? "Nakit Çıkış" : "Nakit Ödeme";
        if (lblUrunAlis)      lblUrunAlis.textContent      = isCari ? "Ürün Giriş"  : "Ürün Alış";
        if (lblUrunSatis)     lblUrunSatis.textContent     = isCari ? "Ürün Çıkış"  : "Ürün Satış";
        if (btnSatisListesi)  btnSatisListesi.textContent  = isCari ? "Cari Listesi" : "Satış Listesi";
      }

      function applyMode(isCari) {
        document.body.classList.toggle("cari-active", isCari);
        document.body.classList.toggle("satis-active", !isCari);

        if (receiptTitle) receiptTitle.textContent = isCari ? "Cari Fişi" : "Satış Fişi";
        setButtonLabels(isCari);

        // mod değişince edit mod kapansın
        state.isEditing = false;
        state.editingIndex = null;
      }

      function hasReceiptData() {
        return state.receiptItems.length > 0;
      }

      function readTotals() {
        const giren = textToTryNumber(girenToplamEl?.textContent);
        const cikan = textToTryNumber(cikanToplamEl?.textContent);
        return { giren, cikan };
      }

      function writeTotals(giren, cikan) {
        const fark = giren - cikan;
        if (girenToplamEl) girenToplamEl.textContent = `${fmt2.format(giren)} TRY`;
        if (cikanToplamEl) cikanToplamEl.textContent = `${fmt2.format(cikan)} TRY`;
        if (farkToplamEl)  farkToplamEl.textContent  = `${fmt2.format(fark)} TRY`;
      }

      function clearReceipt() {
        state.receiptItems = [];
        if (receiptLog) receiptLog.innerHTML = "";
        writeTotals(0, 0);
      }

      // ---------- CONFIRM MODAL ----------
      function showConfirmationModal(message, onConfirm, onCancel) {
        if (!confirmModal) return;

        if (modalMessage) modalMessage.textContent = message;

        const cancelClone = modalCancel?.cloneNode(true);
        const confirmClone = modalConfirm?.cloneNode(true);

        if (modalCancel && cancelClone) modalCancel.parentNode.replaceChild(cancelClone, modalCancel);
        if (modalConfirm && confirmClone) modalConfirm.parentNode.replaceChild(confirmClone, modalConfirm);

        const cBtn = el("modal-cancel");
        const okBtn = el("modal-confirm");

        cBtn?.addEventListener("click", () => {
          confirmModal.classList.add("hidden");
          onCancel?.();
        });

        okBtn?.addEventListener("click", () => {
          confirmModal.classList.add("hidden");
          onConfirm?.();
        });

        confirmModal.addEventListener("click", (e) => {
          if (e.target === confirmModal) {
            confirmModal.classList.add("hidden");
            onCancel?.();
          }
        }, { once: true });

        confirmModal.classList.remove("hidden");
      }

      // ---------- TOGGLE HANDLER ----------
      function wireToggle() {
        if (!toggle) return;

        applyMode(toggle.checked);

        toggle.addEventListener("change", (e) => {
          if (state.suppressToggle) return;

          const wantCari = e.target.checked;
          const currentlySales = !document.body.classList.contains("cari-active");

          if (currentlySales && wantCari && hasReceiptData()) {
            showConfirmationModal(
              "Yapılan işlemler kaybolacak. Devam etmek istiyor musunuz?",
              () => {
                clearReceipt();
                applyMode(true);
                state.suppressToggle = true;
                toggle.checked = true;
                state.suppressToggle = false;
              },
              () => {
                state.suppressToggle = true;
                toggle.checked = false;
                state.suppressToggle = false;
              }
            );
            return;
          }

          applyMode(wantCari);
          rerenderReceipt(); // mod sonrası UI toparla
        });
      }

      // ---------- NAKIT MODAL ----------
      function setActiveTab(name) {
        Object.keys(ntPanels).forEach(k => {
          const p = ntPanels[k];
          if (!p) return;
          p.classList.toggle("hidden", k !== name);
        });

        ntTabs.forEach(t => {
          const isActive = t.dataset.tab === name;
          t.classList.toggle("bg-white", isActive);
          t.classList.toggle("shadow", isActive);
          t.classList.toggle("text-blue-700", isActive);

          t.classList.toggle("text-gray-600", !isActive);
          t.classList.toggle("bg-transparent", !isActive);
        });
      }

      function enforceNumericInput(inputEl, decimals) {
        if (!inputEl) return;
        inputEl.addEventListener("input", () => {
          const before = inputEl.value;
          const after = sanitizeNumericText(before);
          if (before !== after) inputEl.value = after;
          updateKarsilikLive();
        });
        inputEl.addEventListener("blur", () => {
          const n = parseTrNumber(inputEl.value);
          inputEl.value = decimals === 2 ? fmt2.format(n) : fmt4.format(n);
          updateKarsilikLive();
        });
      }

      function makeEditableKarsilik() {
        if (!ntKarsilik) return;
        ntKarsilik.setAttribute("contenteditable", "true");
        ntKarsilik.style.outline = "none";

        ntKarsilik.addEventListener("input", () => {
          const before = ntKarsilik.textContent;
          const after = sanitizeNumericText(before);
          if (before !== after) ntKarsilik.textContent = after;
        });

        ntKarsilik.addEventListener("keydown", (e) => {
          if (e.key === "Enter") { e.preventDefault(); ntKarsilik.blur(); }
        });

        ntKarsilik.addEventListener("blur", () => {
          const n = parseTrNumber(ntKarsilik.textContent);
          ntKarsilik.textContent = fmt2.format(n);
        });
      }

      function updateKarsilikLive() {
        if (!ntTutar || !ntKur || !ntKarsilik) return;
        if (document.activeElement === ntKarsilik) return;

        const tutar = parseTrNumber(ntTutar.value);
        const kur = parseTrNumber(ntKur.value);
        const res = tutar * kur;
        ntKarsilik.textContent = fmt2.format(res);
      }

      function getActiveTabName() {
        if (!nakitModal) return "kasalar";
        const active = nakitModal.querySelector(".nt-tab.bg-white");
        return active?.dataset?.tab ?? "kasalar";
      }

      function getSelectedAccountName(activeTab) {
        if (activeTab === "bankalar") return el("nt-banka")?.selectedOptions?.[0]?.textContent?.trim() || "";
        if (activeTab === "poslar")   return el("nt-pos")?.selectedOptions?.[0]?.textContent?.trim() || "";
        return el("nt-kasa")?.selectedOptions?.[0]?.textContent?.trim() || "";
      }

      function ensureSection(id, title, colorMode /* green|red */) {
        if (!receiptLog) return null;
        let section = el(id);
        if (section) return section;

        section = document.createElement("div");
        section.id = id;
        section.className = "theme-border-50 rounded-xl overflow-hidden mb-3";

        const borderClass = colorMode === "red" ? "border-red-200 text-red-700" : "border-green-200 text-green-700";

        section.innerHTML = `
          <div class="px-4 py-2 border-b ${borderClass} font-extrabold tracking-widest text-xs">
            ${title}
          </div>
          <div class="p-3 space-y-2" data-items></div>
        `;
        receiptLog.prepend(section);
        return section;
      }

      function getCashRowLabel(itemType) {
        const isCari = document.body.classList.contains("cari-active");
        if (isCari) return itemType === "GIRIS" ? "Nakit Giriş" : "Nakit Çıkış";
        return itemType === "GIRIS" ? "Nakit Tahsilat" : "Nakit Ödeme";
      }

      function closeNakitModal() {
        nakitModal?.classList.add("hidden");
      }

      function setModalModeUI(operationType) {
        // Title
        const titleEl = nakitModalTitle || nakitModal?.querySelector("h3");
        if (titleEl) titleEl.textContent = (operationType === "GIRIS") ? "Nakit Tahsilat" : "Nakit Ödeme";

        // Buttons
        if (state.isEditing) {
          if (nakitSubmit) nakitSubmit.innerHTML = `<i class="fas fa-save mr-2"></i>Güncelle`;
          nakitDelete?.classList.remove("hidden");
        } else {
          if (nakitSubmit) nakitSubmit.innerHTML = `<i class="fas fa-check mr-2"></i>Ekle`;
          nakitDelete?.classList.add("hidden");
        }
      }

      function openNakitModal(operationType /* GIRIS|CIKIS */) {
        if (!nakitModal) return;

        state.currentCashOperation = operationType;

        // open normal mode
        state.isEditing = false;
        state.editingIndex = null;

        nakitModal.classList.remove("hidden");
        setActiveTab("kasalar");
        setModalModeUI(operationType);
        updateKarsilikLive();
      }

      // Edit için modal aç
      function openNakitModalForEdit(index) {
        const item = state.receiptItems[index];
        if (!item || !nakitModal) return;

        state.isEditing = true;
        state.editingIndex = index;
        state.currentCashOperation = item.type;

        // tab
        setActiveTab(item.tab || "kasalar");

        // birim seç (text'e göre)
        if (ntBirim) {
          const wanted = (item.currency || "TRY").trim();
          const opt = Array.from(ntBirim.options).find(o => (o.textContent || "").trim() === wanted);
          if (opt) ntBirim.value = opt.value;
        }

        // inputları doldur
        if (ntTutar) ntTutar.value = fmt2.format(item.tutar ?? 0);
        if (ntKur) ntKur.value = fmt4.format(item.kur ?? 0);
        if (ntKarsilik) ntKarsilik.textContent = fmt2.format(item.karsilikTry ?? 0);

        // ilgili hesabı seçmeye çalış (tab'a göre)
        const tab = item.tab || "kasalar";
        const selectId = tab === "bankalar" ? "nt-banka" : (tab === "poslar" ? "nt-pos" : "nt-kasa");
        const sel = el(selectId);
        if (sel && item.hesapAdi) {
          const opt = Array.from(sel.options).find(o => (o.textContent || "").trim() === item.hesapAdi.trim());
          if (opt) sel.value = opt.value;
        }

        nakitModal.classList.remove("hidden");
        setModalModeUI(item.type);
      }

      // ---------- RENDER / RERENDER ----------
      function rerenderReceipt() {
        if (!receiptLog) return;
        receiptLog.innerHTML = "";

        let giren = 0;
        let cikan = 0;

        state.receiptItems.forEach((item, index) => {
          addReceiptItemToUI(item, index);

          if (item.type === "GIRIS") giren += (item.karsilikTry || 0);
          else cikan += (item.karsilikTry || 0);
        });

        writeTotals(giren, cikan);
      }

      function addReceiptItemToUI(item, index) {
        const isGiris = item.type === "GIRIS";

        const section = ensureSection(
          isGiris ? "section-nakit-girisler" : "section-nakit-cikislar",
          isGiris ? "NAKİT GİRİŞLER" : "NAKİT ÇIKIŞLAR",
          isGiris ? "green" : "red"
        );
        if (!section) return;

        const wrap = section.querySelector("[data-items]");
        const row = document.createElement("div");
        row.setAttribute("data-receipt-item", "1");
        row.dataset.index = index;
        row.style.cursor = "pointer";
        row.className = `rounded-lg border ${isGiris ? "border-green-100" : "border-red-100"} bg-white px-3 py-2`;

        const leftTop = `${isGiris ? "+" : "-"}${fmt2.format(item.tutar)} ${item.currency}`;
        const rightTop = `${fmt2.format(item.karsilikTry)} TRY`;
        const leftBottom = `${item.hesapAdi} - ${getCashRowLabel(item.type)}`;
        const rightBottom = `TRY Kuru: ${fmt4.format(item.kur)}`;

        row.innerHTML = `
          <div class="flex items-start justify-between gap-3">
            <div class="min-w-0">
              <div class="${isGiris ? "text-green-700" : "text-red-700"} font-extrabold text-sm">${leftTop}</div>
              <div class="text-gray-700 font-mono text-xs mt-1 truncate">${leftBottom}</div>
            </div>
            <div class="text-right">
              <div class="${isGiris ? "text-green-700" : "text-red-700"} font-extrabold text-sm">${rightTop}</div>
              <div class="text-gray-500 font-mono text-xs mt-1">${rightBottom}</div>
            </div>
          </div>
        `;

        row.addEventListener("click", () => openNakitModalForEdit(index));
        wrap.appendChild(row);
      }

      // ---------- SUBMIT / UPDATE / DELETE ----------
      function readItemFromModal() {
        const tab = getActiveTabName();
        const hesapAdi = getSelectedAccountName(tab);

        const currency = ntBirim?.selectedOptions?.[0]?.textContent?.trim() || "TRY";
        const tutar = parseTrNumber(ntTutar?.value);
        const kur = parseTrNumber(ntKur?.value);
        const karsilikTry = parseTrNumber(ntKarsilik?.textContent);

        return {
          type: state.currentCashOperation,
          currency,
          tutar,
          kur,
          karsilikTry,
          hesapAdi,
          tab
        };
      }

      function validateItem(item) {
        // çok sıkı değil ama boş hesap adı gelmesin
        if (!item.hesapAdi) return false;
        return true;
      }

      // ---------- WIRE MODAL ----------
      function wireNakitModal() {
        if (!nakitModal) return;

        // open buttons
        btnNakitTahsilat?.addEventListener("click", () => openNakitModal("GIRIS"));
        btnNakitOdeme?.addEventListener("click", () => openNakitModal("CIKIS"));

        // close
        nakitClose?.addEventListener("click", closeNakitModal);
        nakitCancel?.addEventListener("click", () => {
          closeNakitModal();
          state.isEditing = false;
          state.editingIndex = null;
        });

        nakitModal.addEventListener("click", (e) => { if (e.target === nakitModal) closeNakitModal(); });
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && !nakitModal.classList.contains("hidden")) closeNakitModal();
        });

        // tabs
        ntTabs.forEach(t => t.addEventListener("click", () => setActiveTab(t.dataset.tab)));

        // numeric inputs + karsilik
        enforceNumericInput(ntTutar, 2);
        enforceNumericInput(ntKur, 4);
        makeEditableKarsilik();

        // initial format
        if (ntTutar) ntTutar.value = fmt2.format(parseTrNumber(ntTutar.value));
        if (ntKur) ntKur.value = fmt4.format(parseTrNumber(ntKur.value));
        updateKarsilikLive();

        // submit => add or update
        nakitSubmit?.addEventListener("click", () => {
          const item = readItemFromModal();
          if (!validateItem(item)) return;

          // EDIT
          if (state.isEditing && state.editingIndex !== null) {
            state.receiptItems[state.editingIndex] = item;
            state.isEditing = false;
            state.editingIndex = null;

            rerenderReceipt();
            closeNakitModal();
            return;
          }

          // ADD
          state.receiptItems.push(item);
          rerenderReceipt();
          closeNakitModal();
        });

        // delete
        nakitDelete?.addEventListener("click", () => {
          if (!state.isEditing || state.editingIndex === null) return;

          const idx = state.editingIndex;
          state.receiptItems.splice(idx, 1);

          state.isEditing = false;
          state.editingIndex = null;

          rerenderReceipt();
          closeNakitModal();
        });
      }

      // ---------- INIT ----------
      document.addEventListener("DOMContentLoaded", () => {
        if (!document.body.classList.contains("satis-active") && !document.body.classList.contains("cari-active")) {
          document.body.classList.add("satis-active");
        }

        wireToggle();
        wireNakitModal();
        setButtonLabels(toggle?.checked ?? false);
        rerenderReceipt();
        wireFisListModal();
      });
    })();
</script>








